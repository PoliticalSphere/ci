# ==============================================================================
# Political Sphere â€” Allowed GitHub Actions (Default Deny)
# ------------------------------------------------------------------------------
# Purpose:
#   Supply-chain control: define the only GitHub Actions repositories that may
#   be referenced by workflows (default deny).
#
# Non-negotiable rules:
#   - DEFAULT DENY: any external action not allowlisted here is forbidden.
#   - FULL-LENGTH COMMIT SHA REQUIRED for external actions (40-hex).
#   - Tags and branches are forbidden (even for allowlisted actions).
#   - Adding or removing allowlisted actions requires a documented risk decision.
#
# Scope:
#   - This allowlists action publishers/repos (owner/name) only.
#   - Pinning and ref format are validated separately (and must always pass).
#   - Local actions may be allowed by policy (see allow_local_actions).
#
# Governance:
#   - Entries MUST be unique by `repo`.
#   - Changes MUST reference a risk decision (see risk_decisions_file).
#   - Review cadence enforced via last_reviewed + review_interval_days.
# ==============================================================================

meta:
  version: 1.2.0
  owner: political-sphere
  classification: internal
  last_reviewed: 2025-12-19
  review_interval_days: 180

policy:
  default: deny

  pinning:
    require_full_length_sha: true
    forbid_tags: true
    forbid_branches: true
    required_ref_regex: '^[A-Za-z0-9_.-]+\/[A-Za-z0-9_.-]+@[a-f0-9]{40}$'

  change_control:
    require_risk_decision_for_changes: true
    risk_decisions_file: docs/risk-decisions.md

  local_actions:
    enabled: true
    require_relative_prefix: "./"
    forbid_parent_traversal: true
    required_path_regex: '^\.\/(?!.*\.\.\/).+'

allowlist:
  # ---------------------------------------------------------------------------
  # GitHub-maintained actions (core CI primitives)
  # ---------------------------------------------------------------------------
  - repo: actions/checkout
    category: github-maintained
    purpose: Checkout repository code
    notes: Prefer minimal fetch-depth unless explicitly required

  - repo: actions/cache
    category: github-maintained
    purpose: Dependency and build caching

  - repo: actions/setup-node
    category: github-maintained
    purpose: Install and configure Node.js runtime

  - repo: actions/upload-artifact
    category: github-maintained
    purpose: Upload build logs, reports, and scan artifacts

  - repo: actions/download-artifact
    category: github-maintained
    purpose: Retrieve artifacts across jobs/workflows

  - repo: actions/dependency-review-action
    category: github-maintained
    purpose: Dependency review for PRs

  - repo: github/codeql-action
    category: github-maintained
    purpose: CodeQL analysis and SARIF reporting
    notes: Use least privilege; upload SARIF only where required

  # ---------------------------------------------------------------------------
  # CI security hardening
  # ---------------------------------------------------------------------------
  - repo: step-security/harden-runner
    category: security-hardening
    purpose: Runner hardening and egress control
    notes: Prefer restrictive egress policies in security workflows

  # ---------------------------------------------------------------------------
  # Vetted community actions (allowed, but still pinned and governed)
  # ---------------------------------------------------------------------------
  - repo: ossf/scorecard-action
    category: supply-chain
    purpose: OpenSSF Scorecard supply-chain posture scanning

  - repo: trufflesecurity/trufflehog
    category: secrets
    purpose: Secrets scanning (scheduled deep scan)
    notes: Use scheduled scans only; output SARIF to artifacts


validation_notes:
  # Repo format is always "owner/name" with no "@ref" portion.
  repo_format: owner/name

  # Validator expectations:
  # - External uses must match: owner/name@<40-hex-sha>
  # - owner/name must appear in allowlist.repo
  # - Tags/branches are forbidden by policy regardless of allowlist
  # - Local uses must start with "./" (if enabled) and must not traverse parent dirs
  validator_requirements:
    - ensure_allowlisted_repo_for_external_actions
    - ensure_full_length_sha_for_external_actions
    - forbid_tags_and_branches_for_external_actions
    - enforce_local_action_prefix_and_no_traversal
    - enforce_unique_allowlist_entries
