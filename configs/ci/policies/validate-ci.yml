# ==============================================================================
# Political Sphere â€” Validate-CI Rules
# ------------------------------------------------------------------------------
# Purpose:
#   Machine-readable policy for CI validation. The validate-ci gate reads this
#   file to enforce secure-by-default workflow rules.
#
# Design goals:
#   - Default deny
#   - Least privilege
#   - Supply-chain integrity
#   - AI-governable policy (externalised allowlists/baselines)
#   - Deterministic, audit-ready CI
# ==============================================================================

meta:
  version: 1.1.0
  owner: political-sphere
  classification: internal
  last_reviewed: 2025-12-19
  review_interval_days: 180
  governance_doc: docs/ci-policy-governance.md
  requirements:
    ps_init_platform_allowlist_required: true
    ps_init_platform_allowlist_hint: "Set platform_allowed_repositories to internal CI repos only."

rule_defaults: &rule_defaults
  enabled: true
  mode: enforce

rules:
  sha_pinning:
    <<: *rule_defaults
    config_file: configs/ci/policies/action-pinning.yml
    # Default deny: all third-party actions must be explicitly allowlisted.
    allowlist_file: configs/ci/policies/allowed-actions.yml
    exceptions:
      require_risk_decision: true
      risk_decisions_file: docs/risk-decisions.md

  permissions:
    <<: *rule_defaults
    baseline_file: configs/ci/policies/permissions-baseline.yml
    config_file: configs/ci/policies/permissions-baseline.yml

  triggers_and_context:
    <<: *rule_defaults
    config_file: configs/ci/policies/high-risk-triggers.yml
    allowlist_file: configs/ci/policies/high-risk-triggers.yml

  runner_hardening:
    <<: *rule_defaults
    config_file: configs/ci/policies/harden-runner.yml

  unsafe_patterns:
    <<: *rule_defaults
    patterns_file: configs/ci/policies/unsafe-patterns.yml
    allowlist_file: configs/ci/policies/unsafe-patterns-allowlist.yml

  inline_bash:
    <<: *rule_defaults
    config_file: configs/ci/policies/inline-bash.yml
    allowlist_file: configs/ci/policies/inline-bash.yml

  secrets_handling:
    <<: *rule_defaults
    config_file: configs/ci/policies/secrets-handling.yml

  local_actions:
    <<: *rule_defaults
    config_file: configs/ci/policies/local-actions.yml

  outputs_and_artifacts:
    <<: *rule_defaults
    config_file: configs/ci/policies/section-headers.yml
    artifact_policy_file: configs/ci/policies/artifact-policy.yml

  remote_sha_verify:
    <<: *rule_defaults
    config_file: configs/ci/policies/remote-sha-verify.yml

rule_groups:
  supply_chain:
    description: Action allowlisting, pinning, and verification guardrails.
    contains:
      - sha_pinning
      - remote_sha_verify
      - local_actions
  scripting:
    description: Shared guardrails for inline scripts, unsafe patterns, and secrets hygiene.
    contains:
      - inline_bash
      - unsafe_patterns
      - secrets_handling
  artifacts:
    description: Controls artifacts/exported data expectations.
    contains:
      - outputs_and_artifacts

enforcement:
  fail_on_violation: true
  require_risk_decision_for_exceptions: true
  risk_decisions_file: docs/risk-decisions.md
  report_format:
    console: true
    json: true
    sarif: false
