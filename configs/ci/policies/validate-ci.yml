# ==============================================================================
# Political Sphere â€” Validate-CI Rules
# ------------------------------------------------------------------------------
# Purpose:
#   Machine-readable policy for CI validation. The validate-ci gate reads this
#   file to enforce secure-by-default workflow rules.
#
# Design goals:
#   - Default deny
#   - Least privilege
#   - Supply-chain integrity
#   - AI-governable policy (externalised allowlists/baselines)
#   - Deterministic, audit-ready CI
# ==============================================================================

meta:
  version: 1.1.0
  owner: political-sphere
  classification: internal
  last_reviewed: 2025-12-19
  review_interval_days: 180

rules:
  sha_pinning:
    enabled: true
    mode: enforce
    require_full_length: true
    disallow_tags: true
    disallow_branches: true
    # Default deny: all third-party actions must be explicitly allowlisted.
    allowlist_file: configs/ci/exceptions/actions-allowlist.yml
    exceptions:
      require_risk_decision: true
      risk_decisions_file: docs/risk-decisions.md

  permissions:
    enabled: true
    mode: enforce
    require_workflow_permissions: true
    require_job_permissions: true
    baseline_file: configs/ci/policies/permissions-baseline.yml
    require_inline_justification_on_elevation: true
    forbid_write_permissions_on_pr_from_fork: true

  triggers_and_context:
    enabled: true
    mode: enforce
    # Explicitly block high-risk triggers unless allowlisted.
    disallow_by_default:
      - pull_request_target
      - repository_dispatch
      - workflow_run
      - issue_comment
    allowlist_file: configs/ci/exceptions/high-risk-triggers-allowlist.yml
    require_safe_checkout_ref: true

  runner_hardening:
    enabled: true
    mode: enforce
    require_harden_runner: true
    allowed_first_steps:
      - ./.github/actions/ps-harden-runner
      - ./.github/actions/ps-setup
      - ./.github/actions/ps-hardened-checkout
      - step-security/harden-runner@
    harden_runner_action_allowlist:
      - step-security/harden-runner
      - ./.github/actions/ps-harden-runner
    require_egress_policy_when_supported: true

  unsafe_patterns:
    enabled: true
    mode: enforce
    patterns_file: configs/ci/policies/unsafe-patterns.yml

  inline_bash:
    enabled: true
    mode: enforce
    prefer_composite_actions: true
    max_inline_lines: 15
    allowlist_file: configs/ci/exceptions/inline-bash-allowlist.yml
    require_set_euo_pipefail_in_scripts: true

  secrets_handling:
    enabled: true
    mode: enforce
    forbid_plaintext_secrets: true
    forbid_echo_secrets: true
    forbid_debug_xtrace_with_secrets: true
    require_no_secrets_in_artifacts: true

  outputs_and_artifacts:
    enabled: true
    mode: enforce
    require_section_headers: true
    artifact_policy_file: configs/ci/policies/artifact-policy.yml
    require_sarif_upload_when_available: true

enforcement:
  fail_on_violation: true
  require_risk_decision_for_exceptions: true
  risk_decisions_file: docs/risk-decisions.md
  report_format:
    console: true
    json: true
    sarif: false
