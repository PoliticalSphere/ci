#!/usr/bin/env node

/**
 * ==============================================================================
 * Political Sphere â€” Config Manager Test & Usage Examples
 * ==============================================================================
 *
 * Purpose:
 *   Demonstrate and test the unified ConfigManager API.
 *   Can be run as a standalone utility or imported for testing.
 *
 * Usage:
 *   node tools/scripts/core/config-manager.test.js
 *   node tools/scripts/core/config-manager.test.js --policy action-pinning
 *   node tools/scripts/core/config-manager.test.js --validate-all
 *   node tools/scripts/core/config-manager.test.js --dependencies validate-ci
 *
 * ==============================================================================
 */

import path from 'node:path';
import { fileURLToPath } from 'node:url';

import { ConfigManager } from '../scripts/core/config-manager.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Determine repo root (go up from tools/tests to repo root)
const repoRoot = path.resolve(__dirname, '../../');

/**
 * Run example operations
 */
async function main() {
  const args = process.argv.slice(2);
  const manager = new ConfigManager({
    repoRoot,
    platformRoot: repoRoot,
  });

  try {
    // Initialize and discover all policies
    console.log('ğŸ“‹ Initializing ConfigManager...\n');
    manager.initialize();

    // Show statistics
    const stats = manager.getStatistics();
    console.log('Statistics:');
    console.log(`  Total policies registered: ${stats.totalPoliciesRegistered}`);
    console.log(`  Categories: ${stats.categories.join(', ')}`);
    console.log();

    // Handle command-line arguments
    if (args.length === 0) {
      await exampleBasicUsage(manager);
      await exampleListByCategory(manager);
      await exampleValidation(manager);
      await exampleDependencies(manager);
    } else if (args[0] === '--policy' && args[1]) {
      await exampleGetPolicy(manager, args[1]);
    } else if (args[0] === '--validate-all') {
      await exampleValidateAll(manager);
    } else if (args[0] === '--dependencies' && args[1]) {
      await exampleResolveDependencies(manager, args[1]);
    } else if (args[0] === '--missing') {
      await exampleMissingPolicies(manager);
    } else {
      showHelp();
    }
  } catch (err) {
    console.error('âŒ Error:', err.message);
    process.exit(1);
  }
}

/**
 * Example: Basic usage - get a policy
 */
async function exampleBasicUsage(manager) {
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('Example 1: Basic Usage - Load a Policy');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  try {
    const policy = manager.getPolicy('action-pinning');
    if (policy) {
      console.log('âœ“ Successfully loaded action-pinning policy');
      console.log(`  Keys: ${Object.keys(policy).slice(0, 3).join(', ')}...`);
    } else {
      console.log('â„¹ Policy not found or optional and missing');
    }
  } catch (err) {
    console.log(`âœ— Failed to load action-pinning: ${err.message}`);
  }

  console.log();
}

/**
 * Example: List policies by category
 */
async function exampleListByCategory(manager) {
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('Example 2: List Policies by Category');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  const categories = ['ci-governance', 'lint', 'security'];
  for (const category of categories) {
    const policies = manager.listPoliciesByCategory(category);
    console.log(`${category}:`);
    for (const policy of policies) {
      const req = policy.required ? '(required)' : '(optional)';
      console.log(`  - ${policy.name.padEnd(20)} ${req}`);
    }
    console.log();
  }
}

/**
 * Example: Validate a configuration
 */
async function exampleValidation(manager) {
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('Example 3: Validate Configuration');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  try {
    const config = manager.getPolicy('validate-ci');
    if (config) {
      const validation = manager.validateConfig('validate-ci', config);
      console.log(
        `Policy: validate-ci - ${validation.isValid ? 'âœ“ VALID' : 'âœ— INVALID'}`,
      );
      if (validation.errors.length > 0) {
        for (const error of validation.errors) {
          console.log(`  Error: ${error}`);
        }
      }
    }
  } catch (err) {
    console.log(`âœ— Validation failed: ${err.message}`);
  }

  console.log();
}

/**
 * Example: Resolve dependencies
 */
async function exampleDependencies(manager) {
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('Example 4: Resolve Policy Dependencies');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

  try {
    const deps = manager.resolveDependencies('action-pinning');
    console.log('Dependencies for action-pinning:');
    if (deps.length === 0) {
      console.log('  (no dependencies)');
    } else {
      for (const dep of deps) {
        console.log(`  - ${dep}`);
      }
    }
  } catch (err) {
    console.log(`âœ— Failed to resolve dependencies: ${err.message}`);
  }

  console.log();
}

/**
 * Example: Get a specific policy
 */
async function exampleGetPolicy(manager, policyName) {
  console.log(`ğŸ“‹ Loading policy: ${policyName}\n`);

  try {
    const policy = manager.getPolicy(policyName);
    if (!policy) {
      console.log(
        `â„¹ Policy '${policyName}' not found or is optional and missing`,
      );
      return;
    }

    const validation = manager.validateConfig(policyName, policy);
    console.log(`Status: ${validation.isValid ? 'âœ“ VALID' : 'âœ— INVALID'}`);
    console.log(`Type: ${typeof policy}`);
    if (typeof policy === 'object') {
      console.log(`Keys: ${Object.keys(policy).length} items`);
      console.log(`Sample keys: ${Object.keys(policy).slice(0, 5).join(', ')}`);
    }
    if (validation.errors.length > 0) {
      console.log('Validation errors:');
      for (const error of validation.errors) {
        console.log(`  - ${error}`);
      }
    }
  } catch (err) {
    console.error(`âœ— Error: ${err.message}`);
  }
}

/**
 * Example: Validate all policies
 */
async function exampleValidateAll(manager) {
  console.log('ğŸ” Validating all policies...\n');

  const categories = ['ci-governance', 'lint', 'security', 'contracts'];
  let passed = 0;
  let failed = 0;
  let skipped = 0;

  for (const category of categories) {
    const policies = manager.listPoliciesByCategory(category);
    console.log(`${category}:`);

    for (const policyMeta of policies) {
      try {
        const policy = manager.getPolicy(policyMeta.name);
        if (!policy) {
          console.log(`  â—‹ ${policyMeta.name.padEnd(25)} (skipped - not found)`);
          skipped++;
        } else {
          const validation = manager.validateConfig(
            policyMeta.name,
            policy,
          );
          const status = validation.isValid ? 'âœ“' : 'âœ—';
          console.log(`  ${status} ${policyMeta.name.padEnd(25)}`);
          if (validation.isValid) {
            passed++;
          } else {
            failed++;
            for (const err of validation.errors) {
              console.log(`    â†’ ${err}`);
            }
          }
        }
      } catch (err) {
        console.log(
          `  âœ— ${policyMeta.name.padEnd(25)} (error: ${err.message})`,
        );
        failed++;
      }
    }
    console.log();
  }

  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log(`Results: âœ“ ${passed} passed | âœ— ${failed} failed | â—‹ ${skipped} skipped`);
}

/**
 * Example: Resolve dependencies for a policy
 */
async function exampleResolveDependencies(manager, policyName) {
  console.log(`ğŸ“Š Dependency graph for: ${policyName}\n`);

  try {
    const deps = manager.resolveDependencies(policyName);
    if (deps.length === 0) {
      console.log('  No dependencies');
    } else {
      console.log('Direct and transitive dependencies:');
      for (let i = 0; i < deps.length; i++) {
        const isLast = i === deps.length - 1;
        const prefix = isLast ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ';
        console.log(`  ${prefix}${deps[i]}`);
      }
    }
  } catch (err) {
    console.error(`âœ— Error: ${err.message}`);
  }
}

/**
 * Example: Show missing required policies
 */
async function exampleMissingPolicies(manager) {
  console.log('ğŸ” Checking for missing required policies...\n');

  const missing = manager.getMissingRequiredPolicies();
  if (missing.length === 0) {
    console.log('âœ“ All required policies are present');
  } else {
    console.log(`âœ— Found ${missing.length} missing required policies:\n`);
    for (const policy of missing) {
      console.log(`  ${policy.name}`);
      console.log(`    Expected: ${policy.expected}`);
    }
  }
}

/**
 * Show help message
 */
function showHelp() {
  console.log(`
Configuration Manager - Usage Examples

Usage:
  node tools/scripts/core/config-manager.test.js [COMMAND]

Commands:
  (none)              Run all examples
  --policy NAME       Load and validate a specific policy
  --validate-all      Validate all policies
  --dependencies NAME Resolve dependencies for a policy
  --missing           Show missing required policies
  --help              Show this message

Examples:
  node tools/scripts/core/config-manager.test.js --policy action-pinning
  node tools/scripts/core/config-manager.test.js --dependencies validate-ci
  node tools/scripts/core/config-manager.test.js --validate-all
  node tools/scripts/core/config-manager.test.js --missing
  `);
}

// Run if executed directly
if (import.meta.url === `file://${process.argv[1]}`) {
  main().catch((err) => {
    console.error('Fatal error:', err);
    process.exit(1);
  });
}

export { ConfigManager };
