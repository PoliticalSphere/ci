# ==============================================================================
# Political Sphere â€” Composite Action: Node Bootstrap
# ------------------------------------------------------------------------------
# Purpose:
#   Prepare a deterministic Node.js environment with optional dependency install.
#
# Metadata:
#   - Created: 2025-12-20
#   - Last updated: 2025-12-20
#
# Scope & Responsibilities:
#   - Does: setup Node.js and (optionally) run npm ci with platform defaults.
#   - Does NOT: checkout code or run build/test scripts.
#
# Design Principles:
#   - Deterministic dependency installation when enabled
#   - Non-interactive execution
#   - SHA-pinned actions only
#
# Dependencies:
#   - actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
#   - npm (runner-provided)
#   - tools/scripts/branding/validate-inputs.sh
#
# Dependents:
#   - ./.github/actions/ps-node-setup
#
# Execution Model:
#   - Trigger: N/A (invoked by workflow steps)
#   - Type: composite action (internal-only)
#   - Invoked by: ps-node-setup
#
# Security & Policy Notes:
#   - Secrets: optional NODE_AUTH_TOKEN (if provided by caller)
#   - Permissions: inherited from the caller
#   - Constraints: requires package-lock.json for deterministic installs
#
# Operational Notes:
#   - Timeouts: controlled by the calling job
#   - Artifacts: none
#   - Cache: uses explicit cached vs non-cached setup-node steps for clarity
#   - CI vs local: identical behavior
# ==============================================================================

name: "PS Node Bootstrap"
description: "Setup Node.js and optionally run npm ci with platform defaults"

inputs:
  node_version:
    description: "Node.js major version (e.g. 22)"
    required: false
    default: "22"
  cache:
    description: "Enable dependency caching via setup-node (1 = on, 0 = off)"
    required: false
    default: "1"
  install_dependencies:
    description: "Run npm ci (1 = on, 0 = off)"
    required: false
    default: "1"

runs:
  using: "composite"
  steps:
    - name: Resolve platform/workspace roots
      shell: bash
      run: |
        set -euo pipefail

        platform_root="${PS_PLATFORM_ROOT:-}"
        workspace_root="${GITHUB_WORKSPACE:-$(pwd)}"

        if [[ -n "${platform_root}" && -d "${platform_root}" ]]; then
          scripts_root="${platform_root}"
          printf 'PS.NODE_BOOTSTRAP: scripts_root=PS_PLATFORM_ROOT (%s)\n' "${scripts_root}"
        else
          scripts_root="${workspace_root}"
          printf 'PS.NODE_BOOTSTRAP: scripts_root=GITHUB_WORKSPACE (%s)\n' "${scripts_root}"
        fi

        printf 'PS_SCRIPTS_ROOT=%s\n' "${scripts_root}" >> "${GITHUB_ENV}"
        printf 'PS_WORKSPACE_ROOT=%s\n' "${workspace_root}" >> "${GITHUB_ENV}"

    - name: Validate repo state
      shell: bash
      env:
        PS_NODE_VERSION_INPUT: ${{ inputs.node_version }}
        PS_CACHE_INPUT: ${{ inputs.cache }}
        PS_INSTALL_DEP_INPUT: ${{ inputs.install_dependencies }}
      run: |
        set -euo pipefail

        scripts_root="${PS_SCRIPTS_ROOT:?PS_SCRIPTS_ROOT not set}"
        workspace_root="${PS_WORKSPACE_ROOT:?PS_WORKSPACE_ROOT not set}"

        validate_sh="${scripts_root}/tools/scripts/branding/validate-inputs.sh"
        if [[ ! -f "${validate_sh}" ]]; then
          printf 'ERROR: validate-inputs.sh not found at %s\n' "${validate_sh}" >&2
          echo "HINT: ensure PS_PLATFORM_ROOT points at the platform checkout, or vendor scripts into the repo." >&2
          exit 1
        fi
        # shellcheck source=/dev/null
        . "${validate_sh}"

        # Validate inputs early
        if ! require_number "inputs.node_version" "${PS_NODE_VERSION_INPUT}"; then
          printf "ERROR: inputs.node_version must be a number (major version). Got '%s'.\n" "${PS_NODE_VERSION_INPUT}" >&2
          exit 1
        fi
        require_enum "inputs.cache" "${PS_CACHE_INPUT}" "1" "0" || exit 1
        require_enum "inputs.install_dependencies" "${PS_INSTALL_DEP_INPUT}" "1" "0" || exit 1

        if [[ "${PS_INSTALL_DEP_INPUT}" == "1" ]]; then
          if [[ ! -f "${workspace_root}/package.json" ]]; then
            printf 'ERROR: package.json not found at %s\n' "${workspace_root}/package.json" >&2
            printf 'HINT: ensure actions/checkout ran and the repo root is the workspace.\n' >&2
            exit 1
          fi

          if [[ ! -f "${workspace_root}/package-lock.json" ]]; then
            printf 'ERROR: package-lock.json not found (npm ci requires a lockfile for determinism).\n' >&2
            printf 'HINT: commit package-lock.json or set install_dependencies=0 (and handle installs elsewhere).\n' >&2
            exit 1
          fi
        fi

        # Persist validated node version for downstream steps
        printf 'PS_NODE_VERSION_VALIDATED=%s\n' "${PS_NODE_VERSION_INPUT}" >> "${GITHUB_ENV}"

        printf 'PS.NODE_BOOTSTRAP: node_version=%q\n' "$PS_NODE_VERSION_INPUT"
        printf 'PS.NODE_BOOTSTRAP: cache=%q\n' "$PS_CACHE_INPUT"
        printf 'PS.NODE_BOOTSTRAP: install_dependencies=%q\n' "$PS_INSTALL_DEP_INPUT"

    - name: Setup Node (cached)
      if: ${{ inputs.cache == '1' }}
      uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
      with:
        node-version: ${{ env.PS_NODE_VERSION_VALIDATED }}
        cache: npm

    - name: Setup Node (no cache)
      if: ${{ inputs.cache != '1' }}
      uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
      with:
        node-version: ${{ env.PS_NODE_VERSION_VALIDATED }}

    - name: Install dependencies (npm ci)
      if: ${{ inputs.install_dependencies == '1' }}
      shell: bash
      run: |
        set -euo pipefail
        cd "${PS_WORKSPACE_ROOT}"
        npm ci --no-audit --no-fund
        printf 'PS.NODE_BOOTSTRAP: OK\n'

    - name: Node bootstrap complete (no install)
      if: ${{ inputs.install_dependencies != '1' }}
      shell: bash
      run: |
        echo "PS.NODE_BOOTSTRAP: OK (install skipped)"
