# ==============================================================================
# Political Sphere - Composite Action: PS Init
# ==============================================================================
#
# METADATA
# ------------------------------------------------------------------------------
# id: ps-init
# version: 1.1.0
# owner: political-sphere
# classification: internal
# created: 2025-12-26
# last_updated: 2025-12-26
#
# DEPENDENCIES
# ------------------------------------------------------------------------------
# - ./.github/actions/ps-bootstrap/ps-harden-runner
# - ./.github/actions/ps-bootstrap/ps-checkout-repo
# - ./.github/actions/ps-bootstrap/ps-checkout-platform (optional)
# - ./.github/actions/ps-bootstrap/ps-tools (optional)
#
# DEPENDENTS
# ------------------------------------------------------------------------------
# - Workflow jobs that use ps-init as the entrypoint
#
#
# PURPOSE
# ------------------------------------------------------------------------------
# Canonical CI bootstrap switchboard for the Political Sphere ecosystem.
# Enforces a hardened, deterministic environment and delegates concerns to
# narrowly-scoped sub-actions:
#   - ps-harden-runner (MUST be first)
#   - ps-checkout (repo)
#   - HOME isolation
#   - ps-checkout-platform (optional)
#   - ps-tools (optional)
#
#
# CONTRACT
# ------------------------------------------------------------------------------
# - Harden runner MUST run first (no steps before it).
# - All toggles accept 0/1/true/false and are normalised.
# - Path inputs are validated (repo-relative, no traversal).
# - Outputs are stable and telemetry-friendly.
#
# SECURITY TIERING
# ------------------------------------------------------------------------------
# Level 0 - Critical (this action influences runner/network configuration and
#                    environment isolation; treat with high scrutiny)
#
# THREAT MODEL
# ------------------------------------------------------------------------------
# Purpose: Prevents unsafe input interpolation, workspace escape, and inadvertent
#          privilege escalation by validating user-provided inputs and enforcing
#          deterministic environment setup.
#
# AUDIT LOG
# ------------------------------------------------------------------------------
# Records major security-related changes locally using the `init_metadata` output
# and console logs to aid post-incident analysis and auditing.
#
# ==============================================================================
name: "PS Init"
description: "Canonical CI bootstrap switchboard: harden -> checkout -> HOME isolation -> platform -> tools"

inputs:
  # ---------------------------------------------------------------------------
  # Security hardening
  # ---------------------------------------------------------------------------
  egress_policy:
    description: "Egress policy for harden-runner (audit|block)"
    required: false
    default: "audit"

  # ---------------------------------------------------------------------------
  # Repository checkout
  # ---------------------------------------------------------------------------
  fetch_depth:
    description: "Git fetch depth (0=full)"
    required: false
    default: "1"

  checkout_ref:
    description: "Optional git ref to checkout"
    required: false
    default: ""

  require_full_history:
    description: "Require fetch_depth=0 (0/1/true/false)"
    required: false
    default: "false"

  # ---------------------------------------------------------------------------
  # HOME isolation
  # ---------------------------------------------------------------------------
  home_dir:
    description: "Repo-relative HOME directory to create and use (e.g. .home)"
    required: false
    default: ".home"

  home_isolation:
    description: "Enable HOME/XDG isolation for the job (0/1/true/false)"
    required: false
    default: "true"

  # ---------------------------------------------------------------------------
  # Platform checkout (optional)
  # ---------------------------------------------------------------------------
  platform_repo:
    description: "Platform repository OWNER/REPO (e.g. PoliticalSphere/ci)"
    required: false
    default: "PoliticalSphere/ci"

  platform_ref:
    description: "Platform ref (branch/tag/SHA)"
    required: false
    default: "main"

  platform_path:
    description: "Repo-relative path for platform checkout"
    required: false
    default: ".ps-platform"

  skip_platform_checkout:
    description: "Skip platform checkout (0/1/true/false)"
    required: false
    default: "false"

  platform_fetch_depth:
    description: "Platform checkout fetch depth (0 = full history, default: 1)"
    required: false
    default: "1"

  platform_clean_path:
    description: "Delete platform_path before checkout (0/1/true/false)"
    required: false
    default: "false"

  platform_allowed_repositories:
    description: "Optional newline-separated allowlist for platform_repo (OWNER/REPO). If set, platform_repo must be listed."
    required: false
    default: ""

  # ---------------------------------------------------------------------------
  # Tools (optional)
  # ---------------------------------------------------------------------------
  install_tools:
    description: "Install canonical tool bundles (0/1/true/false)"
    required: false
    default: "0"

  tools_bundle:
    description: "Tools bundle passed to ps-tools (lint|security|none)"
    required: false
    default: "none"

outputs:
  repo_root:
    description: "Resolved repository root (github.workspace)"
    value: ${{ steps.ps_init_outputs.outputs.repo_root }}

  home_dir:
    description: "Resolved HOME directory (absolute path) used by the job"
    value: ${{ steps.ps_init_outputs.outputs.home_dir }}

  home_original:
    description: "Original HOME before isolation (absolute path)"
    value: ${{ steps.ps_init_outputs.outputs.home_original }}

  home_isolation_enabled:
    description: "Whether HOME isolation was applied (true|false)"
    value: ${{ steps.ps_init_outputs.outputs.home_isolation_enabled }}

  init_metadata:
    description: "JSON metadata about the init environment (stringified object)"
    value: ${{ steps.ps_init_outputs.outputs.init_metadata }}

  platform_root:
    description: "Resolved platform root (absolute path), or empty when skipped"
    value: ${{ steps.ps_init_outputs.outputs.platform_root }}

  platform_enabled:
    description: "Whether platform checkout ran (true|false)"
    value: ${{ steps.ps_init_outputs.outputs.platform_enabled }}

runs:
  using: "composite"
  steps:
    # -----------------------------------------------------------------------------
    # PHASE 1: HARDEN RUNNER - MUST BE FIRST
    # Logic: Lockdown runner configuration prior to any setup steps.
    # Critical: Level 0 - alters runner security posture.
    # -----------------------------------------------------------------------------
    - name: Harden runner (PS)
      uses: ./.github/actions/ps-bootstrap/ps-harden-runner
      with:
        egress-policy: ${{ inputs.egress_policy }}

    # -----------------------------------------------------------------------------
    # PHASE 2: INPUT SANITIZATION & NORMALIZATION
    # Logic: Rejects non-repo paths; enforces boolean consistency.
    # Dependency: python3 (internal path resolution)
    # -----------------------------------------------------------------------------
    - name: Validate + normalise inputs (PS)
      id: ps_init_validate
      shell: bash
      env:
        PS_FETCH_DEPTH_INPUT: ${{ inputs.fetch_depth }}
        PS_CHECKOUT_REF_INPUT: ${{ inputs.checkout_ref }}
        PS_REQUIRE_FULL_HISTORY_INPUT: ${{ inputs.require_full_history }}
        PS_HOME_DIR_INPUT: ${{ inputs.home_dir }}
        PS_HOME_ISOLATION_INPUT: ${{ inputs.home_isolation }}

        PS_PLATFORM_REPO_INPUT: ${{ inputs.platform_repo }}
        PS_PLATFORM_REF_INPUT: ${{ inputs.platform_ref }}
        PS_PLATFORM_PATH_INPUT: ${{ inputs.platform_path }}
        PS_SKIP_PLATFORM_INPUT: ${{ inputs.skip_platform_checkout }}
        PS_PLATFORM_FETCH_DEPTH_INPUT: ${{ inputs.platform_fetch_depth }}
        PS_PLATFORM_CLEAN_PATH_INPUT: ${{ inputs.platform_clean_path }}
        PS_PLATFORM_ALLOWLIST_INPUT: ${{ inputs.platform_allowed_repositories }}

        PS_INSTALL_TOOLS_INPUT: ${{ inputs.install_tools }}
        PS_TOOLS_BUNDLE_INPUT: ${{ inputs.tools_bundle }}
      run: |
        # [PS.INIT.VALIDATE] ---------------------------------------------------------
        # Intent: Normalize 0/1/true/false and lock environment variables.
        # Safety: set -euo pipefail (Strict mode enabled)
        # ----------------------------------------------------------------------------
        set -euo pipefail

        format_root="${PS_PLATFORM_ROOT:-${GITHUB_WORKSPACE}}"
        format_sh="${format_root}/tools/scripts/branding/format.sh"
        expected_format_hash="accf30e19ae937f2fcb5af98ab65b19e47c551717f79e5f4027d936311355ea8"
        if [[ -f "${format_sh}" ]]; then
          actual_format_hash="$(FORMAT_SH="${format_sh}" python3 -c 'import hashlib, os; path=os.environ.get("FORMAT_SH"); print(hashlib.sha256(open(path,"rb").read()).hexdigest())')"
          if [[ "${actual_format_hash}" == "${expected_format_hash}" ]]; then
            # shellcheck source=/dev/null
            . "${format_sh}"
            if type -t ps_header >/dev/null 2>&1; then
              ps_header "PS Init: validate inputs"
            fi
          else
            printf 'PS.INIT: branding skipped (format.sh hash mismatch)\n'
          fi
        fi

        norm_bool() {
          local val
          val="$(printf '%s' "${1:-}" | tr '[:upper:]' '[:lower:]')"
          case "${val}" in
            1|true|yes|y|on)  echo "1" ;;
            0|false|no|n|off|"") echo "0" ;;
            *) return 1 ;;
          esac
        }

        if ! command -v python3 >/dev/null 2>&1; then
          printf 'ERROR: python3 is required for ps-init path validation\n' >&2
          exit 1
        fi

        validate_safe_path() {
          local input_path="$1"
          local resolved
          if [[ -z "${input_path}" ]]; then
            printf 'ERROR: path must not be empty\n' >&2
            exit 1
          fi
          if [[ "${input_path}" == "~"* || "${input_path}" == "." || "${input_path}" == "./" || "${input_path}" == ./* || "${input_path}" == */./* || "${input_path}" == */. || "${input_path}" == */ || "${input_path}" == *"$"* || "${input_path}" == *"`"* ]]; then
            printf 'ERROR: path must be a repo-relative safe path (got %q)\n' "${input_path}" >&2
            exit 1
          fi
          resolved="$(python3 -c "import os; print(os.path.abspath(os.path.join('${GITHUB_WORKSPACE}', '${input_path}')))")"
          if [[ "${resolved}" != "${GITHUB_WORKSPACE}"* ]]; then
            printf 'ERROR: path escapes workspace (got %q)\n' "${input_path}" >&2
            exit 1
          fi
          case "${input_path}" in
            .git|.github|.ps-platform|.git/*|.github/*|.ps-platform/*)
              printf 'ERROR: %s is a reserved system directory\n' "${input_path}" >&2
              exit 1
              ;;
          esac
        }

        require_full="$(norm_bool "${PS_REQUIRE_FULL_HISTORY_INPUT}")" || { printf 'ERROR: require_full_history must be 0/1/true/false (got %q)\n' "${PS_REQUIRE_FULL_HISTORY_INPUT}" >&2; exit 1; }
        skip_platform="$(norm_bool "${PS_SKIP_PLATFORM_INPUT}")" || { printf 'ERROR: skip_platform_checkout must be 0/1/true/false (got %q)\n' "${PS_SKIP_PLATFORM_INPUT}" >&2; exit 1; }
        clean_platform="$(norm_bool "${PS_PLATFORM_CLEAN_PATH_INPUT}")" || { printf 'ERROR: platform_clean_path must be 0/1/true/false (got %q)\n' "${PS_PLATFORM_CLEAN_PATH_INPUT}" >&2; exit 1; }
        install_tools="$(norm_bool "${PS_INSTALL_TOOLS_INPUT}")" || { printf 'ERROR: install_tools must be 0/1/true/false (got %q)\n' "${PS_INSTALL_TOOLS_INPUT}" >&2; exit 1; }
        isolate_home="$(norm_bool "${PS_HOME_ISOLATION_INPUT}")" || { printf 'ERROR: home_isolation must be 0/1/true/false (got %q)\n' "${PS_HOME_ISOLATION_INPUT}" >&2; exit 1; }

        depth="${PS_FETCH_DEPTH_INPUT:-1}"
        if ! [[ "${depth}" =~ ^[0-9]+$ ]]; then
          printf 'ERROR: fetch_depth must be a non-negative integer (got %q)\n' "${depth}" >&2
          exit 1
        fi
        if [[ "${require_full}" == "1" && "${depth}" != "0" ]]; then
          printf 'ERROR: require_full_history enabled but fetch_depth=%s (expected 0)\n' "${depth}" >&2
          exit 1
        fi

        home_rel="${PS_HOME_DIR_INPUT:-.home}"
        validate_safe_path "${home_rel}"

        pdepth="${PS_PLATFORM_FETCH_DEPTH_INPUT:-1}"
        if ! [[ "${pdepth}" =~ ^[0-9]+$ ]]; then
          printf 'ERROR: platform_fetch_depth must be a non-negative integer (got %q)\n' "${pdepth}" >&2
          exit 1
        fi

        prepo="${PS_PLATFORM_REPO_INPUT:-}"
        pref="${PS_PLATFORM_REF_INPUT:-main}"
        ppath="${PS_PLATFORM_PATH_INPUT:-.ps-platform}"

        if [[ "${skip_platform}" == "0" ]]; then
          if [[ -z "${prepo}" ]]; then
            printf 'ERROR: platform_repo must not be empty when platform checkout is enabled\n' >&2
            exit 1
          fi
          if ! [[ "${prepo}" =~ ^[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+$ ]]; then
            printf 'ERROR: platform_repo must be OWNER/REPO (got %q)\n' "${prepo}" >&2
            exit 1
          fi
          if [[ -z "${pref}" ]]; then
            printf 'ERROR: platform_ref must not be empty\n' >&2
            exit 1
          fi
          validate_safe_path "${ppath}"
        fi

        bundle="${PS_TOOLS_BUNDLE_INPUT:-none}"
        case "${bundle}" in
          lint|security|none) ;;
          *)
            printf 'ERROR: tools_bundle must be lint|security|none (got %q)\n' "${bundle}" >&2
            exit 1
            ;;
        esac

        emit_env() {
          local key="$1"
          local val="$2"
          local sanitized delimiter attempts
          sanitized="${val//$'\r'/}"
          delimiter="__PS_ENV_${RANDOM}_${RANDOM}__"
          attempts=0
          while [[ "${sanitized}" == *"${delimiter}"* ]]; do
            attempts=$((attempts + 1))
            if [[ "${attempts}" -gt 6 ]]; then
              printf 'ERROR: env value for %s contains an unsafe heredoc delimiter\n' "${key}" >&2
              exit 1
            fi
            delimiter="__PS_ENV_${RANDOM}_${RANDOM}__"
          done
          printf '%s<<%s\n%s\n%s\n' "${key}" "${delimiter}" "${sanitized}" "${delimiter}" >> "${GITHUB_ENV}"
        }

        # Persist validated values
        emit_env "PS_FETCH_DEPTH_VALIDATED" "${depth}"
        emit_env "PS_REQUIRE_FULL_HISTORY_VALIDATED" "${require_full}"
        emit_env "PS_HOME_DIR_VALIDATED" "${home_rel}"
        emit_env "PS_HOME_ISOLATION_VALIDATED" "${isolate_home}"
        emit_env "PS_HOME_ORIGINAL" "${HOME}"

        emit_env "PS_SKIP_PLATFORM_VALIDATED" "${skip_platform}"
        emit_env "PS_PLATFORM_REPO_VALIDATED" "${prepo}"
        emit_env "PS_PLATFORM_REF_VALIDATED" "${pref}"
        emit_env "PS_PLATFORM_PATH_VALIDATED" "${ppath}"
        emit_env "PS_PLATFORM_FETCH_DEPTH_VALIDATED" "${pdepth}"
        emit_env "PS_PLATFORM_CLEAN_PATH_VALIDATED" "${clean_platform}"
        emit_env "PS_PLATFORM_ALLOWLIST_VALIDATED" "${PS_PLATFORM_ALLOWLIST_INPUT:-}"

        emit_env "PS_INSTALL_TOOLS_VALIDATED" "${install_tools}"
        emit_env "PS_TOOLS_BUNDLE_VALIDATED" "${bundle}"

        printf 'PS.INIT: validated (repo depth=%s, platform=%s, tools=%s)\n' \
          "${depth}" \
          "$([[ "${skip_platform}" == "1" ]] && echo "off" || echo "on")" \
          "$([[ "${install_tools}" == "1" ]] && echo "${bundle}" || echo "off")"

    # -----------------------------------------------------------------------------
    # PHASE 3: CHECKOUT REPOSITORY
    # Logic: Deterministic repo checkout (validated fetch depth).
    # Dependency: Git client
    # -----------------------------------------------------------------------------
    - name: "Section: Checkout repo (PS)"
      shell: bash
      run: |
        # [PS.INIT.CHECKOUT] --------------------------------------------------------
        # Intent: Execute deterministic repository checkout with validated inputs.
        # Safety: set -euo pipefail (Strict mode enabled)
        # ----------------------------------------------------------------------------
        set -euo pipefail
        format_root="${PS_PLATFORM_ROOT:-${GITHUB_WORKSPACE}}"
        format_sh="${format_root}/tools/scripts/branding/format.sh"
        expected_format_hash="accf30e19ae937f2fcb5af98ab65b19e47c551717f79e5f4027d936311355ea8"
        if [[ -f "${format_sh}" ]]; then
          actual_format_hash="$(FORMAT_SH="${format_sh}" python3 -c 'import hashlib, os; path=os.environ.get("FORMAT_SH"); print(hashlib.sha256(open(path,"rb").read()).hexdigest())')"
          if [[ "${actual_format_hash}" == "${expected_format_hash}" ]]; then
            # shellcheck source=/dev/null
            . "${format_sh}"
            if type -t ps_rule >/dev/null 2>&1; then
              ps_rule
            fi
          else
            printf 'PS.INIT: branding skipped (format.sh hash mismatch)\n'
          fi
        fi

    - name: Checkout repo (PS)
      uses: ./.github/actions/ps-bootstrap/ps-checkout-repo
      with:
        fetch_depth: ${{ env.PS_FETCH_DEPTH_VALIDATED }}
        ref: ${{ inputs.checkout_ref }}

    # -----------------------------------------------------------------------------
    # PHASE 4: HOME ISOLATION
    # Logic: Create and switch to isolated HOME to contain job artifacts.
    # -----------------------------------------------------------------------------
    - name: Prepare HOME isolation (PS)
      id: ps_home
      if: ${{ env.PS_HOME_ISOLATION_VALIDATED == '1' }}
      shell: bash
      run: |
        # [PS.INIT.HOME] ------------------------------------------------------------
        # Intent: Prepare and enable HOME/XDG isolation for the job.
        # Safety: set -euo pipefail (Strict mode enabled)
        # ----------------------------------------------------------------------------
        set -euo pipefail
        format_root="${PS_PLATFORM_ROOT:-${GITHUB_WORKSPACE}}"
        format_sh="${format_root}/tools/scripts/branding/format.sh"
        expected_format_hash="accf30e19ae937f2fcb5af98ab65b19e47c551717f79e5f4027d936311355ea8"
        if [[ -f "${format_sh}" ]]; then
          actual_format_hash="$(FORMAT_SH="${format_sh}" python3 -c 'import hashlib, os; path=os.environ.get("FORMAT_SH"); print(hashlib.sha256(open(path,"rb").read()).hexdigest())')"
          if [[ "${actual_format_hash}" == "${expected_format_hash}" ]]; then
            # shellcheck source=/dev/null
            . "${format_sh}"
            if type -t ps_rule >/dev/null 2>&1; then
              ps_rule
            fi
          else
            printf 'PS.INIT: branding skipped (format.sh hash mismatch)\n'
          fi
        fi
        emit_env() {
          local key="$1"
          local val="$2"
          local sanitized delimiter attempts
          sanitized="${val//$'\r'/}"
          delimiter="__PS_ENV_${RANDOM}_${RANDOM}__"
          attempts=0
          while [[ "${sanitized}" == *"${delimiter}"* ]]; do
            attempts=$((attempts + 1))
            if [[ "${attempts}" -gt 6 ]]; then
              printf 'ERROR: env value for %s contains an unsafe heredoc delimiter\n' "${key}" >&2
              exit 1
            fi
            delimiter="__PS_ENV_${RANDOM}_${RANDOM}__"
          done
          printf '%s<<%s\n%s\n%s\n' "${key}" "${delimiter}" "${sanitized}" "${delimiter}" >> "${GITHUB_ENV}"
        }
        home_abs="${GITHUB_WORKSPACE}/${PS_HOME_DIR_VALIDATED}"
        mkdir -p "${home_abs}"

        # Apply HOME + XDG dirs (keeps tools isolated/deterministic)
        emit_env "HOME" "${home_abs}"
        emit_env "HOME_ORIGINAL" "${PS_HOME_ORIGINAL}"
        emit_env "XDG_CACHE_HOME" "${home_abs}/.cache"
        emit_env "XDG_CONFIG_HOME" "${home_abs}/.config"
        emit_env "XDG_STATE_HOME" "${home_abs}/.state"

        mkdir -p "${home_abs}/bin"
        echo "${home_abs}/bin" >> "${GITHUB_PATH}"
        mkdir -p "${home_abs}/.cache" "${home_abs}/.config" "${home_abs}/.state"
        echo "home_abs=${home_abs}" >> "${GITHUB_OUTPUT}"

        printf 'PS.INIT: HOME=%s\n' "${home_abs}"

    # =========================================================================
    # 5) CHECKOUT PLATFORM (OPTIONAL)
    # =========================================================================
    - name: "Section: Checkout platform (PS)"
      if: ${{ env.PS_SKIP_PLATFORM_VALIDATED == '0' }}
      shell: bash
      run: |
        # [PS.INIT.PLATFORM] -------------------------------------------------------
        # Intent: Prepare environment and validate platform checkout inputs.
        # Safety: set -euo pipefail (Strict mode enabled)
        # ----------------------------------------------------------------------------
        set -euo pipefail
        format_root="${PS_PLATFORM_ROOT:-${GITHUB_WORKSPACE}}"
        format_sh="${format_root}/tools/scripts/branding/format.sh"
        expected_format_hash="accf30e19ae937f2fcb5af98ab65b19e47c551717f79e5f4027d936311355ea8"
        if [[ -f "${format_sh}" ]]; then
          actual_format_hash="$(FORMAT_SH="${format_sh}" python3 -c 'import hashlib, os; path=os.environ.get("FORMAT_SH"); print(hashlib.sha256(open(path,"rb").read()).hexdigest())')"
          if [[ "${actual_format_hash}" == "${expected_format_hash}" ]]; then
            # shellcheck source=/dev/null
            . "${format_sh}"
            if type -t ps_rule >/dev/null 2>&1; then
              ps_rule
            fi
          else
            printf 'PS.INIT: branding skipped (format.sh hash mismatch)\n'
          fi
        fi

    - name: Checkout platform (PS)
      if: ${{ env.PS_SKIP_PLATFORM_VALIDATED == '0' }}
      uses: ./.github/actions/ps-bootstrap/ps-checkout-platform
      with:
        repository: ${{ env.PS_PLATFORM_REPO_VALIDATED }}
        ref: ${{ env.PS_PLATFORM_REF_VALIDATED }}
        path: ${{ env.PS_PLATFORM_PATH_VALIDATED }}
        fetch_depth: ${{ env.PS_PLATFORM_FETCH_DEPTH_VALIDATED }}
        clean_path: ${{ env.PS_PLATFORM_CLEAN_PATH_VALIDATED == '1' && 'true' || 'false' }}
        allowed_repositories: ${{ env.PS_PLATFORM_ALLOWLIST_VALIDATED }}
        require_full_history: "false"
        persist_credentials: "false"
        submodules: "false"

    - name: Export PS_PLATFORM_ROOT (PS)
      if: ${{ env.PS_SKIP_PLATFORM_VALIDATED == '0' }}
      shell: bash
      run: |
        # [PS.INIT.EXPORT] ---------------------------------------------------------
        # Intent: Export the resolved platform root into the environment for later steps.
        # Safety: set -euo pipefail (Strict mode enabled)
        # ----------------------------------------------------------------------------
        set -euo pipefail
        emit_env() {
          local key="$1"
          local val="$2"
          local sanitized delimiter attempts
          sanitized="${val//$'\r'/}"
          delimiter="__PS_ENV_${RANDOM}_${RANDOM}__"
          attempts=0
          while [[ "${sanitized}" == *"${delimiter}"* ]]; do
            attempts=$((attempts + 1))
            if [[ "${attempts}" -gt 6 ]]; then
              printf 'ERROR: env value for %s contains an unsafe heredoc delimiter\n' "${key}" >&2
              exit 1
            fi
            delimiter="__PS_ENV_${RANDOM}_${RANDOM}__"
          done
          printf '%s<<%s\n%s\n%s\n' "${key}" "${delimiter}" "${sanitized}" "${delimiter}" >> "${GITHUB_ENV}"
        }
        platform_abs="${GITHUB_WORKSPACE}/${PS_PLATFORM_PATH_VALIDATED}"
        emit_env "PS_PLATFORM_ROOT" "${platform_abs}"
        printf 'PS.INIT: PS_PLATFORM_ROOT=%s\n' "${platform_abs}"

    # =========================================================================
    # 6) INSTALL TOOLS (OPTIONAL)
    # =========================================================================
    - name: "Section: Install tools (PS)"
      if: ${{ env.PS_INSTALL_TOOLS_VALIDATED == '1' && env.PS_TOOLS_BUNDLE_VALIDATED != 'none' }}
      shell: bash
      run: |
        # [PS.INIT.INSTALL] --------------------------------------------------------
        # Intent: Install canonical tool bundles if requested by validated inputs.
        # Safety: set -euo pipefail (Strict mode enabled)
        # ----------------------------------------------------------------------------
        set -euo pipefail
        format_root="${PS_PLATFORM_ROOT:-${GITHUB_WORKSPACE}}"
        format_sh="${format_root}/tools/scripts/branding/format.sh"
        expected_format_hash="accf30e19ae937f2fcb5af98ab65b19e47c551717f79e5f4027d936311355ea8"
        if [[ -f "${format_sh}" ]]; then
          actual_format_hash="$(FORMAT_SH="${format_sh}" python3 -c 'import hashlib, os; path=os.environ.get("FORMAT_SH"); print(hashlib.sha256(open(path,"rb").read()).hexdigest())')"
          if [[ "${actual_format_hash}" == "${expected_format_hash}" ]]; then
            # shellcheck source=/dev/null
            . "${format_sh}"
            if type -t ps_rule >/dev/null 2>&1; then
              ps_rule
            fi
          else
            printf 'PS.INIT: branding skipped (format.sh hash mismatch)\n'
          fi
        fi

    - name: Install canonical tools (PS)
      if: ${{ env.PS_INSTALL_TOOLS_VALIDATED == '1' && env.PS_TOOLS_BUNDLE_VALIDATED != 'none' }}
      uses: ./.github/actions/ps-bootstrap/ps-tools
      with:
        bundle: ${{ env.PS_TOOLS_BUNDLE_VALIDATED }}

    # =========================================================================
    # OUTPUTS
    # =========================================================================
    - name: Emit outputs (PS)
      id: ps_init_outputs
      shell: bash
      env:
        PS_HOME_ABS: ${{ steps.ps_home.outputs.home_abs }}
      run: |
        set -euo pipefail

        repo_root="${GITHUB_WORKSPACE}"
        platform_root="${PS_PLATFORM_ROOT:-}"
        platform_enabled="false"
        home_dir=""
        home_isolation_enabled="false"
        home_original="${PS_HOME_ORIGINAL:-}"

        if [[ "${PS_HOME_ISOLATION_VALIDATED}" == "1" ]]; then
          home_dir="${PS_HOME_ABS}"
          home_isolation_enabled="true"
        else
          home_dir="${home_original}"
        fi

        if [[ "${PS_SKIP_PLATFORM_VALIDATED}" == "0" ]]; then
          platform_enabled="true"
        fi

        {
          echo "repo_root=${repo_root}"
          echo "home_dir=${home_dir}"
          echo "home_original=${home_original}"
          echo "home_isolation_enabled=${home_isolation_enabled}"
          echo "platform_root=${platform_root}"
          echo "platform_enabled=${platform_enabled}"
          echo "init_metadata={\"repo_root\":\"${repo_root}\",\"home_dir\":\"${home_dir}\",\"is_isolated\":${home_isolation_enabled},\"platform_enabled\":${platform_enabled},\"timestamp\":\"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"}"
        } >> "${GITHUB_OUTPUT}"

        printf 'PS.INIT: repo_root=%s\n' "${repo_root}"
        printf 'PS.INIT: home_isolation=%s\n' "${home_isolation_enabled}"
        printf 'PS.INIT: platform_enabled=%s\n' "${platform_enabled}"
        printf 'PS.INIT: platform_root=%s\n' "${platform_root}"
        printf 'PS.INIT: OK\n'
