# ==============================================================================
# Political Sphere — Composite Action: PS Checkout (Platform)
# License: Proprietary
# ==============================================================================
# ps_header_v: 6
#
# ─────────────────────────────────────────────────────────────────────────────
# IDENTITY
# ─────────────────────────────────────────────────────────────────────────────
# meta:
#   file_id: .github/actions/ps-bootstrap/ps-checkout-platform/action.yml
#   file_type: action
#   language: yaml
#   version: 1.0.0
#   status: active
#   classification: internal
#   owner: political-sphere
#   last_editor: codex
#
# ─────────────────────────────────────────────────────────────────────────────
# LIFECYCLE & CHANGE CONTROL
# ─────────────────────────────────────────────────────────────────────────────
#   lifecycle:
#     created: 2025-12-28
#     last_updated: 2025-12-28
#     last_updated_mode: manual
#     review_cycle: 6 months
#     change_control: lightweight
#
# ─────────────────────────────────────────────────────────────────────────────
# CONTEXT
# ─────────────────────────────────────────────────────────────────────────────
# context:
#   parent_system: CI/CD Platform
#   initiative: Hardened CI
#
# ─────────────────────────────────────────────────────────────────────────────
# GOVERNANCE
# ─────────────────────────────────────────────────────────────────────────────
# governance:
#   intent: Provide the PS Checkout (Platform) composite action to Checkout platform
#     repository into a controlled path (validated + pinned).
#   guarantees:
#     - Defines inputs and outputs for consistent downstream usage.
#     - Executes the composite steps declared in this action.
#     - Uses pinned external actions when referenced.
#   prohibitions:
#     - Does not grant permissions beyond the invoking workflow.
#     - Does not assume network access beyond runner policy.
#
# ─────────────────────────────────────────────────────────────────────────────
# INTERFACES
# ─────────────────────────────────────────────────────────────────────────────
# interfaces:
#   inputs: [repository, ref, path, fetch_depth, persist_credentials, submodules,
#     require_full_history, clean_path, require_pinned_ref, allowed_repositories]
#   outputs: [platform_path, platform_path_abs, platform_repository, platform_ref]
#   exit_codes: [0=success, 1=failure]
#
# ─────────────────────────────────────────────────────────────────────────────
# EXECUTION
# ─────────────────────────────────────────────────────────────────────────────
# execution:
#   invocation: Used as a composite action step in GitHub Actions workflows.
#   example_invocation: >-
#     uses: ./.github/actions/ps-bootstrap/ps-checkout-platform
#   model: deterministic
#   idempotency: not guaranteed
#
# ─────────────────────────────────────────────────────────────────────────────
# DEPENDENCIES
# ─────────────────────────────────────────────────────────────────────────────
# dependencies:
#   internal: [tools/scripts/branding/format.sh, tools/scripts/branding/safe-format.sh,
#     tools/scripts/actions/cross-cutting/env.sh,
#     tools/scripts/actions/cross-cutting/path.sh,
#     tools/scripts/actions/cross-cutting/validate.sh,
#     tools/scripts/actions/ps-bootstrap/ps-checkout-validate-common.sh,
#     tools/scripts/branding/print-section.sh,
#     tools/scripts/actions/cross-cutting/validate.sh,
#     tools/scripts/ci/validate-ci/index.js, configs/ci/policies/validate-ci.yml]
#   external: [bash, actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8]
#
# ─────────────────────────────────────────────────────────────────────────────
# SECURITY & POLICY
# ─────────────────────────────────────────────────────────────────────────────
# security:
#   permissions: [none]
#   secrets: [none]
#   network: restricted; depends on runner policy
#   policy_enforcement: [configs/ci/policies/allowed-actions.yml,
#     configs/ci/policies/action-pinning.yml,
#     configs/ci/policies/inline-bash.yml,
#     configs/ci/policies/section-headers.yml]
#
# ─────────────────────────────────────────────────────────────────────────────
# OPERATIONS
# ─────────────────────────────────────────────────────────────────────────────
# ops:
#   failure_modes: Step failures or validation errors surface as non-zero exits.
#   observability: Step logs are emitted in the GitHub Actions job output.
#   performance: Seconds to minutes depending on repo size and workload.
#
# ─────────────────────────────────────────────────────────────────────────────
# RISKS
# ─────────────────────────────────────────────────────────────────────────────
# risks:
#   assumptions:
#     - Inputs are provided as documented.
#     - Runner has required tooling for declared steps.
#   known_risks:
#     - Network or platform outages can interrupt execution.
#
# ─────────────────────────────────────────────────────────────────────────────
# RELATED
# ─────────────────────────────────────────────────────────────────────────────
# related:
#   references:
#     - .github/actions/ps-bootstrap/ps-checkout-platform/README.md
#     - tools/scripts/branding/format.sh
#     - tools/scripts/branding/safe-format.sh
#     - tools/scripts/actions/cross-cutting/path.sh
#     - tools/scripts/actions/cross-cutting/validate.sh
#     - tools/scripts/actions/cross-cutting/env.sh
#     - tools/scripts/actions/ps-bootstrap/ps-checkout-validate-common.sh
#     - tools/scripts/branding/print-section.sh
#     - tools/scripts/actions/cross-cutting/validate.sh
#
# ==============================================================================

name: "PS Checkout (Platform)"
description: "Checkout platform repository into a controlled path (validated + pinned)"

inputs:
  repository:
    description: "Platform repository in OWNER/REPO form (e.g. PoliticalSphere/ci)"
    required: true

  ref:
    description: "Git ref (branch, tag, or SHA) to checkout (required)"
    required: true

  path:
    description: "Checkout path relative to github.workspace (e.g. .ps-platform)"
    required: false
    default: ".ps-platform"

  fetch_depth:
    description: "Git fetch depth (0 = full history, default: 1)"
    required: false
    default: "1"

  persist_credentials:
    description: "Whether to persist credentials in the git config (true|false)"
    required: false
    default: "false"

  submodules:
    description: "Submodules mode: false|true|recursive"
    required: false
    default: "false"

  require_full_history:
    description: "Require fetch_depth=0 (true|false)"
    required: false
    default: "false"

  clean_path:
    description: >-
      Delete the target path before checkout (true|false). Use true to avoid
      dirty-tree conflicts.
    required: false
    default: "false"

  require_pinned_ref:
    description: >-
      Require platform ref to be a full 40-char commit SHA (true|false).
    required: false
    default: "false"

  allowed_repositories:
    description: >-
      Optional newline-separated allowlist of OWNER/REPO values. If set,
      repository must be in the list.
    required: false
    default: ""

outputs:
  platform_path:
    description: "Repo-relative path used for platform checkout"
    value: ${{ steps.ps_checkout_platform_outputs.outputs.platform_path }}

  platform_path_abs:
    description: "Absolute path to the platform checkout directory"
    value: ${{ steps.ps_checkout_platform_outputs.outputs.platform_path_abs }}

  platform_repository:
    description: "Validated platform repository (OWNER/REPO)"
    value: ${{ steps.ps_checkout_platform_outputs.outputs.platform_repository }}

  platform_ref:
    description: "Validated platform ref"
    value: ${{ steps.ps_checkout_platform_outputs.outputs.platform_ref }}

runs:
  using: "composite"
  steps:
    - name: Validate inputs (PS)
      shell: bash
      env:
        PS_REPOSITORY_INPUT: ${{ inputs.repository }}
        PS_REF_INPUT: ${{ inputs.ref }}
        PS_PATH_INPUT: ${{ inputs.path }}
        PS_FETCH_DEPTH_INPUT: ${{ inputs.fetch_depth }}
        PS_PERSIST_CREDENTIALS_INPUT: ${{ inputs.persist_credentials }}
        PS_SUBMODULES_INPUT: ${{ inputs.submodules }}
        PS_REQUIRE_FULL_HISTORY_INPUT: ${{ inputs.require_full_history }}
        PS_CLEAN_PATH_INPUT: ${{ inputs.clean_path }}
        PS_REQUIRE_PINNED_REF_INPUT: ${{ inputs.require_pinned_ref }}
        PS_ALLOWED_REPOSITORIES_INPUT: ${{ inputs.allowed_repositories }}
      run: |
        set -euo pipefail

        # shellcheck source=tools/scripts/branding/safe-format.sh
        . "${GITHUB_WORKSPACE}/tools/scripts/branding/safe-format.sh"
        ps_format_try_load "${GITHUB_WORKSPACE}" "" "PS.CHECKOUT.PLATFORM" || true

        # shellcheck source=tools/scripts/actions/cross-cutting/env.sh
        . "${GITHUB_WORKSPACE}/tools/scripts/actions/cross-cutting/env.sh"
        # shellcheck source=tools/scripts/actions/cross-cutting/path.sh
        . "${GITHUB_WORKSPACE}/tools/scripts/actions/cross-cutting/path.sh"
        # shellcheck source=tools/scripts/actions/cross-cutting/validate.sh
        . "${GITHUB_WORKSPACE}/tools/scripts/actions/cross-cutting/validate.sh"

        fail() {
          v_error "$*"
          exit 1
        }

        log_info() {
          if type -t ps_detail >/dev/null 2>&1; then
            ps_detail "$*"
          else
            printf 'PS.CHECKOUT.PLATFORM: %s\n' "$*"
          fi
        }

        repo="${PS_REPOSITORY_INPUT:-}"
        if [[ -z "${repo}" ]]; then
          fail "inputs.repository is required"
        fi
        repo="$(require_owner_repo "inputs.repository" "${repo}")"

        allowlist="${PS_ALLOWED_REPOSITORIES_INPUT:-}"
        if [[ -z "${allowlist}" ]]; then
          owner="${repo%%/*}"
          if [[ "${owner}" != "PoliticalSphere" ]]; then
            fail "inputs.repository owner must be PoliticalSphere unless allowlisted (got ${repo})"
          fi
        fi

        # Optional allowlist guard (high value for internal platform safety)
        if [[ -n "${allowlist}" ]]; then
          allowed="0"
          while IFS= read -r line; do
            tool_trim="$(printf '%s' "${line}" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//')"
            [[ -z "${tool_trim}" ]] && continue
            [[ "${tool_trim}" == "#"* ]] && continue
            if [[ "${tool_trim}" == "${repo}" ]]; then
              allowed="1"
              break
            fi
          done <<< "${allowlist}"
          if [[ "${allowed}" != "1" ]]; then
            fail "repository ${repo} not in allowed_repositories allowlist"
          fi
        fi

        ref="${PS_REF_INPUT:-}"
        if [[ -z "${ref}" ]]; then
          fail "inputs.ref must not be empty"
        fi

        path="${PS_PATH_INPUT:-.ps-platform}"
        if [[ -z "${path}" ]]; then
          fail "inputs.path must not be empty"
        fi
        # Path traversal guard (defense-in-depth): forbid absolute or ".." anywhere.
        if ! safe_relpath_no_dotdot "${path}"; then
          fail "inputs.path must be a repo-relative safe path (got ${path})"
        fi

        require_pinned="$(require_true_false "inputs.require_pinned_ref" \
          "${PS_REQUIRE_PINNED_REF_INPUT:-false}")"
        clean="$(require_true_false "inputs.clean_path" "${PS_CLEAN_PATH_INPUT:-false}")"

        PS_LOG_PREFIX="PS.CHECKOUT.PLATFORM" \
        PS_ENV_PREFIX="PS_PLATFORM" \
          bash "${GITHUB_WORKSPACE}/tools/scripts/actions/ps-bootstrap/ps-checkout-validate-common.sh"

        emit_env "PS_PLATFORM_REPO_VALIDATED" "${repo}"
        emit_env "PS_PLATFORM_REF_VALIDATED" "${ref}"
        emit_env "PS_PLATFORM_PATH_VALIDATED" "${path}"
        emit_env "PS_PLATFORM_CLEAN_PATH_VALIDATED" "${clean}"
        emit_env "PS_PLATFORM_REQUIRE_PINNED_REF_VALIDATED" "${require_pinned}"

        log_info "repository=${repo}"
        log_info "ref=${ref}"
        log_info "path=${path}"
        log_info "clean_path=${clean}"
        log_info "require_pinned_ref=${require_pinned}"

    - name: Clean platform path (optional)
      if: ${{ env.PS_PLATFORM_CLEAN_PATH_VALIDATED == 'true' }}
      shell: bash
      run: |
        set -euo pipefail
        target="${GITHUB_WORKSPACE}/${PS_PLATFORM_PATH_VALIDATED}"
        if [[ -e "${target}" ]]; then
          printf 'PS.CHECKOUT.PLATFORM: cleaning %s\n' "${target}"
          rm -rf "${target}"
        fi

    - name: Checkout platform repository (PS)
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      with:
        repository: ${{ env.PS_PLATFORM_REPO_VALIDATED }}
        ref: ${{ env.PS_PLATFORM_REF_VALIDATED }}
        path: ${{ env.PS_PLATFORM_PATH_VALIDATED }}
        fetch-depth: ${{ env.PS_PLATFORM_FETCH_DEPTH_VALIDATED }}
        persist-credentials: ${{ env.PS_PLATFORM_PERSIST_CREDENTIALS_VALIDATED }}
        submodules: ${{ env.PS_PLATFORM_SUBMODULES_VALIDATED }}

    - name: Verify platform integrity (PS)
      shell: bash
      env:
        PS_PLATFORM_PATH: ${{ env.PS_PLATFORM_PATH_VALIDATED }}
        PS_PLATFORM_REF: ${{ env.PS_PLATFORM_REF_VALIDATED }}
        PS_PLATFORM_REQUIRE_PINNED_REF: >-
          ${{ env.PS_PLATFORM_REQUIRE_PINNED_REF_VALIDATED }}
      run: |
        set -euo pipefail
        # shellcheck source=tools/scripts/actions/cross-cutting/validate.sh
        . "${GITHUB_WORKSPACE}/tools/scripts/actions/cross-cutting/validate.sh"

        fail() {
          v_error "$*"
          exit 1
        }

        platform_dir="${GITHUB_WORKSPACE}/${PS_PLATFORM_PATH}"
        if [[ ! -d "${platform_dir}" ]]; then
          fail "platform checkout path not found: ${platform_dir}"
        fi

        if ! git -C "${platform_dir}" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
          fail "platform checkout is not a git repository: ${platform_dir}"
        fi

        head_sha="$(git -C "${platform_dir}" rev-parse HEAD)"
        printf 'PS.CHECKOUT.PLATFORM: head_sha=%s\n' "${head_sha}"

        if [[ "${PS_PLATFORM_REQUIRE_PINNED_REF}" == "true" ]]; then
          if [[ ! "${PS_PLATFORM_REF}" =~ ^[0-9a-fA-F]{40}$ ]]; then
            fail "platform ref must be a full 40-char commit SHA when require_pinned_ref=true (got ${PS_PLATFORM_REF})"
          fi
        fi

        if [[ "${PS_PLATFORM_REF}" =~ ^[0-9a-fA-F]{7,40}$ ]]; then
          expected_sha="$(git -C "${platform_dir}" rev-parse "${PS_PLATFORM_REF}^{commit}")"
          if [[ "${head_sha}" != "${expected_sha}" ]]; then
            fail "platform ref mismatch (expected ${expected_sha}, got ${head_sha})"
          fi
        fi

        if [[ -n "$(git -C "${platform_dir}" status --porcelain)" ]]; then
          v_error "platform checkout is not clean"
          git -C "${platform_dir}" status --porcelain >&2
          exit 1
        fi

        missing="0"
        for rel in \
          "tools/scripts/branding/format.sh" \
          "tools/scripts/branding/print-section.sh" \
          "tools/scripts/actions/cross-cutting/validate.sh" \
          "tools/scripts/ci/validate-ci/index.js" \
          "configs/ci/policies/validate-ci.yml"; do
          if [[ ! -f "${platform_dir}/${rel}" ]]; then
            v_error "platform missing required file: ${rel}"
            missing="1"
          fi
        done

        if [[ "${missing}" == "1" ]]; then
          exit 1
        fi

        printf 'PS.CHECKOUT.PLATFORM: integrity=ok\n'

    - name: Emit outputs (PS)
      id: ps_checkout_platform_outputs
      shell: bash
      run: |
        set -euo pipefail
        {
          echo "platform_repository=${PS_PLATFORM_REPO_VALIDATED}"
          echo "platform_ref=${PS_PLATFORM_REF_VALIDATED}"
          echo "platform_path=${PS_PLATFORM_PATH_VALIDATED}"
          platform_path_abs="${GITHUB_WORKSPACE}/${PS_PLATFORM_PATH_VALIDATED}"
          echo "platform_path_abs=${platform_path_abs}"
        } >> "${GITHUB_OUTPUT}"

        printf 'PS.CHECKOUT.PLATFORM: OK\n'
