# ==============================================================================
# Political Sphere — Composite Action: PS Init
# License: Proprietary
# ==============================================================================
# ps_header_v: 6
#
# ─────────────────────────────────────────────────────────────────────────────
# IDENTITY
# ─────────────────────────────────────────────────────────────────────────────
# meta:
#   file_id: .github/actions/ps-bootstrap/ps-initialize-environment/action.yml
#   file_type: action
#   language: yaml
#   version: 1.0.0
#   status: active
#   classification: internal
#   owner: political-sphere
#   last_editor: codex
#
# ─────────────────────────────────────────────────────────────────────────────
# LIFECYCLE & CHANGE CONTROL
# ─────────────────────────────────────────────────────────────────────────────
#   lifecycle:
#     created: 2025-12-28
#     last_updated: 2025-12-28
#     last_updated_mode: manual
#     review_cycle: 6 months
#     change_control: lightweight
#
# ─────────────────────────────────────────────────────────────────────────────
# CONTEXT
# ─────────────────────────────────────────────────────────────────────────────
# context:
#   parent_system: CI/CD Platform
#   initiative: Hardened CI
#
# ─────────────────────────────────────────────────────────────────────────────
# GOVERNANCE
# ─────────────────────────────────────────────────────────────────────────────
# governance:
#   intent: Provide the PS Init composite action to >-.
#   guarantees:
#     - Defines inputs and outputs for consistent downstream usage.
#     - Executes the composite steps declared in this action.
#     - Uses pinned external actions when referenced.
#   prohibitions:
#     - Does not grant permissions beyond the invoking workflow.
#     - Does not assume network access beyond runner policy.
#
# ─────────────────────────────────────────────────────────────────────────────
# INTERFACES
# ─────────────────────────────────────────────────────────────────────────────
# interfaces:
#   inputs: [egress_policy, fetch_depth, cache, checkout_ref, require_full_history,
#     home_dir, home_isolation, platform_repo, platform_ref, platform_path,
#     skip_platform_checkout, platform_fetch_depth, platform_clean_path,
#     platform_require_pinned_ref, platform_allowed_repositories, install_tools,
#     tools_bundle]
#   outputs: [repo_root, home_dir, home_original, home_isolation_enabled, init_metadata,
#     platform_root, platform_enabled]
#   exit_codes: [0=success, 1=failure]
#
# ─────────────────────────────────────────────────────────────────────────────
# EXECUTION
# ─────────────────────────────────────────────────────────────────────────────
# execution:
#   invocation: Used as a composite action step in GitHub Actions workflows.
#   example_invocation: >-
#     uses: ./.github/actions/ps-bootstrap/ps-initialize-environment
#   model: deterministic
#   idempotency: not guaranteed
#
# ─────────────────────────────────────────────────────────────────────────────
# DEPENDENCIES
# ─────────────────────────────────────────────────────────────────────────────
# dependencies:
#   internal: [tools/scripts/actions/ps-bootstrap/ps-initialize-environment/ps-bootstrap-validate-init.sh,
#     tools/scripts/actions/cross-cutting/normalize.sh,
#     tools/scripts/core/gha-helpers.sh,
#     tools/scripts/core/path-validation.sh,
#     tools/scripts/core/validation.sh,
#     tools/scripts/branding/format.sh,
#     tools/scripts/actions/ps-bootstrap]
#   external: [bash]
#
# ─────────────────────────────────────────────────────────────────────────────
# SECURITY & POLICY
# ─────────────────────────────────────────────────────────────────────────────
# security:
#   permissions: [none]
#   secrets: [none]
#   network: restricted; depends on runner policy
#   policy_enforcement: [configs/ci/policies/allowed-actions.yml,
#     configs/ci/policies/action-pinning.yml,
#     configs/ci/policies/inline-bash.yml,
#     configs/ci/policies/section-headers.yml]
#
# ─────────────────────────────────────────────────────────────────────────────
# OPERATIONS
# ─────────────────────────────────────────────────────────────────────────────
# ops:
#   failure_modes: Step failures or validation errors surface as non-zero exits.
#   observability: Step logs are emitted in the GitHub Actions job output.
#   performance: Seconds to minutes depending on repo size and workload.
#
# ─────────────────────────────────────────────────────────────────────────────
# RISKS
# ─────────────────────────────────────────────────────────────────────────────
# risks:
#   assumptions:
#     - Inputs are provided as documented.
#     - Runner has required tooling for declared steps.
#   known_risks:
#     - Network or platform outages can interrupt execution.
#
# ─────────────────────────────────────────────────────────────────────────────
# RELATED
# ─────────────────────────────────────────────────────────────────────────────
# related:
#   references:
#     - .github/actions/ps-bootstrap/ps-initialize-environment/README.md
#     - tools/scripts/actions/cross-cutting/normalize.sh
#     - tools/scripts/core/gha-helpers.sh
#     - tools/scripts/core/path-validation.sh
#     - tools/scripts/core/validation.sh
#     - tools/scripts/branding/format.sh
#     - tools/scripts/actions/ps-bootstrap
#
# ==============================================================================

name: "PS Init"
description: >-
  Canonical CI bootstrap switchboard: harden -> checkout -> HOME isolation ->
  platform -> tools

inputs:
  # ---------------------------------------------------------------------------
  # Security hardening
  # ---------------------------------------------------------------------------
  egress_policy:
    description: "Egress policy for harden-runner (audit|block)"
    required: false
    default: "audit"

  # ---------------------------------------------------------------------------
  # Repository checkout
  # ---------------------------------------------------------------------------
  fetch_depth:
    description: "Git fetch depth (0=full)"
    required: false
    default: "1"

  cache:
    description: "Enable dependency caching (1 = on, 0 = off)"
    required: false
    default: "1"

  checkout_ref:
    description: "Optional git ref to checkout"
    required: false
    default: ""

  require_full_history:
    description: "Require fetch_depth=0 (0/1/true/false)"
    required: false
    default: "false"

  # ---------------------------------------------------------------------------
  # HOME isolation
  # ---------------------------------------------------------------------------
  home_dir:
    description: "Repo-relative HOME directory to create and use (e.g. .home)"
    required: false
    default: ".home"

  home_isolation:
    description: "Enable HOME/XDG isolation for the job (0/1/true/false)"
    required: false
    default: "true"

  # ---------------------------------------------------------------------------
  # Platform checkout (optional)
  # ---------------------------------------------------------------------------
  platform_repo:
    description: "Platform repository OWNER/REPO (e.g. PoliticalSphere/ci)"
    required: false
    default: "PoliticalSphere/ci"

  platform_ref:
    description: "Platform ref (branch/tag/SHA)"
    required: false

  platform_path:
    description: "Repo-relative path for platform checkout"
    required: false
    default: ".ps-platform"

  skip_platform_checkout:
    description: "Skip platform checkout (0/1/true/false)"
    required: false
    default: "false"

  platform_fetch_depth:
    description: "Platform checkout fetch depth (0 = full history, default: 1)"
    required: false
    default: "1"

  platform_clean_path:
    description: "Delete platform_path before checkout (0/1/true/false)"
    required: false
    default: "false"

  platform_require_pinned_ref:
    description: >-
      Require platform_ref to be a full 40-char commit SHA (0/1/true/false)
    required: false
    default: "false"

  platform_allowed_repositories:
    description: >-
      Optional newline-separated allowlist for platform_repo (OWNER/REPO). If
      set, platform_repo must be listed.
    required: false
    default: ""

  # ---------------------------------------------------------------------------
  # Tools (optional)
  # ---------------------------------------------------------------------------
  install_tools:
    description: "Install canonical tool bundles (0/1/true/false)"
    required: false
    default: "0"

  tools_bundle:
    description: "Tools bundle passed to ps-tools (lint|security|none)"
    required: false
    default: "none"

outputs:
  repo_root:
    description: "Resolved repository root (github.workspace)"
    value: ${{ steps.ps_init_outputs.outputs.repo_root }}

  home_dir:
    description: "Resolved HOME directory (absolute path) used by the job"
    value: ${{ steps.ps_init_outputs.outputs.home_dir }}

  home_original:
    description: "Original HOME before isolation (absolute path)"
    value: ${{ steps.ps_init_outputs.outputs.home_original }}

  home_isolation_enabled:
    description: "Whether HOME isolation was applied (true|false)"
    value: ${{ steps.ps_init_outputs.outputs.home_isolation_enabled }}

  init_metadata:
    description: "JSON metadata about the init environment (stringified object)"
    value: ${{ steps.ps_init_outputs.outputs.init_metadata }}

  platform_root:
    description: "Resolved platform root (absolute path), or empty when skipped"
    value: ${{ steps.ps_init_outputs.outputs.platform_root }}

  platform_enabled:
    description: "Whether platform checkout ran (true|false)"
    value: ${{ steps.ps_init_outputs.outputs.platform_enabled }}

runs:
  using: "composite"
  steps:
    # -----------------------------------------------------------------------------
    # PHASE 1: HARDEN RUNNER - MUST BE FIRST
    # Logic: Lockdown runner configuration prior to any setup steps.
    # Critical: Level 0 - alters runner security posture.
    # -----------------------------------------------------------------------------
    - name: Harden runner (PS)
      uses: ./.github/actions/ps-bootstrap/ps-harden-runner
      with:
        egress-policy: ${{ inputs.egress_policy }}

    # -----------------------------------------------------------------------------
    # PHASE 2: INPUT SANITIZATION & NORMALIZATION
    # Logic: Rejects non-repo paths; enforces boolean consistency.
    # Dependency: python3 (internal path resolution)
    # -----------------------------------------------------------------------------
    - name: Validate + normalise inputs (PS)
      id: ps_init_validate
      shell: bash
      env:
        PS_FETCH_DEPTH_INPUT: ${{ inputs.fetch_depth }}
        PS_CHECKOUT_REF_INPUT: ${{ inputs.checkout_ref }}
        PS_REQUIRE_FULL_HISTORY_INPUT: ${{ inputs.require_full_history }}
        PS_HOME_DIR_INPUT: ${{ inputs.home_dir }}
        PS_HOME_ISOLATION_INPUT: ${{ inputs.home_isolation }}

        PS_PLATFORM_REPO_INPUT: ${{ inputs.platform_repo }}
        PS_PLATFORM_REF_INPUT: ${{ inputs.platform_ref }}
        PS_PLATFORM_PATH_INPUT: ${{ inputs.platform_path }}
        PS_SKIP_PLATFORM_INPUT: ${{ inputs.skip_platform_checkout }}
        PS_PLATFORM_FETCH_DEPTH_INPUT: ${{ inputs.platform_fetch_depth }}
        PS_PLATFORM_CLEAN_PATH_INPUT: ${{ inputs.platform_clean_path }}
        PS_PLATFORM_REQUIRE_PINNED_REF_INPUT: ${{ inputs.platform_require_pinned_ref }}
        PS_PLATFORM_ALLOWLIST_INPUT: ${{ inputs.platform_allowed_repositories }}

        PS_INSTALL_TOOLS_INPUT: ${{ inputs.install_tools }}
        PS_TOOLS_BUNDLE_INPUT: ${{ inputs.tools_bundle }}
      run: |
        set -euo pipefail
        bash "${GITHUB_WORKSPACE}/tools/scripts/actions/ps-bootstrap/ps-initialize-environment/ps-bootstrap-validate-init.sh"

    # -----------------------------------------------------------------------------
    # PHASE 3: CHECKOUT REPOSITORY
    # Logic: Deterministic repo checkout (validated fetch depth).
    # Dependency: Git client
    # -----------------------------------------------------------------------------
    - name: "Section: Checkout repo (PS)"
      shell: bash
      run: |
        # [PS.INIT.CHECKOUT] --------------------------------------------------------
        # Intent: Execute deterministic repository checkout with validated inputs.
        # Safety: set -euo pipefail (Strict mode enabled)
        # ----------------------------------------------------------------------------
        set -euo pipefail
        # shellcheck source=tools/scripts/branding/format.sh
        . "${GITHUB_WORKSPACE}/tools/scripts/branding/format.sh" || true
        if type -t ps_rule >/dev/null 2>&1; then
          ps_rule
        fi

    - name: Checkout repo (PS)
      uses: ./.github/actions/ps-bootstrap/ps-checkout-source
      with:
        fetch_depth: ${{ env.PS_FETCH_DEPTH_VALIDATED }}
        ref: ${{ inputs.checkout_ref }}

    # -----------------------------------------------------------------------------
    # Optional: Detect pre-downloaded platform snapshot when checkout is skipped.
    # -----------------------------------------------------------------------------
    - name: Detect platform snapshot (PS)
      if: ${{ env.PS_SKIP_PLATFORM_VALIDATED == '1' }}
      shell: bash
      env:
        PS_PLATFORM_SNAPSHOT_PATH: ${{ env.PS_PLATFORM_PATH_VALIDATED }}
      run: |
        snapshot_script="${GITHUB_WORKSPACE}/tools/scripts/actions/ps-bootstrap"
        snapshot_script="${snapshot_script}/ps-bootstrap-detect-platform-snapshot.sh"
        bash "${snapshot_script}"

    # -----------------------------------------------------------------------------
    # PHASE 4: HOME ISOLATION
    # Logic: Create and switch to isolated HOME to contain job artifacts.
    # -----------------------------------------------------------------------------
    - name: Prepare HOME isolation (PS)
      id: ps_home
      if: ${{ env.PS_HOME_ISOLATION_VALIDATED == '1' }}
      shell: bash
      run: |
        set -euo pipefail
        bash "${GITHUB_WORKSPACE}/tools/scripts/actions/ps-bootstrap/ps-initialize-environment/ps-init-prepare-home.sh"

    # =========================================================================
    # 5) CHECKOUT PLATFORM (OPTIONAL)
    # =========================================================================
    - name: "Section: Checkout platform (PS)"
      if: ${{ env.PS_SKIP_PLATFORM_VALIDATED == '0' }}
      shell: bash
      run: |
        # [PS.INIT.PLATFORM] -------------------------------------------------------
        # Intent: Prepare environment and validate platform checkout inputs.
        # Safety: set -euo pipefail (Strict mode enabled)
        # ----------------------------------------------------------------------------
        set -euo pipefail
        # shellcheck source=tools/scripts/branding/format.sh
        . "${GITHUB_WORKSPACE}/tools/scripts/branding/format.sh" || true
        if type -t ps_rule >/dev/null 2>&1; then
          ps_rule
        fi

    - name: Checkout platform (PS)
      if: ${{ env.PS_SKIP_PLATFORM_VALIDATED == '0' }}
      uses: ./.github/actions/ps-bootstrap/ps-checkout-platform
      with:
        repository: ${{ env.PS_PLATFORM_REPO_VALIDATED }}
        ref: ${{ env.PS_PLATFORM_REF_VALIDATED }}
        path: ${{ env.PS_PLATFORM_PATH_VALIDATED }}
        fetch_depth: ${{ env.PS_PLATFORM_FETCH_DEPTH_VALIDATED }}
        clean_path: >-
          ${{ env.PS_PLATFORM_CLEAN_PATH_VALIDATED == '1' && 'true' || 'false' }}
        require_pinned_ref: >-
          ${{ env.PS_PLATFORM_REQUIRE_PINNED_REF_VALIDATED == '1' && 'true' || 'false' }}
        allowed_repositories: ${{ env.PS_PLATFORM_ALLOWLIST_VALIDATED }}
        require_full_history: "false"
        persist_credentials: "false"
        submodules: "false"

    - name: Export PS_PLATFORM_ROOT (PS)
      if: ${{ env.PS_SKIP_PLATFORM_VALIDATED == '0' }}
      shell: bash
      run: |
        # [PS.INIT.EXPORT] ---------------------------------------------------------
        # Intent: Export the resolved platform root into the environment for later steps.
        # Safety: set -euo pipefail (Strict mode enabled)
        # ----------------------------------------------------------------------------
        set -euo pipefail
        # shellcheck source=tools/scripts/core/gha-helpers.sh
        . "${GITHUB_WORKSPACE}/tools/scripts/core/gha-helpers.sh"
        platform_abs="${GITHUB_WORKSPACE}/${PS_PLATFORM_PATH_VALIDATED}"
        emit_env "PS_PLATFORM_ROOT" "${platform_abs}"
        printf 'PS.INIT: PS_PLATFORM_ROOT=%s\n' "${platform_abs}"

    # =========================================================================
    # 6) INSTALL TOOLS (OPTIONAL)
    # =========================================================================
    - name: "Section: Install tools (PS)"
      if: >-
        ${{ env.PS_INSTALL_TOOLS_VALIDATED == '1' && env.PS_TOOLS_BUNDLE_VALIDATED != 'none' }}
      shell: bash
      run: |
        # [PS.INIT.INSTALL] --------------------------------------------------------
        # Intent: Install canonical tool bundles if requested by validated inputs.
        # Safety: set -euo pipefail (Strict mode enabled)
        # ----------------------------------------------------------------------------
        set -euo pipefail
        # shellcheck source=tools/scripts/branding/format.sh
        . "${GITHUB_WORKSPACE}/tools/scripts/branding/format.sh" || true
        if type -t ps_rule >/dev/null 2>&1; then
          ps_rule
        fi

    - name: Install canonical tools (PS)
      if: >-
        ${{ env.PS_INSTALL_TOOLS_VALIDATED == '1' && env.PS_TOOLS_BUNDLE_VALIDATED != 'none' }}
      uses: ./.github/actions/ps-bootstrap/ps-tools
      with:
        bundle: ${{ env.PS_TOOLS_BUNDLE_VALIDATED }}

    # =========================================================================
    # OUTPUTS
    # =========================================================================
    - name: Emit outputs (PS)
      id: ps_init_outputs
      shell: bash
      env:
        PS_HOME_ABS: ${{ steps.ps_home.outputs.home_abs }}
      run: |
        set -euo pipefail
        bash "${GITHUB_WORKSPACE}/tools/scripts/actions/ps-bootstrap/ps-initialize-environment/ps-init-emit-outputs.sh"
