# ==============================================================================
# Political Sphere — Composite Action: PS Bootstrap Standard
# License: Proprietary
# ==============================================================================
# ps_header_v: 6
#
# ─────────────────────────────────────────────────────────────────────────────
# IDENTITY
# ─────────────────────────────────────────────────────────────────────────────
# meta:
#   file_id: .github/actions/ps-bootstrap/ps-setup-standard/action.yml
#   file_type: action
#   language: yaml
#   version: 1.0.0
#   status: active
#   classification: internal
#   owner: political-sphere
#   last_editor: codex
#
# ─────────────────────────────────────────────────────────────────────────────
# LIFECYCLE & CHANGE CONTROL
# ─────────────────────────────────────────────────────────────────────────────
#   lifecycle:
#     created: 2025-12-28
#     last_updated: 2026-01-03
#     last_updated_mode: manual
#     review_cycle: 6 months
#     change_control: lightweight
#
# ─────────────────────────────────────────────────────────────────────────────
# CONTEXT
# ─────────────────────────────────────────────────────────────────────────────
# context:
#   parent_system: CI/CD Platform
#   initiative: Hardened CI
#
# ─────────────────────────────────────────────────────────────────────────────
# GOVERNANCE
# ─────────────────────────────────────────────────────────────────────────────
# governance:
#   intent: Provide the PS Bootstrap Standard composite action as a convenience
#     wrapper for ps-init and ps-node with standardized defaults and environment
#     setup.
#   guarantees:
#     - Defines inputs and outputs for consistent downstream usage.
#     - Executes the composite steps declared in this action.
#     - Uses pinned external actions when referenced.
#   prohibitions:
#     - Does not grant permissions beyond the invoking workflow.
#     - Does not assume network access beyond runner policy.
#
# ─────────────────────────────────────────────────────────────────────────────
# INTERFACES
# ─────────────────────────────────────────────────────────────────────────────
# interfaces:
#   inputs: [fetch_depth, checkout_ref, node_version, cache, install_dependencies,
#     platform_ref, platform_require_pinned_ref, egress_policy, working_directory,
#     cache_dependency_path, full_scan, install_tools, tools_bundle, skip_node,
#     skip_platform_checkout]
#   outputs: [none]
#   exit_codes: [0=success, 1=failure]
#
# ─────────────────────────────────────────────────────────────────────────────
# EXECUTION
# ─────────────────────────────────────────────────────────────────────────────
# execution:
#   invocation: Used as a composite action step in GitHub Actions workflows.
#   example_invocation: >-
#     uses: ./.github/actions/ps-bootstrap/ps-setup-standard
#   model: deterministic
#   idempotency: not guaranteed
#
# ─────────────────────────────────────────────────────────────────────────────
# DEPENDENCIES
# ─────────────────────────────────────────────────────────────────────────────
# dependencies:
#   internal: [.github/actions/ps-bootstrap/ps-initialize-environment,
#     .github/actions/ps-bootstrap/ps-node]
#   external: [bash]
#
# ─────────────────────────────────────────────────────────────────────────────
# SECURITY & POLICY
# ─────────────────────────────────────────────────────────────────────────────
# security:
#   permissions: [none]
#   secrets: [NODE_AUTH_TOKEN]
#   network: restricted; depends on runner policy
#   policy_enforcement: [configs/ci/policies/allowed-actions.yml,
#     configs/ci/policies/action-pinning.yml,
#     configs/ci/policies/inline-bash.yml,
#     configs/ci/policies/section-headers.yml]
#
# ─────────────────────────────────────────────────────────────────────────────
# OPERATIONS
# ─────────────────────────────────────────────────────────────────────────────
# ops:
#   failure_modes: Step failures or validation errors surface as non-zero exits.
#   observability: Step logs are emitted in the GitHub Actions job output.
#   performance: Seconds to minutes depending on repo size and workload.
#
# ─────────────────────────────────────────────────────────────────────────────
# RISKS
# ─────────────────────────────────────────────────────────────────────────────
# risks:
#   assumptions:
#     - Inputs are provided as documented.
#     - Runner has required tooling for declared steps.
#   known_risks:
#     - Network or platform outages can interrupt execution.
#
# ─────────────────────────────────────────────────────────────────────────────
# RELATED
# ─────────────────────────────────────────────────────────────────────────────
# related:
#   references:
#     - .github/actions/ps-bootstrap/README.md
#     - .github/actions/ps-bootstrap/ps-initialize-environment/action.yml
#     - .github/actions/ps-bootstrap/ps-node/action.yml
#
# ==============================================================================

name: "PS Bootstrap Standard"
description: "Standardized bootstrap setup with common defaults and environment initialization"

inputs:
  fetch_depth:
    description: "Git fetch depth (1 = shallow, 0 = full history)"
    required: false
    default: "1"

  checkout_ref:
    description: "Git ref to checkout"
    required: false
    default: ""

  node_version:
    description: "Node.js major version"
    required: false
    default: "22"

  cache:
    description: "Enable dependency caching (1 = on, 0 = off)"
    required: false
    default: "1"

  install_dependencies:
    description: "Install dependencies (1 = on, 0 = off)"
    required: false
    default: "1"

  platform_ref:
    description: "Platform repository ref"
    required: false
    default: "f6eac5049f626a672c84f3899f0572a87af07ca1"

  platform_require_pinned_ref:
    description: "Require platform_ref to be a full 40-char commit SHA"
    required: false
    default: "true"

  egress_policy:
    description: "Network egress policy (audit|enforce|off)"
    required: false
    default: "audit"

  working_directory:
    description: "Working directory for setup"
    required: false
    default: "."

  cache_dependency_path:
    description: "Path to dependency lock file"
    required: false
    default: "package-lock.json"

  full_scan:
    description: "Enable full scan mode (1 = on, 0 = off)"
    required: false
    default: "0"

  install_tools:
    description: "Install platform tools (1 = on, 0 = off)"
    required: false
    default: "0"

  tools_bundle:
    description: "Tools bundle to install (none|lint|security|all)"
    required: false
    default: "none"

  skip_node:
    description: "Skip Node.js setup (1 = skip, 0 = setup). Use when only ps-init is needed."
    required: false
    default: "0"

  skip_platform_checkout:
    description: "Skip platform checkout (true|false)"
    required: false
    default: "false"

runs:
  using: "composite"
  steps:
    - name: Job setup (PS)
      uses: ./.github/actions/ps-bootstrap/ps-initialize-environment
      with:
        fetch_depth: ${{ inputs.fetch_depth }}
        checkout_ref: ${{ inputs.checkout_ref }}
        egress_policy: ${{ inputs.egress_policy }}
        home_dir: ".home"
        platform_repo: PoliticalSphere/ci
        platform_ref: ${{ inputs.platform_ref }}
        platform_path: ".ps-platform"
        platform_allowed_repositories: PoliticalSphere/ci
        platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}
        skip_platform_checkout: ${{ inputs.skip_platform_checkout }}
        install_tools: ${{ inputs.install_tools }}
        tools_bundle: ${{ inputs.tools_bundle }}

    - name: Node setup (PS)
      if: ${{ inputs.skip_node != '1' }}
      uses: ./.github/actions/ps-bootstrap/ps-node
      with:
        node_version: ${{ inputs.node_version }}
        cache: ${{ inputs.cache }}
        install_dependencies: ${{ inputs.install_dependencies }}
        working_directory: ${{ inputs.working_directory }}
        cache_dependency_path: ${{ inputs.cache_dependency_path }}

    - name: Environment setup (PS)
      shell: bash
      run: |
        set -euo pipefail
        {
          echo "CI=1"
          echo "PS_PLATFORM_ROOT=${{ github.workspace }}/.ps-platform"
          [[ -n "${{ secrets.NODE_AUTH_TOKEN }}" ]] && echo "NODE_AUTH_TOKEN=${{ secrets.NODE_AUTH_TOKEN }}"
          [[ "${{ inputs.full_scan }}" == "1" ]] && echo "PS_FULL_SCAN=1"
        } >> "$GITHUB_ENV"

    - name: Complete (PS)
      shell: bash
      run: |
        set -euo pipefail
        printf 'PS.BOOTSTRAP.STANDARD: OK\n'
