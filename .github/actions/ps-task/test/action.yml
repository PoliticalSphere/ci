# ==============================================================================
# Political Sphere — Composite Action: Test (ps-task adapter)
# ------------------------------------------------------------------------------
# Purpose:
#   Run deterministic unit tests via PS Task Runner with standardized output.
#
# Notes:
#   - Thin adapter: delegates execution/logging/reporting to ps-run.
#   - Exposes minimal knobs (script/workdir/coverage expectations).
# ==============================================================================

name: "Test"
description: "Run deterministic unit tests with standardized PS reporting"

inputs:
  script:
    description: "Test script path (repo-relative)"
    required: false
    default: "tools/scripts/actions/ps-test/test.sh"

  working_directory:
    description: "Working directory to run from (repo-relative)"
    required: false
    default: "."

  ps_full_scan:
    description: "Enable strict/full scan behaviour (0|1)"
    required: false
    default: "1"

  # Optional “evidence expectations” toggles: keep strictness intentional.
  expect_coverage:
    description: "Fail if coverage artifacts are missing (0|1)"
    required: false
    default: "0"

  expect_test_results:
    description: "Fail if JUnit/XML test results are missing (0|1)"
    required: false
    default: "0"

  min_coverage:
    description: "Minimum coverage percentage required (0-100)"
    required: false
    default: "80"

  shard_index:
    description: "Shard index for test splitting (1-based)"
    required: false
    default: "1"

  shard_total:
    description: "Total shards for test splitting"
    required: false
    default: "1"

runs:
  using: "composite"
  steps:
    - name: Run unit tests (PS)
      uses: ./.github/actions/ps-task/ps-run
      with:
        id: "test.unit"
        title: "Unit tests"
        description: "Deterministic unit tests"
        script: ${{ inputs.script }}
        working_directory: ${{ inputs.working_directory }}

        require_files: |
          ${{ inputs.script }}

        # Evidence: always expect standard logs/reports.
        # Coverage and JUnit are opt-in strictness (some repos legitimately won’t emit them).
        artifact_paths: |
          reports/**
          logs/**
          ${{ inputs.expect_coverage == '1' && 'coverage/**' || '' }}
          ${{ inputs.expect_coverage == '1' && 'reports/coverage/**' || '' }}
          ${{ inputs.expect_coverage == '1' && 'playwright-report/**' || '' }}
          ${{ inputs.expect_coverage == '1' && 'test-results/**' || '' }}
          ${{ inputs.expect_test_results == '1' && 'reports/**/junit*.xml' || '' }}
          ${{ inputs.expect_test_results == '1' && 'reports/**/junit.xml' || '' }}
          ${{ inputs.expect_test_results == '1' && 'test-results/**/*.xml' || '' }}

        env_kv: |
          CI=1
          PS_FULL_SCAN=${{ inputs.ps_full_scan }}
          PS_MIN_COVERAGE=${{ inputs.min_coverage }}
          PS_TEST_SHARD=${{ inputs.shard_index }}/${{ inputs.shard_total }}
          PS_TEST_JUNIT=${{ inputs.expect_test_results == '1' && '1' || '0' }}
          PS_TEST_JUNIT_PATH=${{ inputs.expect_test_results == '1' && 'reports/junit.xml' || '' }}

        continue_on_error: "0"
        allow_args: "0"
