# ==============================================================================
# Political Sphere â€” Composite Action: CI Validate
# ------------------------------------------------------------------------------
# Purpose:
#   Execute the Validate-CI policy checks for this repository.
#
# Metadata:
#   - Created: 2025-12-20
#   - Last updated: 2025-12-20
#
# Scope & Responsibilities:
#   - Does: run the Validate-CI script with platform configs.
#   - Does NOT: run lint/test/build or security scans.
#
# Design Principles:
#   - Deterministic and non-interactive execution
#   - CI-safe behavior with clear failures
#   - Explicit configuration paths
#
# Dependencies:
#   - ./.github/actions/ps-banner
#   - tools/scripts/ci/validate-ci/index.js
#   - configs/ci/policies/validate-ci.yml
#
# Dependents:
#   - ./.github/workflows/validate-ci.yml
#
# Execution Model:
#   - Trigger: N/A (invoked by workflow steps)
#   - Type: composite action (internal-only)
#   - Invoked by: Validate-CI reusable workflow
#
# Security & Policy Notes:
#   - Secrets: none
#   - Permissions: inherited from the caller (read-only expected)
#   - Constraints: requires Node.js available on PATH
#
# Operational Notes:
#   - Timeouts: controlled by the calling job
#   - Artifacts: produced by the Validate-CI script
#   - CI vs local: same execution; script handles bootstrap mode
# ==============================================================================

name: "CI Validate"
description: "Runs the Validate-CI policy gate"

inputs: {}

runs:
  using: "composite"
  steps:
    - name: Print banner
      uses: ./.github/actions/ps-banner

    - name: Run Validate-CI gate
      shell: bash
      run: |
        set -euo pipefail

        if ! command -v node >/dev/null 2>&1; then
          echo "ERROR: node is required but not found on PATH" >&2
          exit 1
        fi

        echo "DEBUG: GITHUB_WORKSPACE=${GITHUB_WORKSPACE}"
        echo "DEBUG: GITHUB_ACTION_PATH=${GITHUB_ACTION_PATH}"
        echo "DEBUG: PS_PLATFORM_ROOT=${PS_PLATFORM_ROOT:-<unset>}"
        ls -la "${GITHUB_WORKSPACE}" || true
        if [[ -n "${PS_PLATFORM_ROOT:-}" ]]; then
          ls -la "${PS_PLATFORM_ROOT}" || true
        fi
        ls -la "${GITHUB_WORKSPACE}/.ps-platform" || true

        action_root="${GITHUB_ACTION_PATH}"
        platform_root="${PS_PLATFORM_ROOT:-${GITHUB_WORKSPACE}/.ps-platform}"
        echo "DEBUG: platform_root=${platform_root}"
        if [[ ! -d "${platform_root}" ]]; then
          echo "ERROR: platform_root directory not found: ${platform_root}" >&2
          echo "HINT: ensure the workflow checks out the platform repo into .ps-platform and exports PS_PLATFORM_ROOT." >&2
          exit 1
        fi

        validator="${platform_root}/tools/scripts/ci/validate-ci/index.js"
        if [[ ! -f "${validator}" ]]; then
          echo "ERROR: validate-ci script not found at ${validator}" >&2
          exit 1
        fi

        config_path="${platform_root}/configs/ci/policies/validate-ci.yml"
        if [[ ! -f "${config_path}" ]]; then
          echo "ERROR: validate-ci config not found at ${config_path}" >&2
          exit 1
        fi

        echo "PS.CI_VALIDATE: platform_root=${platform_root}"
        echo "PS.CI_VALIDATE: config_path=${config_path}"

        export PS_PLATFORM_ROOT="${platform_root}"
        export PS_VALIDATE_CI_CONFIG="${config_path}"
        node "${validator}"
        echo "PS.CI_VALIDATE: OK"
