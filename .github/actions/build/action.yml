# ==============================================================================
# Political Sphere â€” Composite Action: Build
# ------------------------------------------------------------------------------
# Purpose:
#   Run the deterministic build step with platform defaults.
#
# Metadata:
#   - Created: 2025-12-20
#   - Last updated: 2025-12-20
#
# Scope & Responsibilities:
#   - Does: execute the build script in the configured working directory.
#   - Does NOT: install dependencies or run tests.
#
# Design Principles:
#   - Deterministic and non-interactive execution
#   - CI-safe logging via ps-run
#   - Explicit inputs for script and working directory
#
# Dependencies:
#   - ./.github/actions/ps-run
#   - tools/scripts/tasks/build.sh (default)
#
# Dependents:
#   - ./.github/workflows/pr-gates.yml
#   - ./.github/workflows/build-artifacts.yml
#
# Execution Model:
#   - Trigger: N/A (invoked by workflow steps)
#   - Type: composite action (internal-only)
#   - Invoked by: PR gates and build-artifacts workflows
#
# Security & Policy Notes:
#   - Secrets: optional NODE_AUTH_TOKEN (passed by caller if needed)
#   - Permissions: inherited from the caller (read-only expected)
#   - Constraints: build script must exist in the repository
#
# Operational Notes:
#   - Timeouts: controlled by the calling job
#   - Artifacts: produced by the build script (if any)
#   - CI vs local: same build script used locally
# ==============================================================================

name: "Build (PS)"
description: "Run deterministic build steps via ps-run"

inputs:
  id:
    description: "Stable step id used by ps-run for logs/reports"
    required: false
    default: "build"

  title:
    description: "Human-readable title for reporting"
    required: false
    default: "Build"

  description:
    description: "Short description for reporting"
    required: false
    default: "Deterministic build"

  working-directory:
    description: "Working directory to run the build from (repo-relative)"
    required: false
    default: "."

  script:
    description: "Build script path (repo-relative)"
    required: false
    default: "tools/scripts/tasks/build.sh"

  # Optional: allow callers to pass args through to the script (space-separated).
  # If you need structured args, prefer implementing parsing inside the script.
  args:
    description: "Optional arguments to pass to the build script (space-separated)"
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - name: Validate inputs: script
      if: ${{ inputs.script == '' }}
      shell: bash
      run: |
        echo "ERROR: inputs.script is required." >&2
        exit 1

    - name: Validate inputs: working-directory
      if: ${{ inputs.working-directory == '' }}
      shell: bash
      run: |
        echo "ERROR: inputs.working-directory is required." >&2
        exit 1

    - name: Log config (build)
      shell: bash
      env:
        PS_WORKING_DIR: ${{ inputs.working-directory }}
        PS_SCRIPT: ${{ inputs.script }}
      run: |
        set -euo pipefail
        printf 'PS.BUILD: working-directory=%s\n' "$PS_WORKING_DIR"
        printf 'PS.BUILD: script=%s\n' "$PS_SCRIPT"

    - name: Run build (PS)
      uses: ./.github/actions/ps-run
      with:
        id: ${{ inputs.id }}
        title: ${{ inputs.title }}
        description: ${{ inputs.description }}
        working-directory: ${{ inputs.working-directory }}
        script: ${{ inputs.script }}
        args: ${{ inputs.args }}

    - name: Build complete
      shell: bash
      run: |
        echo "PS.BUILD: OK"

