# ==============================================================================
# Political Sphere â€” Composite Action: Build
# ------------------------------------------------------------------------------
# Purpose:
#   Run the deterministic build step with platform defaults.
#
# Metadata:
#   - id: build
#   - version: 1.0.0
#   - owner: political-sphere
#   - classification: internal
#   - Created: 2025-12-20
#   - Last updated: 2025-12-24
# Scope & Responsibilities:
#   - Does: execute the build script in the configured working directory.
#   - Does NOT: install dependencies, run tests, or modify permissions.
#
# Design Principles:
#   - Deterministic and non-interactive execution
#   - CI-safe logging via ps-run
#   - Strong input validation (paths, existence, traversal)
#   - Minimal policy surface (caller chooses script/WD explicitly)
#
# Dependencies:
#   - ./.github/actions/ps-run
#   - tools/scripts/tasks/build.sh (default)
#   - tools/scripts/branding/print-section.sh (optional, for UX)
#
# ==============================================================================

name: "Build (PS)"
description: "Run deterministic build steps via ps-run"

inputs:
  id:
    description: "Stable step id used by ps-run for logs/reports (kebab-case recommended)"
    required: false
    default: "build"

  title:
    description: "Human-readable title for reporting"
    required: false
    default: "Build"

  description:
    description: "Short description for reporting"
    required: false
    default: "Deterministic build"

  working-directory:
    description: "Working directory to run the build from (repo-relative)"
    required: false
    default: "."

  script:
    description: "Build script path (repo-relative)"
    required: false
    default: "tools/scripts/tasks/build.sh"

  args:
    description: "Optional arguments to pass to the build script (space-separated). Prefer parsing inside the script."
    required: false
    default: ""

  allow_args:
    description: "Allow passing args through (1 = allow, 0 = deny). Deny strengthens determinism."
    required: false
    default: "1"

runs:
  using: "composite"
  steps:
    # --------------------------------------------------------------------------
    # Validate inputs once, strongly (paths, existence, traversal)
    # --------------------------------------------------------------------------
    - name: Validate inputs (build)
      shell: bash
      env:
        PS_ID: ${{ inputs.id }}
        PS_TITLE: ${{ inputs.title }}
        PS_DESC: ${{ inputs.description }}
        PS_WD: ${{ inputs.working-directory }}
        PS_SCRIPT: ${{ inputs.script }}
        PS_ARGS: ${{ inputs.args }}
        PS_ALLOW_ARGS: ${{ inputs.allow_args }}
      run: |
        set -euo pipefail

        fail() { echo "ERROR: $*" >&2; exit 1; }

        # Required-ish: non-empty strings
        [[ -n "${PS_ID}" ]] || fail "inputs.id must not be empty"
        [[ -n "${PS_TITLE}" ]] || fail "inputs.title must not be empty"
        [[ -n "${PS_DESC}" ]] || fail "inputs.description must not be empty"
        [[ -n "${PS_WD}" ]] || fail "inputs.working-directory must not be empty"
        [[ -n "${PS_SCRIPT}" ]] || fail "inputs.script must not be empty"

        # Boolean validation
        [[ "${PS_ALLOW_ARGS}" == "0" || "${PS_ALLOW_ARGS}" == "1" ]] || fail "inputs.allow_args must be '0' or '1'"

        # Determinism: optionally deny args
        if [[ "${PS_ALLOW_ARGS}" == "0" && -n "${PS_ARGS}" ]]; then
          fail "args provided but inputs.allow_args=0 (denied)"
        fi

        # Prevent path traversal / absolute paths (repo-relative only)
        case "${PS_WD}" in
          /*) fail "working-directory must be repo-relative, not absolute: ${PS_WD}" ;;
          *".."*) fail "working-directory must not contain '..': ${PS_WD}" ;;
        esac
        case "${PS_SCRIPT}" in
          /*) fail "script must be repo-relative, not absolute: ${PS_SCRIPT}" ;;
          *".."*) fail "script must not contain '..': ${PS_SCRIPT}" ;;
        esac

        # Existence checks (action should fail fast and clearly)
        [[ -d "${GITHUB_WORKSPACE}/${PS_WD}" ]] || fail "working-directory does not exist: ${PS_WD}"
        [[ -f "${GITHUB_WORKSPACE}/${PS_SCRIPT}" ]] || fail "script not found: ${PS_SCRIPT}"

        # Optional: sanity check ID format (soft guardrail)
        if ! [[ "${PS_ID}" =~ ^[a-z0-9]+([a-z0-9-]*[a-z0-9])?$ ]]; then
          printf 'WARN: inputs.id is not kebab-case safe: %s\n' "${PS_ID}" >&2
        fi

        # UX section header if platform branding exists
        section_sh="${GITHUB_WORKSPACE}/tools/scripts/branding/print-section.sh"
        if [[ -f "${section_sh}" ]]; then
          bash "${section_sh}" "build.config" "Build configuration"
        fi

        printf 'PS.BUILD: id=%s\n' "${PS_ID}"
        printf 'PS.BUILD: title=%s\n' "${PS_TITLE}"
        printf 'PS.BUILD: working-directory=%s\n' "${PS_WD}"
        printf 'PS.BUILD: script=%s\n' "${PS_SCRIPT}"
        if [[ -n "${PS_ARGS}" ]]; then
          printf 'PS.BUILD: args=%s\n' "${PS_ARGS}"
        else
          printf 'PS.BUILD: args=<none>\n'
        fi

    # --------------------------------------------------------------------------
    # Validate paths (reusable)
    # --------------------------------------------------------------------------
    - name: Validate paths (build)
      uses: ./.github/actions/validate-paths
      with:
        working-directory: ${{ inputs.working-directory }}
        script: ${{ inputs.script }}

    # --------------------------------------------------------------------------
    # Execute via ps-run for consistent logs/reports
    # --------------------------------------------------------------------------
    - name: Run build (PS)
      uses: ./.github/actions/ps-run
      with:
        id: ${{ inputs.id }}
        title: ${{ inputs.title }}
        description: ${{ inputs.description }}
        working-directory: ${{ inputs.working-directory }}
        script: ${{ inputs.script }}
        args: ${{ inputs.args }}

    - name: Build complete
      shell: bash
      run: |
        echo "PS.BUILD: OK"
