# ==============================================================================
# Political Sphere â€” Release (Caller)
# ==============================================================================
#
# METADATA
# ------------------------------------------------------------------------------
# id: release
# version: 1.0.0
# owner: political-sphere
# classification: internal
#
# PURPOSE
# ------------------------------------------------------------------------------
# Caller workflow that delegates to _reusable-release.yml for
# version tagging and GitHub release creation.
#
#
# SCOPE & RESPONSIBILITIES
# ------------------------------------------------------------------------------
# DOES:
#   - Invoke _reusable-release.yml with caller inputs
#   - Pass through release configuration (version, tag, notes)
#
# DOES NOT:
#   - Create releases directly
#   - Publish packages or deploy artifacts
#
#
# DEPENDENCIES
# ------------------------------------------------------------------------------
# - ./.github/workflows/_reusable-release.yml
#
#
# EXECUTION MODEL
# ------------------------------------------------------------------------------
# - Trigger: workflow_call (internal reusable)
# - Single job: delegates to _reusable-release.yml
#
#
# SECURITY & POLICY NOTES
# ------------------------------------------------------------------------------
# - Permissions: minimal (contents: read)
# - Platform ref must be SHA-pinned for supply chain security
#
# ==============================================================================

name: Release

on:
  workflow_call:
    
    # ==========================================================================
    # RUNTIME & ENVIRONMENT CONFIGURATION
    # ==========================================================================
    inputs:
      runner:
        description: "Runner label"
        required: false
        default: "ubuntu-22.04"
        type: string

      node_version:
        description: "Node.js major version"
        required: false
        default: "22"
        type: string

      fetch_depth:
        description: "Git fetch depth (1 = shallow, 0 = full history)"
        required: false
        default: 0
        type: number

      retention_days:
        description: "Artifact retention in days for release evidence"
        required: false
        default: 7
        type: number

      # ==========================================================================
      # RELEASE MODE
      # ==========================================================================
      dry_run:
        description: "If true, validate + plan only (no tag/release mutation)"
        required: false
        default: false
        type: boolean

      # ==========================================================================
      # RELEASE CONFIGURATION
      # ==========================================================================
      release_version:
        description: "Release version (SemVer, without leading v)"
        required: true
        type: string

      release_ref:
        description: "Git ref to release from (branch name or full SHA)"
        required: true
        type: string

      # ==========================================================================
      # RELEASE NOTES
      # ==========================================================================
      generate_notes:
        description: "Auto-generate GitHub release notes (if no custom notes provided)"
        required: false
        default: true
        type: boolean

      release_title:
        description: "Optional release title (defaults to v<release_version>)"
        required: false
        default: ""
        type: string

      release_notes:
        description: "Optional inline release notes (overrides generate_notes)"
        required: false
        default: ""
        type: string

      release_notes_path:
        description: "Optional repo-relative path to release notes file (overrides generate_notes)"
        required: false
        default: ""
        type: string

      # ==========================================================================
      # PLATFORM & SHARED TOOLING
      # ==========================================================================
      platform_ref:
        description: "Platform repo ref to checkout for shared scripts/configs"
        type: string
        required: false
        default: "f6eac5049f626a672c84f3899f0572a87af07ca1"

      platform_require_pinned_ref:
        description: "Require platform_ref to be a full 40-char commit SHA (true|false)"
        type: string
        required: false
        default: "true"

# ==============================================================================
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ==============================================================================
permissions:
  contents: read

jobs:
  call:
    name: Release
    uses: ./.github/workflows/_reusable-release.yml
    # -------------------------------------------------------------------------
    # Justification: contents: write required to create tags and GitHub releases.
    # Risk decision: docs/risk-decisions.md#rd-release-permissions
    # -------------------------------------------------------------------------
    permissions:
      contents: write  # Justification: create tags and releases
    with:
      runner: ${{ inputs.runner }}
      node_version: ${{ inputs.node_version }}
      fetch_depth: ${{ inputs.fetch_depth }}
      retention_days: ${{ inputs.retention_days }}
      dry_run: ${{ inputs.dry_run }}
      release_version: ${{ inputs.release_version }}
      release_ref: ${{ inputs.release_ref }}
      generate_notes: ${{ inputs.generate_notes }}
      release_title: ${{ inputs.release_title }}
      release_notes: ${{ inputs.release_notes }}
      release_notes_path: ${{ inputs.release_notes_path }}
      platform_ref: ${{ inputs.platform_ref }}
      platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}
