# ══════════════════════════════════════════════════════════════════════════════
# Validate CI — CI policy gate (SHA pinning, permissions, patterns)
# ══════════════════════════════════════════════════════════════════════════════
#
# Enforces CI policy compliance. MUST run first in all workflows.
# Blocks downstream jobs on policy violations.
#
# Docs: .github/workflows/README.md#validate-ci
# Refs: configs/ci/policies/, docs/ci-policy-governance.md
#
# Risks:
#   • Policy validation failure blocks all downstream jobs
#   • Remote SHA verification requires network access
#
# ══════════════════════════════════════════════════════════════════════════════

name: Validate CI

on:
  workflow_call:

    # ==========================================================================
    # RUNTIME & ENVIRONMENT CONFIGURATION
    # ==========================================================================
    inputs:
      runner:
        description: "Runner label"
        type: string
        required: false
        default: "ubuntu-22.04"

      node_version:
        description: "Node.js major version"
        type: string
        required: false
        default: "22"

      fetch_depth:
        description: "Git fetch depth (1 = shallow, 0 = full history)"
        type: number
        required: false
        default: 1

      cache:
        description: "Enable dependency caching (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

      validate_timeout_minutes:
        description: "Timeout for Validate-CI job in minutes"
        type: number
        required: false
        default: 10

      # ==========================================================================
      # CHECKOUT TARGET
      # ==========================================================================
      checkout_ref:
        description: "Optional git ref to validate (branch, tag, or SHA)"
        type: string
        required: false
        default: ""

      # ==========================================================================
      # PLATFORM VERSIONING
      # ==========================================================================
      platform_ref:
        description: "Platform repo ref to checkout for shared scripts/configs"
        type: string
        required: false
        default: "f6eac5049f626a672c84f3899f0572a87af07ca1"

      platform_require_pinned_ref:
        description: "Require platform_ref to be a full 40-char commit SHA (true|false)"
        type: string
        required: false
        default: "true"

      # ==========================================================================
      # DEPENDENCY INSTALLATION CONTROLS
      # ==========================================================================
      install_dependencies:
        description: "Install dependencies in the target repo (1 = on, 0 = off)"
        type: string
        required: false
        default: "0"

      install_platform_dependencies:
        description: "Install dependencies in the platform repo (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

      # ==========================================================================
      # VALIDATION BEHAVIOUR
      # ==========================================================================
      verify_remote_shas:
        description: "Verify action SHAs against upstream remotes (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

      pr_only:
        description: "Validate only workflows/actions changed in the PR (1 = on, 0 = off)"
        type: string
        required: false
        default: "0"

      pr_base_ref:
        description: "PR base SHA for diff-based validation"
        type: string
        required: false
        default: ""

      pr_head_ref:
        description: "PR head SHA for diff-based validation"
        type: string
        required: false
        default: ""

      # ==========================================================================
      # ARTIFACTS
      # ==========================================================================
      artifact_name:
        description: "Artifact name for validate-ci outputs"
        type: string
        required: false
        default: "validate-ci"

      retention_days:
        description: "Artifact retention in days"
        type: number
        required: false
        default: 7

    secrets:
      NODE_AUTH_TOKEN:
        description: "Optional token for private registry installs"
        required: false

# ==============================================================================
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ==============================================================================
permissions:
  contents: read

# ==============================================================================
# CONCURRENCY
# ------------------------------------------------------------------------------
# One validate-ci run per ref at a time (prevents duplicate policy gate work).
# ==============================================================================
concurrency:
  group: validate-ci-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: true

# ==============================================================================
# GLOBAL DEFAULTS
# ==============================================================================
defaults:
  run:
    shell: bash

# ==============================================================================
# GLOBAL ENVIRONMENT
# ==============================================================================
env:
  CI: "1"
  PS_PLATFORM_ROOT: ${{ github.workspace }}/.ps-platform

jobs:
  # ============================================================================
  # POLICY GATE — VALIDATE CI
  # ----------------------------------------------------------------------------
  # Blocking:
  #   Yes (callers should depend on this before running any other jobs)
  # ============================================================================
  validate-ci:
    name: Validate CI policy
    runs-on: ${{ inputs.runner }}
    timeout-minutes: ${{ inputs.validate_timeout_minutes }}
    permissions:
      contents: read  # Justification: checkout workflows and actions for validation
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
      PS_VALIDATE_CI_VERIFY_REMOTE: ${{ inputs.verify_remote_shas }}
      PS_VALIDATE_CI_PR_ONLY: ${{ inputs.pr_only }}
      PS_PR_BASE_SHA: ${{ inputs.pr_base_ref }}
      PS_PR_HEAD_SHA: ${{ inputs.pr_head_ref }}

    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          checkout_ref: ${{ inputs.checkout_ref }}
          node_version: ${{ inputs.node_version }}
          cache: ${{ inputs.cache }}
          install_dependencies: ${{ inputs.install_dependencies }}
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}

      - name: Install platform dependencies
        if: ${{ inputs.install_platform_dependencies == '1' }}
        uses: ./.github/actions/ps-task/ps-run
        with:
          id: install-platform-deps
          title: Install platform dependencies
          script: tools/scripts/workflows/ci/install-platform-deps.sh

      - name: Validate CI (policy)
        uses: ./.github/actions/ps-ci-validate

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: validate-ci
          summary_output_path: reports/summary/validate-ci.json
          summary_results: validate=${{ job.status }}
          artifacts_name: ${{ inputs.artifact_name }}
          artifacts_paths: |
            reports/**
            logs/**
          artifacts_if_no_files_found: "warn"
          artifacts_retention_days: ${{ inputs.retention_days }}
          # Note: GITHUB_TOKEN is optional; PR comment only when provided and pr_number set.
          # secrets:
          #  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
