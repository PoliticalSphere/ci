# ==============================================================================
# Political Sphere â€” Build Artifacts (Caller)
# ==============================================================================
#
# METADATA
# ------------------------------------------------------------------------------
# id: build-artifacts
# version: 1.0.0
# owner: political-sphere
# classification: internal
#
# PURPOSE
# ------------------------------------------------------------------------------
# Caller workflow that delegates to _reusable-build-artifacts.yml for
# deterministic build and artifact collection.
#
#
# SCOPE & RESPONSIBILITIES
# ------------------------------------------------------------------------------
# DOES:
#   - Invoke _reusable-build-artifacts.yml with caller inputs
#   - Pass through build configuration (script, working directory, artifacts)
#   - Support artifact retention and compression settings
#
# DOES NOT:
#   - Perform the build directly
#   - Run policy validation (handled by _reusable-build-artifacts.yml)
#   - Deploy or publish artifacts externally
#
#
# DEPENDENCIES
# ------------------------------------------------------------------------------
# - ./.github/workflows/_reusable-build-artifacts.yml
# - ./.github/workflows/validate-ci.yml (invoked by reusable as gate)
#
#
# EXECUTION MODEL
# ------------------------------------------------------------------------------
# - Trigger: workflow_call (internal reusable)
# - Single job: delegates to _reusable-build-artifacts.yml
# - Permissions: contents: read (for checkout and artifact collection)
#
#
# SECURITY & POLICY NOTES
# ------------------------------------------------------------------------------
# - Secrets: optional NODE_AUTH_TOKEN (npm installs only)
# - Permissions: minimal (contents: read)
# - Platform ref must be SHA-pinned for supply chain security
#
# ==============================================================================

name: Build Artifacts

on:
  workflow_call:
    # ==========================================================================
    # Runtime & Environment Configuration
    # ==========================================================================
    inputs:
      runner:
        description: "Runner label"
        type: string
        required: false
        default: "ubuntu-22.04"

      node_version:
        description: "Node.js major version"
        type: string
        required: false
        default: "22"

      cache:
        description: "Enable dependency caching (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

      fetch_depth:
        description: "Git fetch depth (1 = shallow, 0 = full history)"
        type: number
        required: false
        default: 1

      # ==========================================================================
      # PLATFORM TRUST & SECURITY
      # ==========================================================================
      platform_repository:
        description: "Platform repository for shared configs"
        type: string
        required: false
        default: "PoliticalSphere/ci"

      platform_ref:
        description: "Platform repository ref for shared scripts/configs"
        type: string
        required: false
        default: "f6eac5049f626a672c84f3899f0572a87af07ca1"

      platform_require_pinned_ref:
        description: "Require platform_ref to be a full 40-char commit SHA (true|false)"
        type: string
        required: false
        default: "true"

      # ==========================================================================
      # BUILD CONFIGURATION
      # ==========================================================================
      working_directory:
        description: "Working directory for the build (repo-relative)"
        type: string
        required: false
        default: "."

      build_script:
        description: "Build script path (repo-relative)"
        type: string
        required: false
        default: "tools/scripts/actions/ps-build/build.sh"

      job_timeout_minutes:
        description: "Hard timeout for the build job"
        type: number
        required: false
        default: 20

      # ==========================================================================
      # ARTIFACT COLLECTION & RETENTION
      # ==========================================================================
      artifact_paths:
        description: "Artifact paths to upload (newline-separated, repo-relative)"
        type: string
        required: false
        default: |
          dist/**
          build/**
          reports/**
          logs/**

      retention_days:
        description: "Standard artifact retention in days"
        type: number
        required: false
        default: 7

      compression_level:
        description: "Zlib compression level (0-9) for artifact uploads"
        type: number
        required: false
        default: 6

      validate_retention_days:
        description: "Policy gate (Validate-CI) specific retention in days"
        type: number
        required: false
        default: 7

    # ==========================================================================
    # SECRETS (OPTIONAL, LEAST-PRIVILEGE)
    # ==========================================================================
    secrets:
      NODE_AUTH_TOKEN:
        description: "Optional token for private registry installs"
        required: false

# ==============================================================================
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ==============================================================================
permissions:
  contents: read  # Justification: required for repository checkout
  actions: read   # Justification: inspect workflow runs for CI validation

jobs:
  call:
    name: Build Artifacts
    uses: ./.github/workflows/_reusable-build-artifacts.yml
    permissions:
      contents: read
    with:
      runner: ${{ inputs.runner }}
      node_version: ${{ inputs.node_version }}
      cache: ${{ inputs.cache }}
      fetch_depth: ${{ inputs.fetch_depth }}
      platform_repository: ${{ inputs.platform_repository }}
      platform_ref: ${{ inputs.platform_ref }}
      platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}
      working_directory: ${{ inputs.working_directory }}
      build_script: ${{ inputs.build_script }}
      job_timeout_minutes: ${{ inputs.job_timeout_minutes }}
      artifact_paths: ${{ inputs.artifact_paths }}
      retention_days: ${{ inputs.retention_days }}
      compression_level: ${{ inputs.compression_level }}
      validate_retention_days: ${{ inputs.validate_retention_days }}
    secrets:
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
