# ==============================================================================
# Political Sphere — Reusable Workflow: Build Artifacts
# ==============================================================================
#
# METADATA
# ------------------------------------------------------------------------------
# id: build-artifacts
# version: 1.1.0
# owner: political-sphere
# classification: internal
# created: 2025-12-20
# last_updated: 2025-12-24
#
#
# PURPOSE
# ------------------------------------------------------------------------------
# Build deterministic artifacts for consumer repositories and publish them as
# CI evidence. This workflow verifies CI policy compliance, executes a clean
# build in a hardened environment, uploads declared artifacts, and produces a
# machine-readable summary.
#
#
# SCOPE & RESPONSIBILITIES
# ------------------------------------------------------------------------------
# DOES:
#   - Enforce CI policy compliance via Validate-CI
#   - Perform a deterministic build in a clean environment
#   - Upload build artifacts with controlled retention
#   - Publish a structured, machine-readable summary
#
# DOES NOT:
#   - Run tests or quality gates (handled by PR Gates)
#   - Perform deep security scans
#   - Publish packages or deploy artifacts
#   - Perform releases or environment mutations
#
#
# DESIGN PRINCIPLES
# ------------------------------------------------------------------------------
# - Deterministic, non-interactive execution
# - Least privilege at workflow and job level
# - Validate-CI MUST pass before any build executes
# - Single canonical bootstrap path for build (ps-bootstrap)
# - Evidence-first: artifacts + summary best-effort even on failure
#
# ==============================================================================

name: Build Artifacts

# ==============================================================================
# TRIGGER & INVOCATION MODEL
# ------------------------------------------------------------------------------
# Reusable workflow invoked via workflow_call
# ==============================================================================
on:
  workflow_call:

    # ==========================================================================
    # RUNTIME & ENVIRONMENT CONFIGURATION
    # ==========================================================================
    inputs:
      runner:
        description: "Runner label"
        type: string
        required: false
        default: "ubuntu-22.04"

      node_version:
        description: "Node.js major version"
        type: string
        required: false
        default: "22"

      fetch_depth:
        description: "Git fetch depth (1 = shallow, 0 = full history)"
        type: number
        required: false
        default: 1

      cache:
        description: "Enable dependency caching (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

      # ==========================================================================
      # PLATFORM & SHARED TOOLING
      # ==========================================================================
      platform_repository:
        description: "Platform repository for shared configs"
        type: string
        required: false
        default: "PoliticalSphere/ci"

      platform_ref:
        description: "Platform repository ref for shared scripts/configs"
        type: string
        required: false
        default: "main"

      # ==========================================================================
      # BUILD CONFIGURATION
      # ==========================================================================
      working_directory:
        description: "Working directory for the build (repo-relative)"
        type: string
        required: false
        default: "."

      build_script:
        description: "Build script path (repo-relative)"
        type: string
        required: false
        default: "tools/scripts/tasks/build.sh"

      build_timeout_minutes:
        description: "Hard timeout for the build job"
        type: number
        required: false
        default: 20

      # ==========================================================================
      # ARTIFACT COLLECTION & RETENTION
      # ==========================================================================
      artifact_paths:
        description: "Artifact paths to upload"
        type: string
        required: false
        default: |
          dist/**
          build/**
          reports/**
          logs/**

      retention_days:
        description: "Artifact retention in days"
        type: number
        required: false
        default: 7

      compression_level:
        description: "Zlib compression level (0-9)"
        type: number
        required: false
        default: 6

      validate_retention_days:
        description: "Validate-CI artifact retention in days"
        type: number
        required: false
        default: 7

    # ==========================================================================
    # SECRETS (OPTIONAL, LEAST-PRIVILEGE)
    # ==========================================================================
    secrets:
      NODE_AUTH_TOKEN:
        description: "Optional token for private registry installs"
        required: false

# ==============================================================================
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ==============================================================================
permissions:
  contents: read

# ==============================================================================
# CONCURRENCY CONTROL
# ------------------------------------------------------------------------------
# Ensures a single build-artifacts run per ref.
# ==============================================================================
concurrency:
  group: build-artifacts-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: true

# ==============================================================================
# GLOBAL EXECUTION DEFAULTS
# ==============================================================================
defaults:
  run:
    shell: bash

# ==============================================================================
# GLOBAL ENVIRONMENT
# ==============================================================================
env:
  CI: "1"
  PS_PLATFORM_ROOT: ${{ github.workspace }}/.ps-platform
  NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

  # Standardised workflow identifiers (avoid magic strings)
  PS_WORKFLOW_ID: "build-artifacts"
  PS_ARTIFACT_PREFIX: "build-artifacts"
  PS_BRAND_KEY: "build.artifacts"

jobs:
  # ============================================================================
  # POLICY GATE — VALIDATE CI
  # ============================================================================
  validate-ci:
    name: Validate CI (policy gate)
    uses: ./.github/workflows/validate-ci.yml
    permissions:
      contents: read
    with:
      runner: ${{ inputs.runner }}
      node_version: ${{ inputs.node_version }}
      fetch_depth: ${{ inputs.fetch_depth }}
      cache: ${{ inputs.cache }}
      artifact_name: build-artifacts-validate-ci
      retention_days: ${{ inputs.validate_retention_days }}
      platform_ref: ${{ inputs.platform_ref }}
    secrets:
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

  # ============================================================================
  # BUILD VERIFICATION — BUILD & ARTIFACTS
  # ============================================================================
  build:
    name: Build and upload artifacts
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    timeout-minutes: ${{ inputs.build_timeout_minutes }}
    permissions:
      contents: read

    steps:
      - name: Job setup (PS)
        uses: ./.github/actions/ps-bootstrap
        with:
          skip_checkout: "0"          # Now handles source checkout automatically
          platform_repository: ${{ inputs.platform_repository }}
          platform_ref: ${{ inputs.platform_ref }}
          install_dependencies: "0"   # Still minimal (no npm ci)
          egress_policy: block        # Keeps security hardening intact

      - name: Validate build inputs (paths)
        uses: ./.github/actions/validate-paths
        with:
          working-directory: ${{ inputs.working_directory }}
          script: ${{ inputs.build_script }}

      - name: Build (PS)
        id: build
        uses: ./.github/actions/build
        with:
          working-directory: ${{ inputs.working_directory }}
          script: ${{ inputs.build_script }}

      - name: Upload platform snapshot
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: platform-snapshot
          path: .ps-platform/tools/scripts/branding/**
          if-no-files-found: "warn"
          retention-days: ${{ inputs.retention_days }}

      - name: Upload artifacts (PS)
        id: upload
        if: always()
        uses: ./.github/actions/ps-upload-artifacts
        with:
          name: ${{ env.PS_ARTIFACT_PREFIX }}
          path: ${{ inputs.artifact_paths }}
          if_no_files_found: "warn"
          retention_days: ${{ inputs.retention_days }}

      - name: Build artifacts complete
        if: always()
        shell: bash
        env:
          BUILD_SCRIPT: ${{ inputs.build_script }}
          ARTIFACT_PATHS: ${{ inputs.artifact_paths }}
          RETENTION_DAYS: ${{ inputs.retention_days }}
        run: |
          set -euo pipefail

          bash "${PS_PLATFORM_ROOT}/tools/scripts/branding/print-section.sh" \
            "${PS_BRAND_KEY}" "Build artifacts complete" 2>/dev/null || true

          ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          build_outcome="${{ steps.build.outcome }}"
          upload_outcome="${{ steps.upload.outcome }}"

          echo "PS.${PS_WORKFLOW_ID}: completed_at=${ts} build=${build_outcome} upload=${upload_outcome}"

          # Provide actionable hints on failure
          if [[ "${build_outcome}" != "success" ]]; then
            echo "ERROR: Build step failed (outcome=${build_outcome}). See logs for step 'Build (PS)'."
            # Do not interpolate raw user input in the run block; use pre-bound env vars
            echo "Tip: review the 'Build (PS)' step logs and check the build script at: ${BUILD_SCRIPT}"
          fi

          if [[ "${upload_outcome}" != "success" ]]; then
            echo "WARN: Artifact upload did not succeed (outcome=${upload_outcome})."
            echo "Tip: confirm the artifact paths and that files exist:"
            echo "  paths: ${ARTIFACT_PATHS}"
            echo "  retention_days: ${RETENTION_DAYS}"
          fi

          # Final status line for easy machine parsing
          if [[ "${build_outcome}" == "success" && "${upload_outcome}" == "success" ]]; then
            echo "PS.${PS_WORKFLOW_ID}: OK"
          else
            echo "PS.${PS_WORKFLOW_ID}: FAILED (build=${build_outcome} upload=${upload_outcome})"
          fi

  # ============================================================================
  # AGGREGATION & REPORTING — BUILD ARTIFACTS SUMMARY
  # ----------------------------------------------------------------------------
  # Note:
  #   Summary does not require Node/toolchain bootstrap. We keep it minimal:
  #   hardened runner + checkouts + summary writer + upload.
  # ============================================================================
  summary:
    name: Build artifacts summary
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci, build]
    if: ${{ always() }}
    permissions:
      contents: read
    timeout-minutes: 10

    # Note: we intentionally checkout the consumer repository here so that
    # local composite actions under `./.github/actions` (e.g., `ps-write-summary`)
    # are available. `ps-write-summary` still creates the output directory
    # (e.g. `reports/summary/`) and writes the summary file.
    steps:
      - name: Job setup (Security Only)
        uses: ./.github/actions/ps-bootstrap
        with:
          skip_checkout: "1"                # Don't pull the source
          skip_platform_checkout: "true"    # Do not checkout the platform repo in summary (use artifact snapshot)
          install_dependencies: "0"         # No npm ci
          install_tools: "0"                # No extra binaries
          egress_policy: block
          home_dir: ${{ runner.temp }}


      - name: Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11
        with:
          fetch-depth: ${{ inputs.fetch_depth }}

      - name: Download platform snapshot
        if: always()
        uses: actions/download-artifact@v3
        with:
          name: platform-snapshot
          path: .ps-platform
          allow-no-files-found: true

      - name: Set PS_PLATFORM_ROOT from snapshot
        if: always()
        shell: bash
        run: |
          set -euo pipefail

          # If the snapshot contains expected platform scripts, export PS_PLATFORM_ROOT
          if [[ -d ".ps-platform" && -f ".ps-platform/tools/scripts/branding/print-section.sh" ]]; then
            echo "PS_PLATFORM_ROOT=${{ github.workspace }}/.ps-platform" >> "$GITHUB_ENV"
            printf 'PS.SUMMARY: PS_PLATFORM_ROOT set to %s/.ps-platform\n' "${{ github.workspace }}"
          else
            printf 'WARN: platform snapshot missing or incomplete; PS_PLATFORM_ROOT not set\n' >&2
          fi

      - name: Write summary (PS)
        uses: ./.github/actions/ps-write-summary
        with:
          workflow: ${{ env.PS_WORKFLOW_ID }}
          output_path: "reports/summary/build-artifacts.json"
          results: |
            validate-ci=${{ needs.validate-ci.result }}
            build=${{ needs.build.result }}

      - name: Upload summary (PS)
        if: always()
        uses: ./.github/actions/ps-upload-artifacts
        with:
          name: ${{ env.PS_ARTIFACT_PREFIX }}-summary
          path: reports/summary/build-artifacts.json
          if_no_files_found: "warn"
          retention_days: ${{ inputs.retention_days }}
