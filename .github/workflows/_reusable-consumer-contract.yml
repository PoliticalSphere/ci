# ==============================================================================
# Political Sphere — Reusable Workflow: Consumer Contract
# ==============================================================================
#
# METADATA
# ------------------------------------------------------------------------------
# id: _reusable-consumer-contract
# version: 1.0.0
# owner: political-sphere
# classification: internal
# created: 2025-12-20
# last_updated: 2025-12-24
#
# RELATED
# ------------------------------------------------------------------------------
# references:
#   - docs/integration-guide.md
#   - configs/consumer/contract.json
# actions:
#   - ./.github/actions/ps-bootstrap/ps-setup-standard
#   - ./.github/actions/ps-teardown/ps-finalize-workflow
#
# RISKS
# ------------------------------------------------------------------------------
# - Contract validation depends on correct manifest paths
# - Breaking changes in contract require coordinated deployment
#
# PURPOSE
# ------------------------------------------------------------------------------
# Validate consumer repositories against the platform contract policy and
# publish audit-friendly reports/logs artifacts.
#
#
# SCOPE & RESPONSIBILITIES
# ------------------------------------------------------------------------------
# DOES:
#   - Enforce CI policy compliance via Validate-CI
#   - Run contract checks against policy + exceptions
#   - Upload reports/logs artifacts with controlled retention
#
# DOES NOT:
#   - Deploy, release, or publish artifacts
#   - Modify repository state
#   - Run tests or quality gates (handled by PR Gates)
#
#
# DESIGN PRINCIPLES
# ------------------------------------------------------------------------------
# - Deterministic, non-interactive execution
# - Least privilege with explicit permissions
# - Validate-CI gate runs first
# - Evidence-first: artifacts best-effort even on failure
#
#
# DEPENDENCIES
# ------------------------------------------------------------------------------
# - ./.github/workflows/validate-ci.yml
# - ./.github/actions/ps-bootstrap/ps-setup-standard
# - ./.github/actions/ps-task/consumer-contract
# - ./.github/actions/ps-teardown/ps-finalize-workflow
# - tools/scripts/workflows/consumer/contract-check.sh
#
#
# EXECUTION MODEL
# ------------------------------------------------------------------------------
# - Triggered via workflow_call (consumer-facing)
# - Runs Validate-CI gate, then contract check
# - Jobs are isolated; bootstrap runs per job as needed
#
#
# SECURITY & POLICY NOTES
# ------------------------------------------------------------------------------
# - Secrets are optional and passed explicitly (NODE_AUTH_TOKEN only)
# - Default permissions are read-only (contents: read)
# - Egress policy: audit for contract job
# - Platform ref is pinned by default and validated when required
#
#
# OPERATIONAL NOTES
# ------------------------------------------------------------------------------
# - Timeouts are configurable via inputs (per job)
# - Artifacts are uploaded best-effort (if: always())
# - Contract checks are file-based and network-free
#
# ==============================================================================

name: Consumer Contract

on:
  workflow_call:

    # ==========================================================================
    # RUNTIME & TOOLING CONFIGURATION
    # ==========================================================================
    inputs:
      runner:
        description: "Runner label"
        type: string
        required: false
        default: "ubuntu-22.04"

      node_version:
        description: "Node.js major version"
        type: string
        required: false
        default: "22"

      cache:
        description: "Enable Node dependency caching (1 = on, 0 = off)"
        type: string
        required: false
        default: "0"

      fetch_depth:
        description: "Git fetch depth for checkout (1 = shallow, 0 = full history)"
        type: number
        required: false
        default: 1

      # ==========================================================================
      # PLATFORM TRUST & SECURITY
      # ==========================================================================
      platform_repository:
        description: "Platform repository for shared configs"
        type: string
        required: false
        default: "PoliticalSphere/ci"

      platform_ref:
        description: "Platform repository ref for shared scripts/configs"
        type: string
        required: false
        default: "f6eac5049f626a672c84f3899f0572a87af07ca1"

      platform_require_pinned_ref:
        description: "Require platform_ref to be a full 40-char commit SHA (true|false)"
        type: string
        required: false
        default: "true"

      # ==========================================================================
      # CONTRACT CONFIGURATION
      # ==========================================================================
      job_timeout_minutes:
        description: "Timeout for contract job in minutes"
        type: number
        required: false
        default: 15

      policy_path:
        description: "Contract policy path (repo-relative)"
        type: string
        required: false
        default: "configs/consumer/contract.json"

      exceptions_path:
        description: "Exceptions policy path (repo-relative)"
        type: string
        required: false
        default: "configs/consumer/exceptions.json"

      report_path:
        description: "Contract report path (repo-relative)"
        type: string
        required: false
        default: "reports/contracts/contract.json"

      summary_path:
        description: "Contract summary path (repo-relative)"
        type: string
        required: false
        default: "reports/contracts/contract.txt"

      log_dir:
        description: "Log output directory (repo-relative)"
        type: string
        required: false
        default: "logs/contracts"

      # ==========================================================================
      # ARTIFACT COLLECTION & RETENTION
      # ==========================================================================
      artifact_paths:
        description: "Artifact paths to upload (newline-separated, repo-relative)"
        type: string
        required: false
        default: |
          dist/**
          build/**
          reports/**
          logs/**

      retention_days:
        description: "Standard artifact retention in days"
        type: number
        required: false
        default: 7

      compression_level:
        description: "Zlib compression level (0-9) for artifact uploads"
        type: number
        required: false
        default: 6

      validate_retention_days:
        description: "Policy gate (Validate-CI) specific retention in days"
        type: number
        required: false
        default: 7

    # ==========================================================================
    # SECRETS (OPTIONAL, LEAST-PRIVILEGE)
    # ==========================================================================
    secrets:
      NODE_AUTH_TOKEN:
        description: "Optional token for private registry installs"
        required: false

# ==============================================================================
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ==============================================================================
permissions:
  contents: read

# ==============================================================================
# GLOBAL EXECUTION DEFAULTS
# ==============================================================================
defaults:
  run:
    shell: bash

# ==============================================================================
# CONCURRENCY CONTROL
# ------------------------------------------------------------------------------
# Ensures a single consumer-contract run per ref.
# ==============================================================================

concurrency:
  group: consumer-contract-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: true

# ==============================================================================
# GLOBAL PLATFORM ENVIRONMENT
# ==============================================================================
env:
  CI: "1"
  PS_PLATFORM_ROOT: ${{ github.workspace }}/.ps-platform

  # Standardised workflow identifiers (avoid magic strings)
  PS_WORKFLOW_ID: "consumer-contract"
  PS_ARTIFACT_PREFIX: "consumer-contract"
  PS_BRAND_KEY: "consumer.contract"

jobs:
  # ============================================================================
  # POLICY GATE — VALIDATE CI
  # ----------------------------------------------------------------------------
  # Runs the reusable Validate-CI workflow with platform dependency installs
  # enabled for runtime dependencies. NODE_AUTH_TOKEN is passed if provided.
  # ============================================================================
  validate-ci:
    name: Validate CI (policy gate)
    uses: ./.github/workflows/validate-ci.yml
    permissions:
      contents: read
    with:
      runner: ${{ inputs.runner }}
      node_version: ${{ inputs.node_version }}
      fetch_depth: ${{ inputs.fetch_depth }}
      cache: ${{ inputs.cache }}
      platform_ref: ${{ inputs.platform_ref }}
      platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}
      artifact_name: consumer-contract-validate-ci
      retention_days: ${{ inputs.validate_retention_days }}
    secrets:
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

  # ============================================================================
  # CONTRACT VALIDATION — CONSUMER CONTRACT
  # ----------------------------------------------------------------------------
  # Performs contract checks after the policy gate succeeds, then uploads
  # reports/logs and a summary JSON.
  # ============================================================================
  contract:
    name: Consumer contract
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    timeout-minutes: ${{ inputs.job_timeout_minutes }}
    permissions:
      contents: read

    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          checkout_ref: ${{ github.event.pull_request.head.sha || github.sha }}
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}
          skip_node: "1"

      - name: Contract check
        uses: ./.github/actions/ps-task/consumer-contract
        with:
          policy_path: ${{ inputs.policy_path }}
          exceptions_path: ${{ inputs.exceptions_path }}
          report_path: ${{ inputs.report_path }}
          summary_path: ${{ inputs.summary_path }}
          log_dir: ${{ inputs.log_dir }}

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: consumer-contract
          summary_output_path: reports/summary/consumer-contract.json
          summary_results: contract=${{ job.status }}
          artifacts_name: consumer-contract-report
          artifacts_paths: |
            reports/**
            logs/**
            ${{ inputs.artifact_paths }}
          artifacts_if_no_files_found: "warn"
          artifacts_retention_days: ${{ inputs.retention_days }}
          artifacts_compression_level: ${{ inputs.compression_level }}
