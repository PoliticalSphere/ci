# ==============================================================================
# Political Sphere — Reusable Workflow: License Compliance
# ==============================================================================
#
# PURPOSE
# ------------------------------------------------------------------------------
# Enforce OSS license compliance using the Political Sphere policy file and
# repository lockfile evidence. Produces audit-friendly reports/logs artifacts
# and a machine-readable summary.
#
#
# METADATA
# ------------------------------------------------------------------------------
# - Created:      2025-12-20
# - Last updated: 2025-12-24
# - Owner:        political-sphere
# - Classification: internal
#
#
# SCOPE & RESPONSIBILITIES
# ------------------------------------------------------------------------------
# DOES:
#   - Enforce CI policy compliance via Validate-CI
#   - Run license compliance checks against a declared policy + lockfile
#   - Upload reports/logs as evidence artifacts with controlled retention
#   - Publish a structured summary JSON
#
# DOES NOT:
#   - Deploy, release, or publish packages
#   - Mutate repository state
#   - Require elevated permissions
#
#
# DESIGN PRINCIPLES
# ------------------------------------------------------------------------------
# - Deterministic, non-interactive execution
# - Least privilege at workflow and job level
# - Validate-CI MUST pass before checks execute
# - Single canonical bootstrap path (ps-bootstrap)
# - External actions (if used) must be SHA-pinned
#
#
# EXECUTION MODEL
# ------------------------------------------------------------------------------
# - Triggered via workflow_call (consumer-facing)
# - Optional pull_request trigger supported for platform repo usage
#
#
# SECURITY & POLICY NOTES
# ------------------------------------------------------------------------------
# - Secrets are optional and passed explicitly (NODE_AUTH_TOKEN only)
# - Default permissions are read-only (contents: read)
# - Egress policy defaults to audit (observability without blocking)
#
#
# OPERATIONAL NOTES
# ------------------------------------------------------------------------------
# - Artifacts are always uploaded best-effort (if: always())
# - Summary is always produced
# - Inputs are typed and use consistent "0"/"1" string booleans where applicable
#
# ==============================================================================

name: License Compliance

# ==============================================================================
# TRIGGER & INVOCATION MODEL
# ------------------------------------------------------------------------------
# - Reusable workflow invoked via workflow_call
# - Optional direct PR trigger (platform repo convenience)
# ==============================================================================
on:
  workflow_call:

    # ==========================================================================
    # RUNTIME & ENVIRONMENT CONFIGURATION
    # --------------------------------------------------------------------------
    inputs:
      runner:
        description: "Runner label"
        type: string
        required: false
        default: "ubuntu-22.04"

      node_version:
        description: "Node.js major version"
        type: string
        required: false
        default: "22"

      fetch_depth:
        description: "Git fetch depth (1 = shallow, 0 = full history)"
        type: number
        required: false
        default: 1

      cache:
        description: "Enable Node dependency caching (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

      install_dependencies:
        description: "Install npm dependencies (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

    # ==========================================================================
    # PLATFORM & SHARED TOOLING
    # --------------------------------------------------------------------------
      platform_ref:
        description: "Platform repo ref to checkout for shared scripts/configs"
        type: string
        required: false
        default: "main"

    # ==========================================================================
    # LICENSE INPUTS
    # --------------------------------------------------------------------------
      policy_path:
        description: "License policy path (repo-relative)"
        type: string
        required: false
        default: "configs/security/license-policy.yml"

      lock_path:
        description: "Lockfile path (repo-relative)"
        type: string
        required: false
        default: "package-lock.json"

      report_dir:
        description: "Report output directory (repo-relative)"
        type: string
        required: false
        default: "reports/security"

      log_dir:
        description: "Log output directory (repo-relative)"
        type: string
        required: false
        default: "logs/security"

    # ==========================================================================
    # ARTIFACT COLLECTION & RETENTION
    # --------------------------------------------------------------------------
      retention_days:
        description: "Artifact retention in days"
        type: number
        required: false
        default: 7

    # ==========================================================================
    # SECRETS (OPTIONAL, LEAST-PRIVILEGE)
    # --------------------------------------------------------------------------
    secrets:
      NODE_AUTH_TOKEN:
        description: "Optional token for private registry installs"
        required: false

  pull_request:
    types: [opened, reopened, synchronize]

# ==============================================================================
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ==============================================================================
permissions:
  contents: read

# ==============================================================================
# CONCURRENCY CONTROL
# ------------------------------------------------------------------------------
# Ensures a single license-compliance run per ref.
# ==============================================================================
concurrency:
  group: license-compliance-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: true

# ==============================================================================
# GLOBAL EXECUTION DEFAULTS
# ==============================================================================
defaults:
  run:
    shell: bash

# ==============================================================================
# GLOBAL ENVIRONMENT
# ==============================================================================
env:
  CI: "1"
  FORCE_COLOR: "1"
  PS_PLATFORM_ROOT: ${{ github.workspace }}/.ps-platform
  NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

jobs:
  # ============================================================================
  # POLICY GATE — VALIDATE CI
  # ----------------------------------------------------------------------------
  # Purpose:
  #   Enforce repository CI policy before any license compliance work executes.
  #
  # Blocking:
  #   Yes
  # ============================================================================
  validate-ci:
    name: Validate CI (policy gate)
    uses: ./.github/workflows/validate-ci.yml
    permissions:
      contents: read
    with:
      runner: ${{ inputs.runner }}
      node_version: ${{ inputs.node_version }}
      fetch_depth: ${{ inputs.fetch_depth }}
      cache: ${{ inputs.cache }}
      platform_ref: ${{ inputs.platform_ref }}
      artifact_name: license-compliance-validate-ci
      retention_days: ${{ inputs.retention_days }}
    secrets:
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

  # ============================================================================
  # COMPLIANCE GATE — LICENSE CHECK
  # ----------------------------------------------------------------------------
  # Purpose:
  #   Validate dependency license compliance against platform policy + lockfile.
  #
  # Blocking:
  #   Yes
  # ============================================================================
  license:
    name: License compliance
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    permissions:
      contents: read
    timeout-minutes: 15
    steps:
      - name: Job setup (PS)
        uses: ./.github/actions/ps-bootstrap/ps-init
        with:
          fetch_depth: ${{ inputs.fetch_depth }}

          platform_repo: "PoliticalSphere/ci"
          platform_ref: ${{ inputs.platform_ref }}
          platform_path: ".ps-platform"
          platform_allowed_repositories: "PoliticalSphere/ci"
          skip_platform_checkout: "0"

          home_dir: ".home"
          egress_policy: audit

          install_tools: "0"

      - name: Setup Node.js (cached)
        if: ${{ inputs.install_dependencies == '1' && inputs.cache == '1' }}
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ inputs.node_version }}
          cache: "npm"
          cache-dependency-path: "package-lock.json"

      - name: Setup Node.js
        if: ${{ inputs.install_dependencies != '1' || inputs.cache != '1' }}
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020
        with:
          node-version: ${{ inputs.node_version }}

      - name: Install repository dependencies
        if: ${{ inputs.install_dependencies == '1' }}
        run: npm ci --no-audit --no-fund
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

      - name: License compliance (PS)
        uses: ./.github/actions/license-check
        with:
          policy_path: ${{ inputs.policy_path }}
          lock_path: ${{ inputs.lock_path }}
          report_dir: ${{ inputs.report_dir }}
          log_dir: ${{ inputs.log_dir }}

      # ------------------------------------------------------------------------
      # Evidence & reporting
      # ------------------------------------------------------------------------
      - name: Write summary (PS)
        if: always()
        uses: ./.github/actions/ps-write-summary
        with:
          workflow: "license-compliance"
          output_path: "reports/summary/license-compliance.json"
          results: |
            validate-ci=${{ needs.validate-ci.result }}
            license=${{ job.status }}

      - name: Upload report artifacts (PS)
        if: always()
        uses: ./.github/actions/ps-upload-artifacts
        with:
          name: license-compliance-report
          path: |
            reports/**
            logs/**
          if_no_files_found: "warn"
          retention_days: ${{ inputs.retention_days }}

      - name: Upload summary artifact (PS)
        if: always()
        uses: ./.github/actions/ps-upload-artifacts
        with:
          name: license-compliance-summary
          path: reports/summary/license-compliance.json
          if_no_files_found: "warn"
          retention_days: ${{ inputs.retention_days }}

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown
        with:
          summary_workflow: license-compliance
          summary_output_path: reports/summary/license-compliance.json
          summary_results: license=${{ job.status }}
          artifacts_name: license-compliance-report
          artifacts_paths: |
            reports/**
            logs/**
