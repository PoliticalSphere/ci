# ==============================================================================
# Political Sphere â€” License Compliance (Caller)
# ==============================================================================
#
# METADATA
# ------------------------------------------------------------------------------
# id: license-compliance
# version: 1.0.0
# owner: political-sphere
# classification: internal
#
# PURPOSE
# ------------------------------------------------------------------------------
# Caller workflow that delegates to _reusable-license-compliance.yml for
# dependency license policy checks.
#
#
# SCOPE & RESPONSIBILITIES
# ------------------------------------------------------------------------------
# DOES:
#   - Invoke _reusable-license-compliance.yml with caller inputs
#   - Pass through license policy configuration
#
# DOES NOT:
#   - Perform license checks directly
#   - Deploy or publish artifacts externally
#
#
# DEPENDENCIES
# ------------------------------------------------------------------------------
# - ./.github/workflows/_reusable-license-compliance.yml
#
#
# EXECUTION MODEL
# ------------------------------------------------------------------------------
# - Trigger: workflow_call (internal reusable)
# - Single job: delegates to _reusable-license-compliance.yml
#
#
# SECURITY & POLICY NOTES
# ------------------------------------------------------------------------------
# - Permissions: minimal (contents: read)
# - Platform ref must be SHA-pinned for supply chain security
#
# ==============================================================================

name: License Compliance

on:
  workflow_call:
    
    # ==========================================================================
    # RUNTIME & ENVIRONMENT CONFIGURATION
    # ==========================================================================
    inputs:
      runner:
        description: "Runner label"
        type: string
        required: false
        default: "ubuntu-22.04"

      node_version:
        description: "Node.js major version"
        type: string
        required: false
        default: "22"

      fetch_depth:
        description: "Git fetch depth (1 = shallow, 0 = full history)"
        type: number
        required: false
        default: 1

      cache:
        description: "Enable Node dependency caching (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

      install_dependencies:
        description: "Install npm dependencies (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

      license_timeout_minutes:
        description: "Timeout for license compliance job in minutes"
        type: number
        required: false
        default: 15

      # ==========================================================================
      # PLATFORM & SHARED TOOLING
      # ==========================================================================
      platform_ref:
        description: "Platform repo ref to checkout for shared scripts/configs"
        type: string
        required: false
        default: "f6eac5049f626a672c84f3899f0572a87af07ca1"

      platform_require_pinned_ref:
        description: "Require platform_ref to be a full 40-char commit SHA (true|false)"
        type: string
        required: false
        default: "true"

      # ==========================================================================
      # LICENSE INPUTS
      # ==========================================================================
      policy_path:
        description: "License policy path (repo-relative)"
        type: string
        required: false
        default: "configs/security/license-policy.yml"

      lock_path:
        description: "Lockfile path (repo-relative)"
        type: string
        required: false
        default: "package-lock.json"

      report_dir:
        description: "Report output directory (repo-relative)"
        type: string
        required: false
        default: "reports/security"

      log_dir:
        description: "Log output directory (repo-relative)"
        type: string
        required: false
        default: "logs/security"

      # ==========================================================================
      # ARTIFACT COLLECTION & RETENTION
      # ==========================================================================
      retention_days:
        description: "Artifact retention in days"
        type: number
        required: false
        default: 7

    # ==========================================================================
    # SECRETS (OPTIONAL, LEAST-PRIVILEGE)
    # ==========================================================================
    secrets:
      NODE_AUTH_TOKEN:
        description: "Optional token for private registry installs"
        required: false

  pull_request:
    types: [opened, reopened, synchronize]

# ==============================================================================
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ==============================================================================
permissions:
  contents: read  # Justification: required for lockfile checkout and dependency scanning

jobs:
  call:
    name: License Compliance
    uses: ./.github/workflows/_reusable-license-compliance.yml
    permissions:
      contents: read
    with:
      runner: ${{ inputs.runner || 'ubuntu-22.04' }}
      node_version: ${{ inputs.node_version || '22' }}
      fetch_depth: ${{ inputs.fetch_depth || 1 }}
      cache: ${{ inputs.cache || '1' }}
      install_dependencies: ${{ inputs.install_dependencies || '1' }}
      license_timeout_minutes: ${{ inputs.license_timeout_minutes || 15 }}
      platform_ref: ${{ inputs.platform_ref || 'f6eac5049f626a672c84f3899f0572a87af07ca1' }}
      platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref || 'true' }}
      policy_path: ${{ inputs.policy_path || 'configs/security/license-policy.yml' }}
      lock_path: ${{ inputs.lock_path || 'package-lock.json' }}
      report_dir: ${{ inputs.report_dir || 'reports/security' }}
      log_dir: ${{ inputs.log_dir || 'logs/security' }}
      retention_days: ${{ inputs.retention_days || 7 }}
    secrets:
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
