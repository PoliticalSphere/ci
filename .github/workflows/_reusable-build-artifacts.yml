# ══════════════════════════════════════════════════════════════════════════════
# Build Artifacts — Deterministic builds + artifact upload
# ══════════════════════════════════════════════════════════════════════════════
#
# Builds artifacts in a clean, hardened environment and uploads CI evidence.
# Validates CI policy first, then executes build with controlled retention.
#
# Docs: .github/workflows/README.md#build-artifacts
# Refs: docs/security-ci-policy.md
#
# Risks:
#   • Artifact retention duration limits storage costs
#   • Large artifacts can slow uploads/downloads
#
# ══════════════════════════════════════════════════════════════════════════════

name: Build Artifacts

on:
  workflow_call:

    # ==========================================================================
    # RUNTIME & ENVIRONMENT CONFIGURATION
    # ==========================================================================
    inputs:
      runner:
        description: "Runner label"
        type: string
        required: false
        default: "ubuntu-22.04"

      node_version:
        description: "Node.js major version"
        type: string
        required: false
        default: "22"   

      fetch_depth:
        description: "Git fetch depth (1 = shallow, 0 = full history)"
        type: number
        required: false
        default: 1

      cache:
        description: "Enable dependency caching (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

      # ==========================================================================
      # PLATFORM & SHARED TOOLING
      # ==========================================================================
      platform_repository:
        description: "Platform repository for shared configs"
        type: string
        required: false
        default: "PoliticalSphere/ci"

      platform_ref:
        description: "Platform repository ref for shared scripts/configs"
        type: string
        required: false
        default: "f6eac5049f626a672c84f3899f0572a87af07ca1"

      platform_require_pinned_ref:
        description: "Require platform_ref to be a full 40-char commit SHA (true|false)"
        type: string
        required: false
        default: "true"

      # ==========================================================================
      # BUILD CONFIGURATION
      # ==========================================================================
      working_directory:
        description: "Working directory for the build (repo-relative)"
        type: string
        required: false
        default: "."

      build_script:
        description: "Build script path (repo-relative)"
        type: string
        required: false
        default: "tools/scripts/actions/ps-build/build.sh"

      job_timeout_minutes:
        description: "Hard timeout for the build job"
        type: number
        required: false
        default: 20

      # ==========================================================================
      # ARTIFACT COLLECTION & RETENTION
      # ==========================================================================
      artifact_paths:
        description: "Artifact paths to upload (newline-separated, repo-relative)"
        type: string
        required: false
        default: |
          dist/**
          build/**
          reports/**
          logs/**

      retention_days:
        description: "Standard artifact retention in days"
        type: number
        required: false
        default: 7

      compression_level:
        description: "Zlib compression level (0-9) for artifact uploads"
        type: number
        required: false
        default: 6

      validate_retention_days:
        description: "Policy gate (Validate-CI) specific retention in days"
        type: number
        required: false
        default: 7

    # ==========================================================================
    # SECRETS (OPTIONAL, LEAST-PRIVILEGE)
    # ==========================================================================
    secrets:
      NODE_AUTH_TOKEN:
        description: "Optional token for private registry installs"
        required: false

# ==============================================================================
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ==============================================================================
permissions:
  contents: read

# ==============================================================================
# GLOBAL EXECUTION DEFAULTS
# ==============================================================================
defaults:
  run:
    shell: bash

# ==============================================================================
# CONCURRENCY CONTROL
# ------------------------------------------------------------------------------
# Ensures a single build-artifacts run per ref.
# ==============================================================================
concurrency:
  group: build-artifacts-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: true

# ==============================================================================
# GLOBAL PLATFORM ENVIRONMENT
# ==============================================================================
env:
  CI: "1"
  PS_PLATFORM_ROOT: ${{ github.workspace }}/.ps-platform

  # Standardised workflow identifiers (avoid magic strings)
  PS_WORKFLOW_ID: "build-artifacts"
  PS_ARTIFACT_PREFIX: "build-artifacts"
  PS_BRAND_KEY: "build.artifacts"

jobs:
  # ============================================================================
  # POLICY GATE — VALIDATE CI
  # ----------------------------------------------------------------------------
  # Runs the reusable Validate-CI workflow with platform dependency installs
  # enabled for runtime dependencies. NODE_AUTH_TOKEN is passed if provided.
  # ============================================================================
  validate-ci:
    name: Validate CI (policy gate)
    uses: ./.github/workflows/validate-ci.yml
    permissions:
      contents: read
    with:
      runner: ${{ inputs.runner }}
      node_version: ${{ inputs.node_version }}
      fetch_depth: ${{ inputs.fetch_depth }}
      cache: ${{ inputs.cache }}
      install_platform_dependencies: "1"
      artifact_name: build-artifacts-validate-ci
      retention_days: ${{ inputs.validate_retention_days }}
      platform_ref: ${{ inputs.platform_ref }}
    secrets:
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

  # ============================================================================
  # BUILD VERIFICATION — BUILD & ARTIFACTS
  # ----------------------------------------------------------------------------
  # Builds in a hardened environment after the policy gate succeeds, then
  # uploads declared artifacts (strict: error if missing).
  # ============================================================================
  build:
    name: Build and upload artifacts
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    timeout-minutes: ${{ inputs.job_timeout_minutes }}
    permissions:
      contents: read

    steps:
      - name: Bootstrap (PS)
        id: job_setup
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          checkout_ref: ${{ github.event.pull_request.head.sha || github.sha }}
          node_version: ${{ inputs.node_version }}
          cache: ${{ inputs.cache }}
          working_directory: ${{ inputs.working_directory }}
          cache_dependency_path: ${{ inputs.working_directory }}/package-lock.json
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}

      - name: Build (PS)
        id: build
        uses: ./.github/actions/ps-task/build
        with:
          working_directory: ${{ inputs.working_directory }}
          script: ${{ inputs.build_script }}

      - name: Upload platform snapshot (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          artifacts_name: platform-snapshot
          artifacts_paths: ${{ steps.job_setup.outputs.platform_root }}/tools/scripts/branding/**
          artifacts_if_no_files_found: "warn"
          artifacts_retention_days: ${{ inputs.retention_days }}

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: build-artifacts
          summary_output_path: reports/summary/build-artifacts-job.json
          summary_results: build=${{ job.status }}
          artifacts_name: ${{ env.PS_ARTIFACT_PREFIX }}
          artifacts_paths: |
            ${{ inputs.artifact_paths }}
          artifacts_if_no_files_found: "error"
          artifacts_retention_days: ${{ inputs.retention_days }}

  # ============================================================================
  # AGGREGATION & REPORTING — BUILD ARTIFACTS SUMMARY
  # ----------------------------------------------------------------------------
  # Note:
  #   Summary does not require Node/toolchain bootstrap. We keep it minimal:
  #   hardened runner + repo + platform checkout + summary writer + upload.
  # ============================================================================
  summary:
    name: Build artifacts summary
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci, build]
    if: ${{ always() }}
    timeout-minutes: 10
    permissions:
      contents: read

    # Note: we intentionally checkout the consumer repository here so that
    # platform exit actions are available to aggregate the multi-job results.
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          checkout_ref: ${{ github.event.pull_request.head.sha || github.sha }}
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}
          skip_node: "1"

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: build-artifacts
          summary_output_path: reports/summary/build-artifacts.json
          summary_results: |
            validate-ci=${{ needs.validate-ci.result }}
            build=${{ needs.build.result }}
          artifacts_name: ${{ env.PS_ARTIFACT_PREFIX }}-summary
          artifacts_paths: |
            reports/**
            logs/**
            reports/summary/build-artifacts.json
          artifacts_if_no_files_found: "warn"
          artifacts_retention_days: ${{ inputs.retention_days }}
          artifacts_compression_level: 9
