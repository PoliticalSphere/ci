# ══════════════════════════════════════════════════════════════════════════════
# PR Gates — Fast PR validation (lint, typecheck, tests, build, secrets scan)
# ══════════════════════════════════════════════════════════════════════════════
#
# Canonical PR-time quality gate for Political Sphere consumers.
# Runs Validate-CI first, then quality + security checks in parallel.
#
# Docs: .github/workflows/README.md#pr-gates
# Refs: docs/testing-strategy.md, docs/risk-decisions.md#rd-pr-comments
#
# Risks:
#   • Fork PRs have comments disabled (security)
#   • Sonar baseline is non-blocking (may fail silently)
#
# ══════════════════════════════════════════════════════════════════════════════

name: PR Gates

on:
  workflow_call:

    # ==========================================================================
    # RUNTIME & ENVIRONMENT CONFIGURATION
    # --------------------------------------------------------------------------
    # Controls runner selection, Node version, checkout depth, and caching.
    # ==========================================================================
    inputs:
      runner:
        description: "Runner label"
        type: string
        required: false
        default: "ubuntu-22.04"

      node_version:
        description: "Node.js major version"
        type: string
        required: false
        default: "22"

      fetch_depth:
        description: "Git fetch depth (1 = shallow, 0 = full history)"
        type: number
        required: false
        default: 1

      cache:
        description: "Enable dependency caching (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

      # ==========================================================================
      # PLATFORM & SHARED TOOLING
      # --------------------------------------------------------------------------
      platform_ref:
        description: "Platform repository ref for shared scripts/configs"
        type: string
        required: false
        default: "f6eac5049f626a672c84f3899f0572a87af07ca1"

      platform_require_pinned_ref:
        description: "Require platform_ref to be a full 40-char commit SHA (true|false)"
        type: string
        required: false
        default: "true"

      # ==========================================================================
      # ARTIFACT COLLECTION & RETENTION
      # --------------------------------------------------------------------------
      artifact_paths:
        description: "Artifact paths to upload"
        type: string
        required: false
        default: |
          reports/**
          logs/**

      coverage_paths:
        description: "Coverage/report paths to upload"
        type: string
        required: false
        default: |
          coverage/**
          playwright-report/**
          test-results/**
          reports/coverage/**

      test_results_paths:
        description: "JUnit / XML test result paths to upload"
        type: string
        required: false
        default: |
          reports/**/junit*.xml
          reports/**/junit.xml
          test-results/**/*.xml

      retention_days:
        description: "Artifact retention in days"
        type: number
        required: false
        default: 7

      # ==========================================================================
      # VALIDATION BEHAVIOUR
      # --------------------------------------------------------------------------
      ps_full_scan:
        description: "Enable strict/full scan behaviour for downstream gates"
        type: string
        required: false
        default: "1"

      # ==========================================================================
      # PULL REQUEST CONTEXT (OPTIONAL)
      # --------------------------------------------------------------------------
      pr_number:
        description: "Pull request number (enables dependency review + PR comments)"
        type: string
        required: false
        default: ""

      pr_is_fork:
        description: "Whether the PR originates from a fork (true/false)"
        type: string
        required: false
        default: "false"

      allow_pr_comments:
        description: "Allow PR failure comments (1 = on, 0 = off)"
        type: string
        required: false
        default: "0"

      pr_base_ref:
        description: "PR base SHA (diff-based checks, dependency review)"
        type: string
        required: false
        default: ""

      pr_head_ref:
        description: "PR head SHA (diff-based checks, dependency review)"
        type: string
        required: false
        default: ""

    # ==========================================================================
    # SECRETS (OPTIONAL, LEAST-PRIVILEGE)
    # ==========================================================================
    secrets:
      NODE_AUTH_TOKEN:
        description: "Optional token for private registry installs"
        required: false
      SONAR_TOKEN:
        description: "SonarCloud token"
        required: false
      SONAR_ORGANIZATION:
        description: "SonarCloud organization key"
        required: false
      SONAR_PROJECT_KEY:
        description: "SonarCloud project key"
        required: false

# ==============================================================================
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ==============================================================================
permissions:
  contents: read

# ==============================================================================
# CONCURRENCY CONTROL
# ------------------------------------------------------------------------------
# Ensures only one PR Gates run per PR/ref at a time.
# ==============================================================================
concurrency:
  group: >-
    pr-gates-${{ github.repository }}-${{
    inputs.pr_number != '' && inputs.pr_number || github.ref }}
  cancel-in-progress: true

# ==============================================================================
# GLOBAL EXECUTION DEFAULTS
# ==============================================================================
defaults:
  run:
    shell: bash

# ==============================================================================
# GLOBAL ENVIRONMENT
# ==============================================================================
env:
  CI: "1"
  PS_FULL_SCAN: ${{ inputs.ps_full_scan }}
  PS_PLATFORM_ROOT: ${{ github.workspace }}/.ps-platform
  NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

jobs:
  # ============================================================================
  # POLICY GATE — VALIDATE CI
  # ----------------------------------------------------------------------------
  # Purpose:
  #   Enforce repository CI policy before any workload executes.
  #
  # Blocking:
  #   Yes
  # ============================================================================
  validate-ci:
    name: Validate CI (policy gate)
    uses: ./.github/workflows/validate-ci.yml
    permissions:
      contents: read
    with:
      runner: ${{ inputs.runner }}
      node_version: ${{ inputs.node_version }}
      fetch_depth: ${{ inputs.fetch_depth }}
      cache: ${{ inputs.cache }}
      platform_ref: ${{ inputs.platform_ref }}
      pr_only: "1"
      pr_base_ref: ${{ inputs.pr_base_ref }}
      pr_head_ref: ${{ inputs.pr_head_ref }}
      artifact_name: pr-gates-validate-ci
      retention_days: ${{ inputs.retention_days }}
    secrets:
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

  # ============================================================================
  # QUALITY GATE — LINT
  # ----------------------------------------------------------------------------
  # Purpose:
  #   Run fast, PR-scoped linting across the repository.
  #
  # Blocking:
  #   Yes
  # ============================================================================
  lint:
    name: Lint
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write  # Justification: post lint failure comment via ps-exit
    env:
      PS_FULL_SCAN: "0"
      PS_PR_BASE_SHA: ${{ inputs.pr_base_ref }}
      PS_PR_HEAD_SHA: ${{ inputs.pr_head_ref }}
      PS_SKIP_SECRETS_SCAN: "1"
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          node_version: ${{ inputs.node_version }}
          cache: ${{ inputs.cache }}
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}
          install_tools: "1"
          tools_bundle: "lint"

      - name: Lint (PS)
        uses: ./.github/actions/ps-task/lint

      - name: Post lint summary (PR)
        if: >-
          ${{ failure() &&
          inputs.pr_number != '' &&
          inputs.pr_is_fork != 'true' &&
          inputs.allow_pr_comments == '1' }}
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          pr_number: ${{ inputs.pr_number }}
          github_token: ${{ github.token }}
          expected_base_sha: ${{ inputs.pr_base_ref }}
          expected_head_sha: ${{ inputs.pr_head_ref }}
          pr_comment_body_path: "logs/lint/summary.txt"
          pr_comment_body_prefix: |
            ❌ Lint gate failed.

            Summary:
            ```
          pr_comment_body_suffix: |
            ```

            Check logs/lint/*.log in artifacts for full details.
      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: pr-gates
          summary_output_path: reports/summary/pr-gates-lint.json
          summary_results: lint=${{ job.status }}
          artifacts_name: pr-gates-lint
          artifacts_paths: |
            ${{ inputs.artifact_paths }}
          artifacts_if_no_files_found: "ignore"
          artifacts_retention_days: ${{ inputs.retention_days }}

  # ============================================================================
  # QUALITY GATE — TYPECHECK
  # ----------------------------------------------------------------------------
  # Purpose:
  #   Perform static type analysis (e.g., TypeScript).
  #
  # Blocking:
  #   Yes
  # ============================================================================
  typecheck:
    name: Typecheck
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          node_version: ${{ inputs.node_version }}
          cache: ${{ inputs.cache }}
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}

      - name: Typecheck (PS)
        uses: ./.github/actions/ps-task/typecheck

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: pr-gates
          summary_output_path: reports/summary/pr-gates-typecheck.json
          summary_results: typecheck=${{ job.status }}
          artifacts_name: pr-gates-typecheck
          artifacts_paths: |
            ${{ inputs.artifact_paths }}
          artifacts_if_no_files_found: "ignore"
          artifacts_retention_days: ${{ inputs.retention_days }}

  # ============================================================================
  # QUALITY GATE — TESTS
  # ----------------------------------------------------------------------------
  # Purpose:
  #   Execute deterministic tests and upload coverage + test reports.
  #
  # Blocking:
  #   Yes
  # ============================================================================
  test:
    name: Tests
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          node_version: ${{ inputs.node_version }}
          cache: ${{ inputs.cache }}
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}

      - name: Tests (PS)
        uses: ./.github/actions/ps-task/test

      - name: Upload coverage artifacts (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          artifacts_name: pr-gates-coverage
          artifacts_paths: ${{ inputs.coverage_paths }}
          artifacts_if_no_files_found: "ignore"
          artifacts_retention_days: ${{ inputs.retention_days }}

      - name: Upload test results (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          artifacts_name: pr-gates-test-results
          artifacts_paths: ${{ inputs.test_results_paths }}
          artifacts_if_no_files_found: "ignore"
          artifacts_retention_days: ${{ inputs.retention_days }}
      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: pr-gates
          summary_output_path: reports/summary/pr-gates-tests.json
          summary_results: test=${{ job.status }}
          artifacts_name: pr-gates-tests
          artifacts_paths: |
            ${{ inputs.artifact_paths }}
          artifacts_if_no_files_found: "ignore"
          artifacts_retention_days: ${{ inputs.retention_days }}

  # ============================================================================
  # QUALITY GATE — DUPLICATION (JSCPD)
  # ----------------------------------------------------------------------------
  # Purpose:
  #   Detect copy/paste duplication and structural repetition.
  #
  # Blocking:
  #   Yes
  # ============================================================================
  jscpd:
    name: Duplication (JSCPD)
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    timeout-minutes: 20
    permissions:
      contents: read
    env:
      PS_PR_BASE_SHA: ${{ inputs.pr_base_ref }}
      PS_PR_HEAD_SHA: ${{ inputs.pr_head_ref }}
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          node_version: ${{ inputs.node_version }}
          cache: ${{ inputs.cache }}
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}

      - name: JSCPD (PS)
        uses: ./.github/actions/ps-task/code-duplication-check

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: pr-gates
          summary_output_path: reports/summary/pr-gates-jscpd.json
          summary_results: jscpd=${{ job.status }}
          artifacts_name: pr-gates-jscpd
          artifacts_paths: |
            ${{ inputs.artifact_paths }}
          artifacts_if_no_files_found: "ignore"
          artifacts_retention_days: ${{ inputs.retention_days }}

  # ============================================================================
  # QUALITY GATE — EVASION SCAN
  # ----------------------------------------------------------------------------
  # Purpose:
  #   Detect lint evasion patterns (@ts-ignore, eslint-disable, etc.)
  #   and type safety erosion (any types).
  #
  # Blocking:
  #   Yes
  # ============================================================================
  evasion-scan:
    name: Evasion Scan
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          node_version: ${{ inputs.node_version }}
          cache: ${{ inputs.cache }}
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}

      - name: Evasion Scan (PS)
        uses: ./.github/actions/ps-task/security-evasion-scan

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: pr-gates
          summary_output_path: reports/summary/pr-gates-evasion.json
          summary_results: evasion=${{ job.status }}
          artifacts_name: pr-gates-evasion
          artifacts_paths: |
            ${{ inputs.artifact_paths }}
            reports/evasion/**
          artifacts_if_no_files_found: "ignore"
          artifacts_retention_days: ${{ inputs.retention_days }}

  # ============================================================================
  # BUILD VERIFICATION — BUILD
  # ----------------------------------------------------------------------------
  # Purpose:
  #   Ensure the repository builds successfully in a clean environment.
  #
  # Blocking:
  #   Yes
  # ============================================================================
  build:
    name: Build
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    timeout-minutes: 20
    permissions:
      contents: read
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          node_version: ${{ inputs.node_version }}
          cache: ${{ inputs.cache }}
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}

      - name: Build (PS)
        uses: ./.github/actions/ps-task/build

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: pr-gates
          summary_output_path: reports/summary/pr-gates-build.json
          summary_results: build=${{ job.status }}
          artifacts_name: pr-gates-build
          artifacts_paths: |
            ${{ inputs.artifact_paths }}
          artifacts_if_no_files_found: "ignore"
          artifacts_retention_days: ${{ inputs.retention_days }}

  # ============================================================================
  # QUALITY SIGNAL — SONARCLOUD (BASELINE, NON-BLOCKING)
  # ============================================================================
  # Purpose:
  #   Collect static analysis metrics for trend visibility.
  #
  # Blocking:
  #   No (continue-on-error: true)
  # ============================================================================
  sonar:
    name: SonarCloud (baseline)
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci, test, typecheck]
    timeout-minutes: 30
    if: inputs.pr_is_fork != 'true'
    permissions:
      contents: read
    continue-on-error: true
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}
          skip_node: "1"

      - name: Detect Sonar configuration
        id: sonar_cfg
        uses: ./.github/actions/ps-task/ps-run
        with:
          id: detect-sonar
          title: Detect Sonar configuration
          script: tools/scripts/workflows/ci/detect-sonar-config.sh
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}

      - name: Node setup (PS)
        if: steps.sonar_cfg.outputs.enabled == 'true'
        uses: ./.github/actions/ps-bootstrap/ps-node
        with:
          node_version: ${{ inputs.node_version }}
          cache: ${{ inputs.cache }}
          install_dependencies: "1"
          working_directory: "."
          cache_dependency_path: "package-lock.json"

      - name: SonarCloud scan (PS)
        if: steps.sonar_cfg.outputs.enabled == 'true'
        uses: ./.github/actions/ps-task/code-quality-sonarcloud
        env:
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
          SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          organization: ${{ env.SONAR_ORGANIZATION }}
          project_key: ${{ env.SONAR_PROJECT_KEY }}
          token: ${{ env.SONAR_TOKEN }}

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: pr-gates
          summary_output_path: reports/summary/pr-gates-sonar.json
          summary_results: sonar=${{ job.status }}
          artifacts_name: pr-gates-sonar
          artifacts_paths: |
            reports/**
          artifacts_if_no_files_found: "ignore"
          artifacts_retention_days: ${{ inputs.retention_days }}

  # ============================================================================
  # PR FEEDBACK — FAILURE COMMENT (OPTIONAL)
  # ----------------------------------------------------------------------------
  # Purpose:
  #   Post a structured failure summary to the PR.
  #
  # Blocking:
  #   No (best-effort, continue-on-error)
  # ============================================================================
  notify:
    name: PR failure comment
    runs-on: ${{ inputs.runner }}
    needs:
      [validate-ci, lint, typecheck, test, jscpd, evasion-scan, build, sonar]
    if: >-
      ${{ failure() &&
      inputs.pr_number != '' &&
      inputs.pr_is_fork != 'true' &&
      inputs.allow_pr_comments == '1' }}
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write  # Justification: post PR failure summary comment
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          node_version: ${{ inputs.node_version }}
          cache: ${{ inputs.cache }}
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}

      - name: Post failure summary (PR)
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        continue-on-error: true
        with:
          pr_number: ${{ inputs.pr_number }}
          github_token: ${{ github.token }}
          expected_base_sha: ${{ inputs.pr_base_ref }}
          expected_head_sha: ${{ inputs.pr_head_ref }}
          pr_comment_body: |
            ❌ PR Gates failed.

            Results:
            - Validate-CI: ${{ needs.validate-ci.result }}
            - Lint: ${{ needs.lint.result }}
            - Typecheck: ${{ needs.typecheck.result }}
            - Tests: ${{ needs.test.result }}
            - JSCPD: ${{ needs.jscpd.result }}
            - Build: ${{ needs.build.result }}
            - Sonar (baseline): ${{ needs.sonar.result }}

            Check the workflow run for detailed logs and artifacts.

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: pr-gates
          summary_output_path: reports/summary/pr-gates-notify.json
          summary_results: notify=${{ job.status }}
          artifacts_name: pr-gates-notify
          artifacts_paths: |
            reports/**
          artifacts_if_no_files_found: "ignore"
          artifacts_retention_days: ${{ inputs.retention_days }}

  # ============================================================================
  # AGGREGATION & REPORTING — PR GATES SUMMARY
  # ----------------------------------------------------------------------------
  # Purpose:
  #   Produce a machine-readable summary of workflow outcomes.
  #
  # Blocking:
  #   No (always runs)
  # ============================================================================
  summary:
    name: PR gates summary
    runs-on: ${{ inputs.runner }}
    needs:
      - validate-ci
      - lint
      - typecheck
      - test
      - jscpd
      - evasion-scan
      - build
      - sonar
      - notify
    if: ${{ always() }}
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          node_version: ${{ inputs.node_version }}
          cache: ${{ inputs.cache }}
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: pr-gates
          summary_output_path: reports/summary/pr-gates.json
          summary_results: |
            validate-ci=${{ needs.validate-ci.result }}
            lint=${{ needs.lint.result }}
            typecheck=${{ needs.typecheck.result }}
            test=${{ needs.test.result }}
            jscpd=${{ needs.jscpd.result }}
            build=${{ needs.build.result }}
            sonar=${{ needs.sonar.result }}
            notify=${{ needs.notify.result }}
          artifacts_name: pr-gates-summary
          artifacts_paths: |
            reports/**
            logs/**
            reports/summary/pr-gates.json
          artifacts_if_no_files_found: "ignore"
          artifacts_retention_days: ${{ inputs.retention_days }}
