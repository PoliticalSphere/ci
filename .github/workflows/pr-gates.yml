# ==============================================================================
# Political Sphere — Reusable Workflow: PR Gates
# ==============================================================================
#
# PURPOSE
# ------------------------------------------------------------------------------
# Provide fast, deterministic, policy-aligned validation for pull requests.
# This workflow enforces repository standards, code quality, security hygiene,
# and build correctness before changes are eligible for merge.
#
#
# SCOPE & RESPONSIBILITIES
# ------------------------------------------------------------------------------
# DOES:
#   - Enforce CI policy compliance (Validate-CI)
#   - Run PR-scoped quality gates:
#       • Lint
#       • Typecheck
#       • Tests
#       • Duplication (JSCPD)
#       • Build verification
#   - Perform security checks:
#       • Fast secrets scan
#       • Dependency review (PR-aware)
#   - Collect non-blocking quality signals (SonarCloud baseline)
#   - Publish structured artifacts and a machine-readable summary
#
# DOES NOT:
#   - Perform deep security scanning (e.g. SAST/DAST, infra scans)
#   - Deploy artifacts or publish packages
#   - Perform releases or environment mutations
#
#
# DESIGN PRINCIPLES
# ------------------------------------------------------------------------------
# - Deterministic, non-interactive execution
# - Least privilege (explicit, minimal permissions)
# - SHA-pinned external actions only
# - Explicit separation of:
#     • Policy enforcement
#     • Quality gates
#     • Security gates
#     • Non-blocking signals
#     • Human feedback
#     • Machine-readable reporting
# - Validate-CI MUST succeed before any other job executes
# - Artifacts are uploaded best-effort, even on failure
#
#
# EXECUTION MODEL
# ------------------------------------------------------------------------------
# - Triggered via workflow_call
# - Consumer-facing reusable workflow
# - Intended to be invoked by pull_request workflows
#
#
# SECURITY & POLICY NOTES
# ------------------------------------------------------------------------------
# - Secrets are optional and passed explicitly
# - Default permissions are read-only
# - Write permissions are scoped to:
#     • PR comments (optional, non-fork PRs only)
# - No credentials are persisted
#
#
# OPERATIONAL NOTES
# ------------------------------------------------------------------------------
# - Timeouts are defined per job
# - Artifact retention is configurable by the caller
# - PS_FULL_SCAN=1 enforces stricter downstream behaviour
# - Summary output is always produced
#
# ==============================================================================

name: PR Gates

# ==============================================================================
# TRIGGER & INVOCATION MODEL
# ------------------------------------------------------------------------------
# Reusable workflow invoked via workflow_call
# ==============================================================================
"on":
  workflow_call:

    # ==========================================================================
    # RUNTIME & ENVIRONMENT CONFIGURATION
    # --------------------------------------------------------------------------
    # Controls runner selection, Node version, checkout depth, and caching.
    # ==========================================================================
    inputs:
      runner:
        description: "Runner label"
        type: string
        required: false
        default: "ubuntu-22.04"

      node_version:
        description: "Node.js major version"
        type: string
        required: false
        default: "22"

      fetch_depth:
        description: "Git fetch depth (1 = shallow, 0 = full history)"
        type: number
        required: false
        default: 1

      cache:
        description: "Enable dependency caching (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

      # ==========================================================================
      # PLATFORM & SHARED TOOLING
      # --------------------------------------------------------------------------
      # Defines which version of the Political Sphere CI platform is used.
      # ==========================================================================
      platform_ref:
        description: "Platform repository ref for shared scripts/configs"
        type: string
        required: false
        default: "main"

      # ==========================================================================
      # ARTIFACT COLLECTION & RETENTION
      # --------------------------------------------------------------------------
      # Controls which files are preserved and for how long.
      # ==========================================================================
      retention_days:
        description: "Artifact retention in days"
        type: number
        required: false
        default: 7

      artifact_paths:
        description: "General artifact paths"
        type: string
        required: false
        default: |
          reports/**
          logs/**

      coverage_paths:
        description: "Coverage and test report artifacts"
        type: string
        required: false
        default: |
          coverage/**
          playwright-report/**
          test-results/**
          reports/coverage/**

      test_results_paths:
        description: "JUnit/XML test result artifacts"
        type: string
        required: false
        default: |
          reports/**/junit*.xml
          reports/**/junit.xml
          test-results/**/*.xml

      # ==========================================================================
      # VALIDATION BEHAVIOUR
      # --------------------------------------------------------------------------
      ps_full_scan:
        description: "Enable strict/full scan behaviour"
        type: string
        required: false
        default: "1"

      # ==========================================================================
      # PULL REQUEST CONTEXT
      # --------------------------------------------------------------------------
      pr_number:
        description: "Pull request number (for comments & PR-scoped checks)"
        type: string
        required: false
        default: ""

      pr_is_fork:
        description: "Whether the PR originates from a fork"
        type: string
        required: false
        default: "false"

      allow_pr_comments:
        description: "Allow PR failure comments (1 = on, 0 = off)"
        type: string
        required: false
        default: "0"

      pr_base_ref:
        description: "PR base ref or SHA"
        type: string
        required: false
        default: ""

      pr_head_ref:
        description: "PR head ref or SHA"
        type: string
        required: false
        default: ""

    # ==========================================================================
    # SECRETS (OPTIONAL, LEAST-PRIVILEGE)
    # ==========================================================================
    secrets:
      NODE_AUTH_TOKEN:
        description: "Private registry token (optional)"
        required: false

      SONAR_TOKEN:
        description: "SonarCloud token"
        required: false

      SONAR_ORGANIZATION:
        description: "SonarCloud organisation key"
        required: false

      SONAR_PROJECT_KEY:
        description: "SonarCloud project key"
        required: false

# ==============================================================================
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ==============================================================================
permissions:
  contents: read

# ==============================================================================
# CONCURRENCY CONTROL
# ------------------------------------------------------------------------------
# Ensures a single PR Gates run per PR/ref.
# ==============================================================================
concurrency:
  group: pr-gates-${{ github.repository }}-${{ inputs.pr_number != '' && inputs.pr_number || github.ref }}
  cancel-in-progress: true

# ==============================================================================
# GLOBAL EXECUTION DEFAULTS
# ==============================================================================
defaults:
  run:
    shell: bash

# ==============================================================================
# GLOBAL ENVIRONMENT
# ==============================================================================
env:
  CI: "1"
  PS_FULL_SCAN: ${{ inputs.ps_full_scan }}
  PS_PLATFORM_ROOT: ${{ github.workspace }}/.ps-platform
