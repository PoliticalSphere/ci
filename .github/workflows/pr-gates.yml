# ==============================================================================
# Political Sphere â€” PR Gates (Caller)
# ==============================================================================
#
# METADATA
# ------------------------------------------------------------------------------
# id: pr-gates
# version: 1.0.0
# owner: political-sphere
# classification: internal
#
# PURPOSE
# ------------------------------------------------------------------------------
# Caller workflow that delegates to _reusable-pr-gates.yml for fast,
# policy-aligned pull request validation.
#
#
# SCOPE & RESPONSIBILITIES
# ------------------------------------------------------------------------------
# DOES:
#   - Invoke _reusable-pr-gates.yml with caller inputs
#   - Pass through gate configuration
#
# DOES NOT:
#   - Perform gate validation directly
#   - Modify repository state
#
#
# DEPENDENCIES
# ------------------------------------------------------------------------------
# - ./.github/workflows/_reusable-pr-gates.yml
#
#
# EXECUTION MODEL
# ------------------------------------------------------------------------------
# - Trigger: workflow_call (internal reusable)
# - Single job: delegates to _reusable-pr-gates.yml
#
#
# SECURITY & POLICY NOTES
# ------------------------------------------------------------------------------
# - Permissions: minimal (contents: read)
# - Platform ref must be SHA-pinned for supply chain security
#
# ==============================================================================

name: PR Gates

on:
  workflow_call:
    
    # ==========================================================================
    # RUNTIME & ENVIRONMENT CONFIGURATION
    # ==========================================================================
    inputs:
      runner:
        description: "Runner label"
        type: string
        required: false
        default: "ubuntu-22.04"

      node_version:
        description: "Node.js major version"
        type: string
        required: false
        default: "22"

      fetch_depth:
        description: "Git fetch depth (1 = shallow, 0 = full history)"
        type: number
        required: false
        default: 1

      cache:
        description: "Enable dependency caching (1 = on, 0 = off)"
        type: string
        required: false
        default: "1"

      # ==========================================================================
      # PLATFORM & SHARED TOOLING
      # ==========================================================================
      platform_ref:
        description: "Platform repository ref for shared scripts/configs"
        type: string
        required: false
        default: "f6eac5049f626a672c84f3899f0572a87af07ca1"

      platform_require_pinned_ref:
        description: "Require platform_ref to be a full 40-char commit SHA (true|false)"
        type: string
        required: false
        default: "true"

      # ==========================================================================
      # ARTIFACT COLLECTION & RETENTION
      # ==========================================================================
      artifact_paths:
        description: "Artifact paths to upload"
        type: string
        required: false
        default: |
          reports/**
          logs/**

      coverage_paths:
        description: "Coverage/report paths to upload"
        type: string
        required: false
        default: |
          coverage/**
          playwright-report/**
          test-results/**
          reports/coverage/**

      test_results_paths:
        description: "JUnit / XML test result paths to upload"
        type: string
        required: false
        default: |
          reports/**/junit*.xml
          reports/**/junit.xml
          test-results/**/*.xml

      retention_days:
        description: "Artifact retention in days"
        type: number
        required: false
        default: 7

      # ==========================================================================
      # VALIDATION BEHAVIOUR
      # ==========================================================================
      ps_full_scan:
        description: "Enable strict/full scan behaviour for downstream gates"
        type: string
        required: false
        default: "1"

      # ==========================================================================
      # PULL REQUEST CONTEXT
      # ==========================================================================
      pr_number:
        description: "Pull request number (enables dependency review + PR comments)"
        type: string
        required: false
        default: ""

      pr_is_fork:
        description: "Whether the PR originates from a fork (true/false)"
        type: string
        required: false
        default: "false"

      allow_pr_comments:
        description: "Allow PR failure comments (1 = on, 0 = off)"
        type: string
        required: false
        default: "0"

      pr_base_ref:
        description: "PR base SHA (diff-based checks, dependency review)"
        type: string
        required: false
        default: ""

      pr_head_ref:
        description: "PR head SHA (diff-based checks, dependency review)"
        type: string
        required: false
        default: ""

    # ==========================================================================
    # SECRETS (OPTIONAL, LEAST-PRIVILEGE)
    # ==========================================================================
    secrets:
      NODE_AUTH_TOKEN:
        description: "Optional token for private registry installs"
        required: false
      SONAR_TOKEN:
        description: "SonarCloud token"
        required: false
      SONAR_ORGANIZATION:
        description: "SonarCloud organization key"
        required: false
      SONAR_PROJECT_KEY:
        description: "SonarCloud project key"
        required: false

# ==============================================================================
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ==============================================================================
permissions:
  contents: read  # Justification: required for repository checkout only
  actions: read   # Justification: inspect workflow runs for CI validation
  pull-requests: read  # Justification: read PR context (number, labels, etc.)

jobs:
  call:
    name: PR Gates
    uses: ./.github/workflows/_reusable-pr-gates.yml
    # -------------------------------------------------------------------------
    # Justification: pull-requests: write required to post PR status comments
    # and add labels. Risk decision: docs/risk-decisions.md#rd-pr-comments
    # -------------------------------------------------------------------------
    permissions:
      contents: read
      pull-requests: write  # Justification: post PR status comments
    with:
      runner: ${{ inputs.runner }}
      node_version: ${{ inputs.node_version }}
      fetch_depth: ${{ inputs.fetch_depth }}
      cache: ${{ inputs.cache }}
      platform_ref: ${{ inputs.platform_ref }}
      platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}
      artifact_paths: ${{ inputs.artifact_paths }}
      coverage_paths: ${{ inputs.coverage_paths }}
      test_results_paths: ${{ inputs.test_results_paths }}
      retention_days: ${{ inputs.retention_days }}
      ps_full_scan: ${{ inputs.ps_full_scan }}
      pr_number: ${{ inputs.pr_number }}
      pr_is_fork: ${{ inputs.pr_is_fork }}
      allow_pr_comments: ${{ inputs.allow_pr_comments }}
      pr_base_ref: ${{ inputs.pr_base_ref }}
      pr_head_ref: ${{ inputs.pr_head_ref }}
    secrets:
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
      SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
