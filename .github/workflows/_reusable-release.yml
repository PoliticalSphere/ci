# ══════════════════════════════════════════════════════════════════════════════
# Release — Git tag and GitHub Release creation
# ══════════════════════════════════════════════════════════════════════════════
#
# Creates SemVer tags and GitHub Releases with dry-run mode support.
# Validates policy first, uploads evidence, and verifies tag accuracy.
#
# Docs: .github/workflows/README.md#release
# Refs: docs/versioning.md, docs/risk-decisions.md#rd-release-permissions
#
# Risks:
#   • Accidental releases cannot be undone (use dry_run for validation)
#   • Release permissions require contents: write (scope carefully)
#   • Tag conflicts if manual tags exist
#
# ══════════════════════════════════════════════════════════════════════════════

name: Release

on:
  workflow_call:

    # ==========================================================================
    # RUNTIME & ENVIRONMENT CONFIGURATION
    # ==========================================================================
    inputs:
      runner:
        description: "Runner label"
        required: false
        default: "ubuntu-22.04"
        type: string

      node_version:
        description: "Node.js major version"
        required: false
        default: "22"
        type: string

      fetch_depth:
        description: "Git fetch depth for checkout (1 = shallow, 0 = full history)"
        required: false
        default: 0
        type: number

      retention_days:
        description: "Artifact retention in days for release evidence"
        required: false
        default: 7
        type: number

      # ==========================================================================
      # RELEASE MODE
      # ==========================================================================
      dry_run:
        description: "If true, validate + plan only (no tag/release mutation)"
        required: false
        default: false
        type: boolean

      # ==========================================================================
      # RELEASE CONFIGURATION
      # ==========================================================================
      release_version:
        description: "Release version (SemVer, without leading v)"
        required: true
        type: string

      release_ref:
        description: "Git ref to release from (branch name or full SHA)"
        required: true
        type: string

      # ==========================================================================
      # RELEASE NOTES
      # --------------------------------------------------------------------------
      # Precedence:
      #   1) release_notes (inline)
      #   2) release_notes_path (file in repo at release_ref)
      #   3) generate_notes=true (GitHub auto-generation)
      #   4) else: empty body
      # ==========================================================================
      generate_notes:
        description: "Auto-generate GitHub release notes (if no custom notes provided)"
        required: false
        default: true
        type: boolean

      release_title:
        description: "Optional release title (defaults to v<release_version>)"
        required: false
        default: ""
        type: string

      release_notes:
        description: "Optional inline release notes (overrides generate_notes)"
        required: false
        default: ""
        type: string

      release_notes_path:
        description: "Optional repo-relative path to release notes file (overrides generate_notes)"
        required: false
        default: ""
        type: string

      # ==========================================================================
      # PLATFORM CONFIGURATION
      # ==========================================================================
      platform_ref:
        description: "Platform repo ref to checkout for shared scripts/configs"
        type: string
        required: false
        default: "f6eac5049f626a672c84f3899f0572a87af07ca1"

      platform_require_pinned_ref:
        description: "Require platform_ref to be a full 40-char commit SHA (true|false)"
        type: string
        required: false
        default: "true"

# ==============================================================================
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ==============================================================================
permissions:
  contents: read

# ==============================================================================
# GLOBAL EXECUTION DEFAULTS
# ==============================================================================
defaults:
  run:
    shell: bash

# ==============================================================================
# CONCURRENCY CONTROL
# ------------------------------------------------------------------------------
# One release per version at a time. Do not cancel in progress: releases are
# stateful operations (tag + release publish) and should not be interrupted.
# ==============================================================================
concurrency:
  group: release-${{ github.repository }}-${{ inputs.release_version }}
  cancel-in-progress: false

# ==============================================================================
# GLOBAL ENVIRONMENT
# ==============================================================================
env:
  CI: "1"
  PS_PLATFORM_ROOT: ${{ github.workspace }}/.ps-platform

jobs:
  # ============================================================================
  # POLICY GATE — VALIDATE CI
  # ============================================================================
  validate-ci:
    name: Validate CI (policy gate)
    uses: ./.github/workflows/validate-ci.yml
    permissions:
      contents: read
    with:
      runner: ${{ inputs.runner }}
      node_version: ${{ inputs.node_version }}
      fetch_depth: ${{ inputs.fetch_depth }}
      checkout_ref: ${{ inputs.release_ref }}
      platform_ref: ${{ inputs.platform_ref }}
      artifact_name: release-validate-ci
      retention_days: ${{ inputs.retention_days }}

  # ============================================================================
  # DRY-RUN — PLAN & VALIDATE RELEASE (NO MUTATION)
  # ----------------------------------------------------------------------------
  # Purpose:
  #   Validate inputs and compute a release plan without creating tags/releases.
  #
  # Blocking:
  #   Yes (when dry_run=true)
  # ============================================================================
  dry-run:
    name: Dry-run (plan only)
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    if: ${{ inputs.dry_run == true }}
    timeout-minutes: 15
    permissions:
      contents: read
    env:
      PS_DRY_RUN: "1"
      PS_RELEASE_VERSION: ${{ inputs.release_version }}
      PS_RELEASE_REF: ${{ inputs.release_ref }}
      PS_RELEASE_TITLE: ${{ inputs.release_title }}
      PS_GENERATE_NOTES: ${{ inputs.generate_notes }}
      PS_RELEASE_NOTES_INLINE: ${{ inputs.release_notes }}
      PS_RELEASE_NOTES_PATH: ${{ inputs.release_notes_path }}
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          checkout_ref: ${{ inputs.release_ref }}
          node_version: ${{ inputs.node_version }}
          cache: "0"
          install_dependencies: "0"
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}

      - name: Compute release plan (no mutation)
        uses: ./.github/actions/ps-task/ps-run
        with:
          id: compute-release-plan
          title: Compute release plan (no mutation)
          script: tools/scripts/workflows/release/compute-plan.sh

      - name: Upload artifacts (dry-run evidence) (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          artifacts_name: release-dry-run
          artifacts_paths: |
            reports/**
            logs/**
          artifacts_if_no_files_found: "warn"
          artifacts_retention_days: ${{ inputs.retention_days }}

  # ============================================================================
  # RELEASE PUBLISHING — TAG + GITHUB RELEASE
  # ============================================================================
  release:
    name: Publish release
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    if: ${{ inputs.dry_run == false }}
    timeout-minutes: 20
    permissions:
      contents: write  # Justification: tag + release creation requires write access  # justification: tag + release creation requires contents write
    env:
      GH_TOKEN: ${{ github.token }}
      PS_DRY_RUN: "0"
      PS_RELEASE_VERSION: ${{ inputs.release_version }}
      PS_RELEASE_REF: ${{ inputs.release_ref }}
      PS_RELEASE_TITLE: ${{ inputs.release_title }}
      PS_GENERATE_NOTES: ${{ inputs.generate_notes }}
      PS_RELEASE_NOTES_INLINE: ${{ inputs.release_notes }}
      PS_RELEASE_NOTES_PATH: ${{ inputs.release_notes_path }}
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: ${{ inputs.fetch_depth }}
          checkout_ref: ${{ inputs.release_ref }}
          node_version: ${{ inputs.node_version }}
          cache: "0"
          install_dependencies: "0"
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}

      - name: Validate release inputs (publish)
        uses: ./.github/actions/ps-task/ps-run
        with:
          id: validate-release-inputs
          title: Validate release inputs (publish)
          script: tools/scripts/workflows/release/validate-release-inputs.sh

      - name: Prepare release notes mode
        id: notes
        uses: ./.github/actions/ps-task/ps-run
        with:
          id: prepare-release
          title: Prepare release notes mode
          script: tools/scripts/workflows/release/prepare-release.sh

      - name: Publish release (PS)
        uses: ./.github/actions/ps-task/ps-run
        with:
          id: "release.publish"
          title: "Publish release"
          description: "Tag and create GitHub Release"
          script: "tools/scripts/workflows/release/release.sh"

      # ------------------------------------------------------------------------
      # SBOM GENERATION (Supply Chain Transparency)
      # ------------------------------------------------------------------------
      - name: Generate SBOM (PS)
        uses: ./.github/actions/ps-task/ps-run
        with:
          id: "release.sbom"
          title: "Generate SBOM"
          description: "Create CycloneDX and SPDX SBOMs for supply chain transparency"
          script: "tools/scripts/workflows/release/generate-sbom.sh"
        continue-on-error: true
        env:
          CI: "1"

      - name: Upload SBOM as artifact
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: release-sbom
          path: reports/sbom/**
          retention-days: 90  # Keep SBOM longer for supply chain audits
          if-no-files-found: warn
        continue-on-error: true

      # ------------------------------------------------------------------------
      # RELEASE VERIFICATION (DETERMINISTIC)
      # ------------------------------------------------------------------------
      - name: Verify tag + release match intended ref
        uses: ./.github/actions/ps-task/ps-run
        with:
          id: verify-release
          title: Verify tag + release
          script: tools/scripts/workflows/release/verify-release.sh
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Release complete
        if: always()
        uses: ./.github/actions/ps-task/ps-run
        with:
          id: release-complete
          title: Release complete
          script: tools/scripts/workflows/release/release-complete.sh

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: release
          summary_output_path: reports/summary/release.json
          summary_results: release=${{ job.status }}
          artifacts_name: release-artifacts
          artifacts_paths: |
            reports/**
            logs/**
          artifacts_if_no_files_found: "warn"
          artifacts_retention_days: ${{ inputs.retention_days }}

  # ============================================================================
  # AGGREGATION & REPORTING — RELEASE SUMMARY
  # ============================================================================
  summary:
    name: Release summary
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci, dry-run, release]
    if: ${{ always() }}
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - name: Bootstrap (PS)
        uses: ./.github/actions/ps-bootstrap/ps-setup-standard
        with:
          fetch_depth: 1
          checkout_ref: ${{ inputs.release_ref }}
          node_version: ${{ inputs.node_version }}
          cache: "0"
          install_dependencies: "0"
          platform_ref: ${{ inputs.platform_ref }}
          platform_require_pinned_ref: ${{ inputs.platform_require_pinned_ref }}

      - name: Job teardown (PS)
        if: always()
        uses: ./.github/actions/ps-teardown/ps-finalize-workflow
        with:
          summary_workflow: release
          summary_output_path: reports/summary/release.json
          summary_results: |
            validate-ci=${{ needs.validate-ci.result }}
            dry-run=${{ needs.dry-run.result }}
            release=${{ needs.release.result }}
          artifacts_name: release-summary
          artifacts_paths: |
            reports/**
            logs/**
            reports/summary/release.json
          artifacts_if_no_files_found: "warn"
          artifacts_retention_days: ${{ inputs.retention_days }}
