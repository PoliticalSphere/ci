# ══════════════════════════════════════════════════════════════════════════════
# PR Checks — Orchestrator for PR Gates + License Compliance
# ══════════════════════════════════════════════════════════════════════════════
#
# Invokes PR Gates and License Compliance workflows with PR context.
# License compliance always runs (even if PR Gates fails) for full evidence.
#
# Docs: .github/workflows/README.md#pr-checks
# Refs: docs/risk-decisions.md#rd-pr-comments
#
# Risks:
#   • Fork PRs have comments disabled (security)
#   • Secrets are not inherited (explicit pass-through only)
#
# ══════════════════════════════════════════════════════════════════════════════

name: PR Checks

on:
  workflow_call:
    inputs:
      runner:
        description: "Runner label"
        type: string
        required: false
        default: "ubuntu-22.04"
      node_version:
        description: "Node.js major version"
        type: string
        required: false
        default: "22"
      fetch_depth:
        description: "Git fetch depth (1 = shallow, 0 = full history)"
        type: number
        required: false
        default: 1
      pr_number:
        description: "Pull request number"
        type: string
        required: false
        default: ""
      pr_is_fork:
        description: "Whether the PR originates from a fork (true/false)"
        type: string
        required: false
        default: "false"
      allow_pr_comments:
        description: "Allow PR failure comments (1 = on, 0 = off)"
        type: string
        required: false
        default: "0"
      pr_base_ref:
        description: "PR base SHA"
        type: string
        required: false
        default: ""
      pr_head_ref:
        description: "PR head SHA"
        type: string
        required: false
        default: ""

# ══════════════════════════════════════════════════════════════════════════════
# DEFAULT PERMISSIONS (LEAST PRIVILEGE)
# ══════════════════════════════════════════════════════════════════════════════
permissions:
  contents: read

# ══════════════════════════════════════════════════════════════════════════════
# GLOBAL EXECUTION DEFAULTS
# ══════════════════════════════════════════════════════════════════════════════
defaults:
  run:
    shell: bash

# ══════════════════════════════════════════════════════════════════════════════
# CONCURRENCY CONTROL
# ══════════════════════════════════════════════════════════════════════════════
concurrency:
  group: >-
    pr-checks-${{ github.repository }}-${{
    inputs.pr_number != '' && inputs.pr_number || github.ref }}
  cancel-in-progress: true

jobs:
  # ────────────────────────────────────────────────────────────────────────────
  # PR Gates — Run full PR gate suite (Validate-CI, lint, typecheck, tests)
  # ────────────────────────────────────────────────────────────────────────────
  pr-gates:
    name: PR Gates
    uses: ./.github/workflows/pr-gates.yml
    with:
      pr_number: ${{ inputs.pr_number }}
      pr_is_fork: ${{ inputs.pr_is_fork }}
      pr_base_ref: ${{ inputs.pr_base_ref }}
      pr_head_ref: ${{ inputs.pr_head_ref }}
      node_version: ${{ inputs.node_version }}
      allow_pr_comments: ${{ inputs.allow_pr_comments }}
    permissions:
      contents: read
      pull-requests: write

  # ────────────────────────────────────────────────────────────────────────────
  # License Compliance — Enforce OSS license policy (runs even if Gates fail)
  # ────────────────────────────────────────────────────────────────────────────
  license-compliance:
    name: License Compliance
    uses: ./.github/workflows/license-compliance.yml
    if: ${{ always() }}
    permissions:
      contents: read
    with:
      runner: ${{ inputs.runner }}
      node_version: ${{ inputs.node_version }}
      fetch_depth: ${{ inputs.fetch_depth }}
