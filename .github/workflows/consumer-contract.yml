# ==============================================================================
# Political Sphere - Reusable Workflow: Consumer Contract
# ------------------------------------------------------------------------------
# Purpose:
#   Validate consumer repositories against the platform contract policy.
#
# Metadata:
#   - Created: 2025-12-20
#   - Last updated: 2025-12-20
#
# Scope & Responsibilities:
#   - Does: enforce contract checks and publish reports/logs artifacts.
#   - Does NOT: deploy, release, or modify repository state.
#
# Design Principles:
#   - Deterministic and non-interactive execution
#   - Least privilege with explicit permissions
#   - SHA-pinned actions only
#   - Validate-CI gate runs first
#
# Dependencies:
#   - ./.github/workflows/validate-ci.yml
#   - ./.github/actions/ps-hardened-checkout
#   - ./.github/actions/ps-node-bootstrap
#   - ./.github/actions/consumer-contract
#   - ./.github/actions/ps-upload-artifacts
#   - ./.github/actions/ps-write-summary
#
# Dependents:
#   - Downstream PS application repositories
#
# Execution Model:
#   - Trigger: workflow_call (consumer-facing)
#   - Reusable workflow (consumer-facing)
#
# Security & Policy Notes:
#   - Secrets: optional NODE_AUTH_TOKEN for private registry access
#   - Permissions: contents: read
#   - Constraints: no deployments; no token writes
#
# Operational Notes:
#   - Timeouts: defined per job in this workflow
#   - Artifacts: reports/** and logs/** uploaded per policy
#   - CI vs local: contract checks are file-based and network-free
#   - Node runtime: setup-node only; npm ci is intentionally skipped
# ==============================================================================

name: Consumer Contract

on:
  workflow_call:
    inputs:
      runner:
        description: "Runner label"
        type: string
        required: false
        default: "ubuntu-22.04"

      node_version:
        description: "Node.js major version"
        type: string
        required: false
        default: "22"

      fetch_depth:
        description: "Git fetch depth for checkout (1 = shallow, 0 = full history)"
        type: string
        required: false
        default: "1"

      cache:
        description: "Enable Node dependency caching (1 = on, 0 = off)"
        type: string
        required: false
        default: "0"

      policy_path:
        description: "Contract policy path (repo-relative)"
        type: string
        required: false
        default: "configs/consumer/contract.json"

      exceptions_path:
        description: "Exceptions policy path (repo-relative)"
        type: string
        required: false
        default: "configs/consumer/exceptions.json"

      report_path:
        description: "Contract report path (repo-relative)"
        type: string
        required: false
        default: "reports/contracts/contract.json"

      summary_path:
        description: "Contract summary path (repo-relative)"
        type: string
        required: false
        default: "reports/contracts/contract.txt"

      log_dir:
        description: "Log output directory (repo-relative)"
        type: string
        required: false
        default: "logs/contracts"

      retention_days:
        description: "Artifact retention in days"
        type: number
        required: false
        default: 7

    secrets:
      NODE_AUTH_TOKEN:
        description: "Optional token for private registry installs"
        required: false

concurrency:
  group: consumer-contract-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  validate-ci:
    name: Validate CI (policy gate)
    uses: ./.github/workflows/validate-ci.yml
    permissions:
      contents: read
    with:
      runner: ${{ inputs.runner }}
      node_version: ${{ inputs.node_version }}
      artifact_name: consumer-contract-validate-ci
      retention_days: ${{ inputs.retention_days }}
    secrets:
      NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

  contract:
    name: Consumer contract
    runs-on: ${{ inputs.runner }}
    needs: [validate-ci]
    permissions:
      contents: read
    timeout-minutes: 15
    steps:
      - name: Hardened checkout (PS)
        uses: ./.github/actions/ps-hardened-checkout
        with:
          fetch_depth: ${{ inputs.fetch_depth }}

      - name: Node runtime (PS)
        uses: ./.github/actions/ps-node-bootstrap
        with:
          node_version: ${{ inputs.node_version }}
          cache: ${{ inputs.cache }}
          install_dependencies: "0"

      - name: Contract check
        uses: ./.github/actions/consumer-contract
        with:
          policy_path: ${{ inputs.policy_path }}
          exceptions_path: ${{ inputs.exceptions_path }}
          report_path: ${{ inputs.report_path }}
          summary_path: ${{ inputs.summary_path }}
          log_dir: ${{ inputs.log_dir }}

      - name: Write summary
        if: always()
        uses: ./.github/actions/ps-write-summary
        with:
          workflow: "consumer-contract"
          output_path: "reports/summary/consumer-contract.json"
          results: |
            contract=${{ job.status == 'success' && 'success' || 'failure' }}

      - name: Upload report artifacts
        if: always()
        uses: ./.github/actions/ps-upload-artifacts
        with:
          name: consumer-contract-report
          path: |
            reports/**
            logs/**
          if_no_files_found: "warn"
          retention_days: ${{ inputs.retention_days }}

      - name: Upload summary artifact
        if: always()
        uses: ./.github/actions/ps-upload-artifacts
        with:
          name: consumer-contract-summary
          path: reports/summary/consumer-contract.json
          if_no_files_found: "warn"
          retention_days: ${{ inputs.retention_days }}
